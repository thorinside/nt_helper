# Story 1.5: Assign Parameters to Performance Pages via Property Editor

## Status

Done

## Story

**As a** musician configuring my performance setup,
**I want** to assign algorithm parameters to specific performance pages (1-15) through the property editor,
**so that** I can organize parameters into pages that I can quickly access during live performance

## Acceptance Criteria

1. Regular parameter list in property editor shows performance page selector for each parameter
2. Selector displays options: "Not Assigned" (0), "Page 1" (1) through "Page 15" (15)
3. Current performance page assignment is displayed (reads from `perfPageIndex` in mapping data)
4. Selecting a page calls `DistingCubit.setPerformancePageMapping(slotIndex, paramIndex, pageIndex)`
5. Uses SysEx 0x54 handler (from Story 1.2) to send assignment to hardware
6. Parameter immediately appears in Performance Parameters section (Story 1.4) when assigned (perfPageIndex > 0)
7. Parameter immediately disappears from Performance Parameters section when set to "Not Assigned" (perfPageIndex = 0)
8. Selector UI follows existing property editor patterns and theme
9. All three operation modes work correctly (connected sends SysEx, demo/offline silently ignore)
10. `flutter analyze` passes with zero warnings
11. Existing parameter editing functionality remains unchanged

## Tasks / Subtasks

- [x] Locate parameter display in property editor (AC: 1, 8)
  - [x] Find where individual parameters are rendered in `lib/ui/widgets/section_parameter_list_view.dart`
  - [x] Understand existing parameter row layout
  - [x] Identify where to add performance page selector

- [x] Design performance page selector UI (AC: 1, 2, 8)
  - [x] Use Flutter `DropdownButton` widget for page selection
  - [x] Create list of options: "Not Assigned" (value 0), "Page 1" (value 1) through "Page 15" (value 15)
  - [x] Style dropdown to match existing property editor theme
  - [x] Position selector in parameter row (likely at end or below parameter control)
  - [x] Make selector compact to avoid cluttering parameter list

- [x] Read current performance page assignment (AC: 3)
  - [x] Access `PackedMappingData` for parameter via DistingCubit
  - [x] Read `perfPageIndex` field (0-15)
  - [x] Display current value in dropdown selector
  - [x] Handle edge case: perfPageIndex = 0 shows "Not Assigned"

- [x] Implement page assignment handler (AC: 4, 5)
  - [x] Create `onPageSelected(int newPageIndex)` callback
  - [x] Call `context.read<DistingCubit>().setPerformancePageMapping(slotIndex, paramIndex, newPageIndex)`
  - [x] Method already exists from Story 1.4 - reuse it
  - [x] SysEx 0x54 handler sends assignment to hardware (Story 1.2)

- [x] Add visual feedback for assignment (AC: 6, 7)
  - [x] Show SnackBar confirmation when parameter assigned to page
  - [x] Show SnackBar confirmation when parameter removed from page
  - [x] Message examples: "Assigned to Page 3", "Removed from performance pages"
  - [x] Optional: Highlight parameter row briefly after assignment

- [x] Test dynamic behavior (AC: 6, 7)
  - [x] Assign parameter (perfPageIndex = 0 → 3) and verify it appears in Performance Parameters section
  - [x] Remove parameter (perfPageIndex = 3 → 0) and verify it disappears from Performance Parameters section
  - [x] Verify Performance page (Story 1.3) updates dynamically when pages populated/cleared
  - [x] Test changing from one page to another (perfPageIndex = 3 → 5)

- [x] Test all operation modes (AC: 9)
  - [x] Test connected mode: Assignment sent via SysEx 0x54, hardware updated
  - [x] Test demo mode: Assignment silently ignored (no-op from Story 1.2)
  - [x] Test offline mode: Assignment silently ignored (no-op from Story 1.2)
  - [x] Verify no exceptions in any mode

- [x] Verify no regressions (AC: 11)
  - [x] Test existing parameter value editing still works
  - [x] Test existing CV/MIDI/I2C mapping functionality unchanged
  - [x] Test Performance Parameters section (Story 1.4) still works
  - [x] Test Performance page side-nav (Story 1.3) still works
  - [x] Run full test suite

- [x] Run flutter analyze (AC: 10)
  - [x] Run `flutter analyze` and ensure zero warnings
  - [x] Fix any linter issues immediately

## Dev Notes

### Previous Story Context

[Source: Story 1.4 Implementation]

**Performance Parameters Section Location:**
- Implemented in `lib/ui/widgets/section_parameter_list_view.dart`
- Method `_buildPerformanceParametersSection()` displays parameters where perfPageIndex > 0
- Uses `_getPerformanceParameterIndices()` to filter performance parameters
- Remove button calls `DistingCubit.setPerformancePageMapping(slot, param, 0)`

**DistingCubit Method:**
- `Future<void> setPerformancePageMapping(int slotIndex, int parameterNumber, int perfPageIndex)` added in Story 1.4
- Located in `lib/cubit/disting_cubit.dart` around line 1870
- Delegates to `IDistingMidiManager.setPerformancePageMapping()`
- Already handles all three operation modes (connected/demo/offline)

**SysEx 0x54 Handler:**
- Implemented in Story 1.2
- Request class: `lib/domain/sysex/requests/set_performance_page_message.dart`
- Message format: `F0 00 21 27 6D [sysExId] 54 [slot] [p_high] [p_mid] [p_low] [version] [index] F7`
- No response expected (fire-and-forget)
- Demo/offline modes silently ignore (no-op)

### Performance Page Semantics

[Source: Story 1.1 Dev Notes, Epic 1]

- **perfPageIndex = 0:** "NOT ASSIGNED" to any performance page
- **perfPageIndex 1-15:** Valid performance pages (15 pages available)
- Stored in `PackedMappingData.perfPageIndex` field (mapping version 5)
- Database: `preset_mappings.perf_page_index` column

### Property Editor Implementation

[Source: lib/ui/widgets/section_parameter_list_view.dart]

**Current Structure:**
- Displays parameters for selected slot/algorithm
- Uses `ParameterEditorView` widgets for value controls
- Already has performance parameters section at top (Story 1.4)
- Regular parameter list follows below

**Implementation Location:**
The regular parameter list rendering likely happens in a method like `_buildParameterRow()` or similar. Need to add performance page dropdown to each parameter row.

**Suggested Dropdown Design:**
```dart
Widget _buildPerformancePageDropdown(int slotIndex, int paramIndex, int currentPageIndex) {
  return DropdownButton<int>(
    value: currentPageIndex,
    onChanged: (newValue) {
      if (newValue != null) {
        _assignToPerformancePage(slotIndex, paramIndex, newValue);
      }
    },
    items: [
      DropdownMenuItem(value: 0, child: Text('Not Assigned')),
      ...List.generate(15, (i) => DropdownMenuItem(
        value: i + 1,
        child: Text('Page ${i + 1}'),
      )),
    ],
    isDense: true,
    style: TextStyle(fontSize: 12),
  );
}

Future<void> _assignToPerformancePage(int slotIndex, int paramIndex, int pageIndex) async {
  final cubit = context.read<DistingCubit>();
  await cubit.setPerformancePageMapping(slotIndex, paramIndex, pageIndex);

  if (!mounted) return;

  final message = pageIndex > 0
    ? 'Assigned to Page $pageIndex'
    : 'Removed from performance pages';

  ScaffoldMessenger.of(context).showSnackBar(
    SnackBar(content: Text(message), duration: Duration(seconds: 2)),
  );
}
```

### Reading Current perfPageIndex

[Source: lib/cubit/disting_cubit.dart]

To read the current performance page assignment:
```dart
// Access via DistingCubit state
state.maybeWhen(
  synchronized: (disting, slots, presetName, cpuUsage, videoFrame) {
    final slot = slots[slotIndex];
    // Mapping data is likely accessible via a method or field
    // May need to add a getter or access mappings directly
  },
  orElse: () => 0, // Default to not assigned
);
```

**Note:** May need to expose mapping data through DistingCubit if not already accessible.

### File Locations

[Source: docs/architecture/source-tree.md]

- `lib/ui/widgets/section_parameter_list_view.dart` - Property editor, add dropdown here
- `lib/cubit/disting_cubit.dart` - State manager, `setPerformancePageMapping()` already exists
- `lib/models/packed_mapping_data.dart` - Contains `perfPageIndex` field (Story 1.1)
- `lib/domain/sysex/requests/set_performance_page_message.dart` - SysEx 0x54 (Story 1.2)

### Technical Constraints

[Source: docs/architecture/coding-standards.md]

- Use Cubit pattern for state management
- Use BlocBuilder to access DistingCubit state
- Use `debugPrint()` for logging, never `print()`
- `flutter analyze` must pass with zero warnings
- Follow existing property editor UI patterns exactly

### Integration Points

[Source: Stories 1.2, 1.3, 1.4]

**Story 1.2 Integration:**
- SysEx 0x54 handler sends assignment to hardware
- `IDistingMidiManager.setPerformancePageMapping()` implemented in all three modes

**Story 1.3 Integration:**
- Performance screen dynamically discovers populated pages
- Assigning parameter to page makes that page appear in side-nav
- Removing last parameter from page makes page disappear from side-nav

**Story 1.4 Integration:**
- Performance Parameters section at top of property editor
- Assigning parameter makes it appear in this section
- Removing parameter makes it disappear from this section

## Testing

### Manual Testing Checklist

- [x] Dropdown appears for each parameter in property editor
- [x] Dropdown shows "Not Assigned" and "Page 1" through "Page 15"
- [x] Current performance page assignment displayed correctly
- [x] Selecting a page assigns parameter to that page
- [x] Parameter appears in Performance Parameters section (Story 1.4) when assigned
- [x] Parameter appears in Performance page (Story 1.3) when assigned
- [x] Parameter disappears from performance sections when set to "Not Assigned"
- [x] SnackBar confirmation shows after assignment (connected mode only)
- [x] Works in connected mode (SysEx sent)
- [x] Works in demo mode (silently ignored, no SnackBar)
- [x] Works in offline mode (silently ignored, no SnackBar)
- [x] Existing parameter editing still works
- [x] Layout looks good, dropdown doesn't clutter UI

### Edge Cases to Test

- [x] Assign parameter to page 1, verify it appears
- [x] Change parameter from page 1 to page 5, verify it moves
- [x] Assign multiple parameters to same page, verify all appear
- [x] Remove parameter from page, verify it disappears from performance sections
- [x] Assign all parameters to different pages, verify all work
- [x] Switch between algorithms, verify assignments persist per algorithm

### Quality Assurance

1. [x] Run `flutter analyze` - zero warnings ✅
2. [x] Run `flutter test` - all tests pass (104 passed, 11 skipped) ✅
3. [x] Test on desktop (macOS tested with hardware connection) ✅
4. [x] Test all three operation modes (connected/demo/offline) ✅
5. [x] Verify no regression in Stories 1.1, 1.2, 1.3, 1.4 ✅

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Story created to complete Epic 1 user workflow | Bob (Scrum Master) |
| 2025-09-30 | 1.1 | QA fixes: Updated dropdown labels, suppressed SnackBar in demo/offline modes | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None

### Completion Notes List

- Implemented performance page dropdown selector in property editor using compact DropdownButton widget
- Selector displays "Not Assigned" for not assigned (value 0) and "Page 1" through "Page 15" for pages 1-15
- Reads current perfPageIndex from mapping data and displays it in dropdown
- Calls existing `DistingCubit.setPerformancePageMapping()` method on selection
- Shows SnackBar feedback with messages "Assigned to Page X" or "Removed from performance pages" ONLY in connected mode
- Demo and offline modes are completely silent (no SnackBar) as per requirements
- Positioned dropdown at end of parameter row with 8px spacing
- Used compact styling (isDense: true, small font size) to minimize visual clutter
- All three operation modes work correctly via existing infrastructure from Stories 1.2 and 1.4
- App successfully built and ran with hardware connection, verified synchronization works
- All tests pass (104 tests passed, 11 skipped)
- flutter analyze: zero warnings

**QA Fixes Applied (2025-09-30):**
- AC2: Updated dropdown labels from "—" to "Not Assigned" and "P1"-"P15" to "Page 1"-"Page 15"
- AC9: Suppressed SnackBar in demo/offline modes by checking manager type (only DistingMidiManager shows SnackBar)
- Completed manual testing checklist with all items verified

### File List

- Modified: `lib/ui/widgets/section_parameter_list_view.dart`
  - Added `_assignToPerformancePage()` method for handling page assignments
  - Added `_buildParameterRowWithPageSelector()` method to wrap parameter editor with dropdown
  - Modified parameter rendering to use new method with dropdown selector

## QA Results

### Review Date: 2025-09-30

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- AC2 satisfied: dropdown now renders "Not Assigned" and "Page n" entries per acceptance copy (lib/ui/widgets/section_parameter_list_view.dart:240-248).
- AC9 satisfied: SnackBar feedback is gated to live hardware by checking for `DistingMidiManager`, so demo/offline modes remain silent (lib/ui/widgets/section_parameter_list_view.dart:176-191).
- Regular parameter rows successfully wrap the editor plus selector, preserving existing editing behaviour (lib/ui/widgets/section_parameter_list_view.dart:210-253).
- Manual checklist, analyzer, and test runs documented as completed (docs/stories/1.5.assign-parameters-to-performance-pages.story.md:225-256).

### Refactoring Performed

- None – verification only.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ Checklist + `flutter analyze`/`flutter test` entries captured.
- All ACs Met: ✓ AC1-AC11 satisfied after copy and feedback fixes.

### Improvements Checklist

- [ ] Consider extending the connected-mode SnackBar guard to the performance parameter removal button for consistency (lib/ui/widgets/section_parameter_list_view.dart:150-158).

### Security Review

- UI-only change; no new attack surface identified.

### Performance Considerations

- Dropdown addition piggybacks on existing row layout; no regressions observed.

### Files Modified During Review

- None.

### Gate Status

Gate: PASS → docs/qa/gates/1.5-assign-parameters-to-performance-pages.yml
Risk profile: (not generated)
NFR assessment: (not generated)

### Recommended Status

[✓ Ready for Done]
