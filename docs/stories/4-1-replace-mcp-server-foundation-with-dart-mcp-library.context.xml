<story-context id="bmad/bmm/workflows/4-implementation/story-context/4-1" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>4.1</storyId>
    <title>Replace MCP server foundation with dart_mcp library</title>
    <status>drafted</status>
    <generatedAt>2025-11-07</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/4-1-replace-mcp-server-foundation-with-dart-mcp-library.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer maintaining MCP integration</asA>
    <iWant>to migrate from the current MCP library to the official `dart_mcp` package with HTTP streaming transport</iWant>
    <soThat>MCP clients can connect via standard HTTP on port 3000 without stdio configuration friction</soThat>
    <tasks>
- Research and dependency updates (AC: 1-3)
- Update MCP server service implementation (AC: 4-7)
- Cleanup and verification (AC: 8-12)
    </tasks>
  </story>

  <acceptanceCriteria>
1. Add `dart_mcp` dependency to `pubspec.yaml` (verify latest stable version from pub.dev)
2. Remove current MCP library dependency from `pubspec.yaml`
3. Study example servers in `https://github.com/dart-lang/ai/tree/main/pkgs/dart_mcp/example` to understand proper setup patterns
4. Update `mcp_server_service.dart` to initialize HTTP server on port 3000 with `/mcp` endpoint using `dart_mcp` streamable HTTP transport
5. Configure server to use `dart_mcp`'s built-in streamable HTTP transport (following dart_mcp example patterns)
6. Server accepts HTTP POST requests to `/mcp` endpoint with MCP protocol messages
7. Backend connection handling (cubit access, MIDI manager access) remains functional
8. Server logs startup message with connection URL: "MCP server running at http://localhost:3000/mcp"
9. Verify server responds to MCP handshake via HTTP client (curl or Postman test)
10. Remove all old MCP library imports from codebase
11. `flutter analyze` passes with zero warnings
12. All tests pass
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epic-4-context.md</path>
        <title>Epic 4 Technical Context</title>
        <section>dart_mcp Library Research</section>
        <snippet>Official Dart/Flutter MCP implementation from Google. Supports HTTP streaming transport (our target). Standard MCP protocol compliance. Example servers available in repo.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Critical Architecture: MCP Server</section>
        <snippet>The MCP (Model Context Protocol) server exposes the app's functionality to external tools and AI agents via HTTP. Architecture: HTTP Server (McpServerService), Controller Interface (DistingController), Controller Implementation (DistingControllerImpl), Tool Implementations (algorithm_tools.dart, disting_tools.dart).</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>lib/services/mcp_server_service.dart</path>
        <kind>service</kind>
        <symbol>McpServerService</symbol>
        <lines>1-100</lines>
        <reason>Primary modification target - current MCP server implementation using custom library. ~1100 lines total with multi-client support, HTTP-based on port 3000.</reason>
        <snippet>
class McpServerService extends ChangeNotifier {
  McpServerService._(this._distingCubit);

  static McpServerService? _instance;
  static McpServerService get instance { ... }
  static void initialize({required DistingCubit distingCubit}) { ... }

  final DistingCubit _distingCubit;
  final Map&lt;String, McpServer&gt; _servers = {};
  final Map&lt;String, StreamableHTTPServerTransport&gt; _transports = {};
  HttpServer? _httpServer;
  StreamSubscription&lt;HttpRequest&gt;? _httpSubscription;
  final Map&lt;String, String&gt; _resourceCache = {};

  bool get isRunning => _httpServer != null;
  Map&lt;String, dynamic&gt; get connectionDiagnostics { ... }
}
        </snippet>
      </file>
      <file>
        <path>lib/services/disting_controller.dart</path>
        <kind>interface</kind>
        <symbol>DistingController</symbol>
        <lines>1-100</lines>
        <reason>Abstract interface for MCP tools - should remain unchanged during migration</reason>
        <snippet>
abstract class DistingController {
  Future&lt;String&gt; getCurrentPresetName();
  Future&lt;void&gt; setPresetName(String name);
  Future&lt;Algorithm?&gt; getAlgorithmInSlot(int slotIndex);
  Future&lt;List&lt;ParameterInfo&gt;&gt; getParametersForSlot(int slotIndex);
  Future&lt;void&gt; addAlgorithm(Algorithm algorithm);
  Future&lt;void&gt; clearSlot(int slotIndex);
  Future&lt;void&gt; moveAlgorithmUp(int slotIndex);
  Future&lt;void&gt; moveAlgorithmDown(int slotIndex);
  Future&lt;void&gt; updateParameterValue(int slotIndex, int parameterNumber, dynamic value);
  Future&lt;void&gt; updateParameterString(int slotIndex, int parameterNumber, String value);
  Future&lt;Map&lt;int, Algorithm?&gt;&gt; getAllSlots();
  // ... 20+ more methods
}
        </snippet>
      </file>
      <file>
        <path>lib/services/disting_controller_impl.dart</path>
        <kind>service</kind>
        <symbol>DistingControllerImpl</symbol>
        <reason>Controller implementation - should remain unchanged, delegates to DistingCubit</reason>
      </file>
      <file>
        <path>lib/cubit/disting_cubit.dart</path>
        <kind>cubit</kind>
        <symbol>DistingCubit</symbol>
        <reason>Central state manager - backend connection that must remain functional after migration</reason>
      </file>
      <file>
        <path>pubspec.yaml</path>
        <kind>config</kind>
        <reason>Dependency configuration - will add dart_mcp and remove old MCP library</reason>
      </file>
    </code>
    <dependencies>
      <package name="dart_mcp" source="pub.dev" purpose="Official MCP library to replace current implementation" />
      <package name="mcp_dart" source="git" status="to-be-removed" purpose="Current MCP library (git dependency)" />
    </dependencies>
  </artifacts>

  <constraints>
- Preserve existing multi-client session management architecture
- Maintain resource pre-loading functionality from assets/mcp_docs/
- Keep controller interface and implementation unchanged
- Replace only the transport layer (stdio â†’ HTTP streaming)
- Follow dart_mcp example patterns for HTTP server setup
- HTTP endpoint must remain at /mcp on port 3000
- Zero tolerance: flutter analyze must pass with zero warnings
  </constraints>

  <interfaces>
    <interface>
      <name>McpServerService.initialize</name>
      <kind>static-method</kind>
      <signature>static void initialize({required DistingCubit distingCubit})</signature>
      <path>lib/services/mcp_server_service.dart</path>
      <usage>Called during app initialization to set up MCP server singleton</usage>
    </interface>
    <interface>
      <name>McpServerService.start</name>
      <kind>method</kind>
      <signature>Future&lt;void&gt; start({int port = 3000})</signature>
      <path>lib/services/mcp_server_service.dart</path>
      <usage>Starts HTTP server and begins accepting MCP client connections</usage>
    </interface>
    <interface>
      <name>dart_mcp HTTP transport</name>
      <kind>external-api</kind>
      <signature>StreamableHTTPServerTransport from dart_mcp package</signature>
      <usage>New transport mechanism to replace current custom implementation</usage>
    </interface>
  </interfaces>

  <tests>
    <standards>
Uses flutter_test framework with mocktail for mocking. All tests must pass. Manual testing with HTTP client (curl/Postman) required to verify handshake. Test server initialization, multi-client support, and session cleanup.
    </standards>
    <locations>
test/services/mcp_server_service_test.dart (if exists)
test/integration/ (for manual HTTP handshake tests)
    </locations>
    <ideas>
- Test server initialization with dart_mcp library
- Test HTTP POST to /mcp endpoint accepts MCP protocol messages
- Test multi-client session management still works
- Test resource pre-loading from assets/mcp_docs/ still works
- Test backend connection handling (DistingCubit access) remains functional
- Manual test: curl -X POST http://localhost:3000/mcp with MCP handshake message
- Verify connection diagnostics still function
- Test server cleanup on shutdown
    </ideas>
  </tests>
</story-context>
