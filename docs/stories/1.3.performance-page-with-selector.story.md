# Story 1.3: Performance Page with Dynamic Page Selector

## Status

Draft

## Story

**As a** musician using the Performance page,
**I want** a side navigation showing only performance pages with assigned parameters,
**so that** I can quickly switch between my active performance pages without clutter

## Acceptance Criteria

1. Performance page UI includes side navigation rail showing only populated pages
2. Side-nav displays page labels as "Page 1", "Page 2", etc. for pages with `perfPageIndex > 0`
3. Clicking a page in side-nav filters parameters to show only those with `perfPageIndex` matching selected page
4. Pages with no parameters do NOT appear in side-nav (dynamic list)
5. If no pages have parameters, show empty state: "No performance parameters assigned"
6. Current selected page is visually highlighted in side-nav
7. Parameters displayed with existing UI patterns (parameter controls, values)
8. All three operation modes (demo, offline, connected) work correctly
9. Page selection defaults to first populated page
10. `flutter analyze` passes with zero warnings
11. UI is responsive and follows existing Flutter layout patterns

## Tasks / Subtasks

- [ ] Locate Performance screen implementation (AC: 1)
  - [ ] Find `lib/ui/performance_screen.dart` or equivalent
  - [ ] Read existing implementation to understand current structure
  - [ ] Identify where parameter list is rendered

- [ ] Implement logic to discover populated pages (AC: 1, 2, 4)
  - [ ] Query all parameters from current preset (via DistingCubit)
  - [ ] Build set of unique perfPageIndex values where perfPageIndex > 0
  - [ ] Sort page indices (1, 2, 3, ...)
  - [ ] Return empty list if no pages have parameters

- [ ] Design dynamic side-nav UI (AC: 1, 2, 9)
  - [ ] Use Flutter `NavigationRail` widget for side-nav
  - [ ] Create destinations dynamically based on populated pages
  - [ ] Set labels as "Page 1", "Page 2", etc.
  - [ ] Set initial selected index to first populated page
  - [ ] Handle case where no pages exist (hide nav rail)

- [ ] Implement page selection state management (AC: 6, 9)
  - [ ] Add `selectedPageIndex` state variable
  - [ ] Default to first populated page (or null if none)
  - [ ] Add `onPageSelected(int pageIndex)` callback
  - [ ] Update UI when page selection changes

- [ ] Implement parameter filtering logic (AC: 3)
  - [ ] Query current preset's parameters from DistingCubit
  - [ ] Filter parameters where `perfPageIndex == selectedPageIndex`
  - [ ] Handle empty case gracefully

- [ ] Update Performance page layout (AC: 7, 11)
  - [ ] Use Row with NavigationRail on left (if pages exist) and parameter list on right
  - [ ] NavigationRail takes minimal width
  - [ ] Parameter list expands to fill remaining space
  - [ ] If no pages exist, show full-width empty state
  - [ ] Ensure responsive layout works on different screen sizes

- [ ] Display filtered parameters (AC: 7)
  - [ ] Reuse existing parameter display widgets
  - [ ] Show parameter name, value, controls
  - [ ] Maintain existing interaction patterns (edit values)
  - [ ] Group by algorithm/slot for clarity

- [ ] Handle empty state (AC: 5)
  - [ ] Display centered message when no pages have parameters
  - [ ] Message: "No performance parameters assigned"
  - [ ] Subtitle: "Assign parameters to performance pages in the property editor"
  - [ ] Follow existing empty state patterns in app

- [ ] Test all operation modes (AC: 8)
  - [ ] Test demo mode: dynamic page list works
  - [ ] Test offline mode: cached data filters correctly
  - [ ] Test connected mode: live data filters correctly
  - [ ] Verify no exceptions in any mode

- [ ] Test dynamic behavior
  - [ ] Verify pages appear when parameters assigned
  - [ ] Verify pages disappear when last parameter removed
  - [ ] Verify selected page updates if current page becomes empty
  - [ ] Handle edge case: selected page's last parameter removed (switch to first available or empty state)

- [ ] Run flutter analyze (AC: 10)
  - [ ] Run `flutter analyze` and ensure zero warnings
  - [ ] Fix any linter issues immediately

## Dev Notes

### Performance Page Semantics

[Source: Context-fetcher findings, Epic 1]

- **perfPageIndex = 0:** Not assigned to any performance page
- **perfPageIndex 1-15:** Valid performance pages
- **Dynamic display:** Only show pages where at least one parameter has that perfPageIndex

### Discovering Populated Pages

```dart
Set<int> getPopulatedPages(List<Slot> slots) {
  final populatedPages = <int>{};

  for (final slot in slots) {
    for (int i = 0; i < slot.parameters.length; i++) {
      final mapping = getMappingForParameter(slot.index, i);
      if (mapping.perfPageIndex > 0) {
        populatedPages.add(mapping.perfPageIndex);
      }
    }
  }

  return populatedPages;
}
```

### Dynamic NavigationRail Implementation

```dart
class PerformanceScreen extends StatefulWidget {
  @override
  State<PerformanceScreen> createState() => _PerformanceScreenState();
}

class _PerformanceScreenState extends State<PerformanceScreen> {
  int? _selectedPageIndex; // Nullable - null if no pages

  @override
  Widget build(BuildContext context) {
    return BlocBuilder<DistingCubit, DistingState>(
      builder: (context, state) {
        return state.maybeWhen(
          synchronized: (disting, slots, presetName, cpuUsage, videoFrame) {
            // Discover populated pages
            final populatedPages = _getPopulatedPages(slots).toList()..sort();

            if (populatedPages.isEmpty) {
              return _buildEmptyState();
            }

            // Set initial selection to first page if not set
            if (_selectedPageIndex == null ||
                !populatedPages.contains(_selectedPageIndex)) {
              _selectedPageIndex = populatedPages.first;
            }

            return Row(
              children: [
                // Dynamic side navigation
                NavigationRail(
                  selectedIndex: populatedPages.indexOf(_selectedPageIndex!),
                  onDestinationSelected: (int index) {
                    setState(() {
                      _selectedPageIndex = populatedPages[index];
                    });
                  },
                  labelType: NavigationRailLabelType.all,
                  destinations: populatedPages.map((pageIndex) {
                    return NavigationRailDestination(
                      icon: Icon(Icons.music_note),
                      label: Text('Page $pageIndex'),
                    );
                  }).toList(),
                ),

                // Parameter list (filtered)
                Expanded(
                  child: _buildParameterList(slots, _selectedPageIndex!),
                ),
              ],
            );
          },
          orElse: () => Center(child: Text('Not connected')),
        );
      },
    );
  }

  Set<int> _getPopulatedPages(List<Slot> slots) {
    final populatedPages = <int>{};
    for (final slot in slots) {
      for (int i = 0; i < slot.parameters.length; i++) {
        final mapping = _getMappingForParameter(slot.index, i);
        if (mapping.perfPageIndex > 0) {
          populatedPages.add(mapping.perfPageIndex);
        }
      }
    }
    return populatedPages;
  }

  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.music_note_outlined, size: 64, color: Colors.grey),
          SizedBox(height: 16),
          Text(
            'No performance parameters assigned',
            style: Theme.of(context).textTheme.headlineSmall,
          ),
          SizedBox(height: 8),
          Text(
            'Assign parameters to performance pages in the property editor',
            style: Theme.of(context).textTheme.bodyMedium?.copyWith(
              color: Colors.grey,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildParameterList(List<Slot> slots, int pageIndex) {
    // Filter and display parameters for selected page
  }
}
```

### Parameter Filtering from DistingCubit

[Source: lib/cubit/disting_cubit.dart]

```dart
List<ParameterWithMapping> _getParametersForPage(
  List<Slot> slots,
  int pageIndex,
) {
  final parameters = <ParameterWithMapping>[];

  for (final slot in slots) {
    for (int i = 0; i < slot.parameters.length; i++) {
      final param = slot.parameters[i];
      final value = slot.parameterValues[i];
      final mapping = _getMappingForParameter(slot.index, i);

      if (mapping.perfPageIndex == pageIndex) {
        parameters.add(ParameterWithMapping(
          slotIndex: slot.index,
          algorithmName: slot.algorithm.name,
          parameter: param,
          value: value,
          mapping: mapping,
        ));
      }
    }
  }

  return parameters;
}
```

### Edge Case Handling

**Case: Selected page becomes empty**
- User removes last parameter from currently selected page
- Page disappears from nav rail
- Auto-select first available page (or show empty state if no pages left)

```dart
// In setState after parameter change:
if (_selectedPageIndex != null &&
    !populatedPages.contains(_selectedPageIndex)) {
  _selectedPageIndex = populatedPages.isNotEmpty
    ? populatedPages.first
    : null;
}
```

### File Locations

[Source: docs/architecture/source-tree.md]

- `lib/ui/performance_screen.dart` - Main screen to modify
- `lib/cubit/disting_cubit.dart` - State source for parameters
- `lib/models/packed_mapping_data.dart` - Contains perfPageIndex field

### Technical Constraints

[Source: docs/architecture/coding-standards.md]

- Follow Cubit pattern for state management
- Use BlocBuilder to access DistingCubit state
- Use `debugPrint()` for logging
- `flutter analyze` must pass with zero warnings

## Testing

### Manual Testing Checklist

- [ ] Side-nav shows only pages with parameters
- [ ] Clicking page filters parameters correctly
- [ ] Selected page is visually highlighted
- [ ] Empty state shows when no pages have parameters
- [ ] Page with parameters displays them correctly
- [ ] Parameter controls work (can edit values)
- [ ] Page disappears when last parameter removed
- [ ] Selected page switches automatically if current page becomes empty
- [ ] Works in demo mode
- [ ] Works in offline mode
- [ ] Works in connected mode
- [ ] Layout is responsive

### Edge Cases to Test

- [ ] No parameters assigned anywhere (empty state)
- [ ] Only one page has parameters (single item in nav)
- [ ] All 15 pages have parameters (full nav rail)
- [ ] Selected page's last parameter removed (auto-switch)
- [ ] Multiple algorithms on same page (grouped display)

### Quality Assurance

1. Run `flutter analyze` - zero warnings
2. Test on desktop (macOS/Linux/Windows)
3. Test on mobile if applicable (iOS/Android)
4. Test all three operation modes
5. Verify no regression in other screens

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Story created from Epic 1 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_To be filled by QA agent_
