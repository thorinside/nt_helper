<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>9</epicId>
    <storyId>1</storyId>
    <title>Platform Detection and Conditional Layout</title>
    <status>drafted</status>
    <generatedAt>2025-11-16</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/9-1-platform-detection-and-conditional-layout.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer implementing platform-adaptive UI</asA>
    <iWant>the bottom bar to conditionally render based on platform using PlatformInteractionService</iWant>
    <soThat>mobile and desktop users each get optimal layouts without maintaining separate codebases</soThat>
    <tasks>
      - Task 1: Add platform detection to `_buildBottomAppBar()` (AC: 1-3)
      - Task 2: Implement desktop layout (AC: 4-6)
      - Task 3: Implement mobile layout (AC: 7-10)
      - Task 4: Verify unchanged modes (AC: 11-12)
      - Task 5: Verify layout consistency (AC: 13-16)
      - Task 6: Code quality (AC: 17)
      - Task 7: Widget tests (AC: 18-20)
    </tasks>
  </story>

  <acceptanceCriteria>
    1. Bottom bar builder calls `_platformService.isMobilePlatform()` to detect platform
    2. Platform detection result stored in local boolean variable `isMobile`
    3. Detection happens on every rebuild (no caching issues)
    4. When `!isMobile` AND connected mode (`!isOffline`): Row with 4 icon buttons renders (existing code path)
    5. When `!isMobile` AND connected mode: All 4 display mode buttons visible with correct icons and tooltips
    6. When `!isMobile` AND connected mode: Clicking button triggers `setDisplayMode()` correctly
    7. When `isMobile` AND connected mode (`!isOffline`): Single IconButton with "View Options" label renders
    8. When `isMobile` AND connected mode: Button uses `Icons.view_list` icon
    9. When `isMobile` AND connected mode: Button has tooltip "View Options"
    10. When `isMobile` AND connected mode: Button `onPressed` handler defined (can be no-op for this story)
    11. Offline mode shows "Offline Data" button on both mobile and desktop (unchanged)
    12. Demo mode shows appropriate button on both mobile and desktop (unchanged)
    13. Bottom bar height remains consistent across modes
    14. Mode switcher (Parameters/Routing) still renders correctly on all platforms
    15. Platform-conditional elements (MCP status, version, CPU) still render correctly
    16. FAB spacer (80px) still present on all platforms
    17. `flutter analyze` passes with zero warnings
    18. Widget test verifies desktop layout renders 4 buttons
    19. Widget test verifies mobile layout renders 1 button
    20. Widget test verifies offline mode renders correctly on both platforms
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/mobile-bottom-bar-epic.md</path>
        <title>Epic 9: Mobile Bottom Bar Optimization</title>
        <section>Story 1: Platform Detection and Conditional Layout</section>
        <snippet>Platform-adaptive bottom bar using existing PlatformInteractionService. Desktop maintains 4 icon buttons, mobile shows single "View Options" button. Implementation requires conditional layout in _buildBottomAppBar() method.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification - Mobile Bottom Bar</title>
        <section>Section 4.1: Bottom Bar Component (Modified)</section>
        <snippet>Desktop layout keeps existing Row with 4 IconButtons. Mobile layout uses single IconButton with Icons.view_list and onPressed handler. Platform detection via _platformService.isMobilePlatform().</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Coding Standards and Patterns</section>
        <snippet>Zero tolerance for flutter analyze warnings. Use debugPrint() never print(). Follow Cubit pattern for state management. Async/await over .then(). Specific exceptions over generic.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>lib/ui/synchronized_screen.dart</path>
        <kind>screen</kind>
        <symbol>_buildBottomAppBar</symbol>
        <lines>509-646</lines>
        <reason>Primary implementation file. Method builds bottom app bar with mode switcher and display mode buttons. Already has isMobile variable on line 512. Needs conditional logic added for mobile vs desktop layout.</reason>
      </artifact>
      <artifact>
        <path>lib/core/platform/platform_interaction_service.dart</path>
        <kind>service</kind>
        <symbol>PlatformInteractionService</symbol>
        <lines>14-63</lines>
        <reason>Provides isMobilePlatform() method returning true for iOS/Android. Already instantiated as _platformService in synchronized_screen.dart. No changes needed, existing service.</reason>
      </artifact>
      <artifact>
        <path>lib/cubit/disting_cubit.dart</path>
        <kind>cubit</kind>
        <symbol>setDisplayMode</symbol>
        <lines>unknown</lines>
        <reason>Existing method for changing hardware display mode. Called by desktop icon buttons, will be reused in mobile bottom sheet. No changes needed.</reason>
      </artifact>
      <artifact>
        <path>lib/domain/disting_nt_sysex.dart</path>
        <kind>enum</kind>
        <symbol>DisplayMode</symbol>
        <lines>unknown</lines>
        <reason>Enum defining display modes: parameters, algorithmUI, overview, overviewVUs. Used by setDisplayMode(). No changes needed.</reason>
      </artifact>
    </code>
    <dependencies>
      <flutter>
        <package>flutter</package>
        <version>sdk</version>
        <usage>Material widgets, Icons, BuildContext</usage>
      </flutter>
      <flutter>
        <package>flutter_bloc</package>
        <version>^9.1.1</version>
        <usage>context.read&lt;DistingCubit&gt;() for state access</usage>
      </flutter>
    </dependencies>
  </artifacts>

  <constraints>
    - Single file change only: lib/ui/synchronized_screen.dart
    - Must NOT break existing desktop layout (4 buttons visible)
    - Must NOT modify offline/demo mode behavior (single button unchanged)
    - Platform detection happens on every rebuild (no caching)
    - Uses existing _platformService instance, no new service instantiation
    - Uses existing setDisplayMode() method, no new state management
    - Mobile button onPressed can be no-op placeholder for Story 9.2
    - Must pass flutter analyze with zero warnings
    - Bottom bar height must remain consistent across modes
    - FAB spacer (80px) must remain present on all platforms
    - Mode switcher (Parameters/Routing) must render correctly
    - Platform-conditional elements (MCP status, version, CPU) unchanged
  </constraints>

  <interfaces>
    <interface>
      <name>PlatformInteractionService.isMobilePlatform</name>
      <kind>service method</kind>
      <signature>bool isMobilePlatform()</signature>
      <path>lib/core/platform/platform_interaction_service.dart:20-23</path>
      <usage>Returns true for iOS/Android, false for macOS/Windows/Linux. Already called on line 512 of synchronized_screen.dart.</usage>
    </interface>
    <interface>
      <name>DistingCubit.setDisplayMode</name>
      <kind>cubit method</kind>
      <signature>void setDisplayMode(DisplayMode mode)</signature>
      <path>lib/cubit/disting_cubit.dart</path>
      <usage>Changes hardware display mode. Called by desktop buttons lines 578-614. Will be reused in mobile bottom sheet in Story 9.2.</usage>
    </interface>
    <interface>
      <name>DisplayMode enum</name>
      <kind>enum</kind>
      <signature>enum DisplayMode { parameters, algorithmUI, overview, overviewVUs }</signature>
      <path>lib/domain/disting_nt_sysex.dart</path>
      <usage>Four display modes for hardware. Used with setDisplayMode().</usage>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Flutter testing framework with mocktail for mocking. Widget tests use testWidgets() with pumpWidget(). Mock PlatformInteractionService to control isMobilePlatform() return value. Tests verify UI rendering, not business logic (all logic in Cubit). Use flutter_test package. Tests NOT required for all code but new features should include tests for visibility and usefulness. Pragmatic testing approach, not TDD.
    </standards>
    <locations>
      test/ui/ - Widget tests
      test/core/platform/ - Platform service tests (if any)
    </locations>
    <ideas>
      <test id="AC18" criteria="Widget test verifies desktop layout renders 4 buttons">
        Mock isMobilePlatform() → false. Pump synchronized_screen with offline=false. Find Row widget containing 4 IconButtons. Verify each has correct tooltip: "Parameter View", "Algorithm UI", "Overview UI", "Overview VU Meters".
      </test>
      <test id="AC19" criteria="Widget test verifies mobile layout renders 1 button">
        Mock isMobilePlatform() → true. Pump synchronized_screen with offline=false. Find single IconButton with tooltip "View Options" and icon Icons.view_list. Verify Row with 4 buttons NOT present.
      </test>
      <test id="AC20" criteria="Widget test verifies offline mode renders correctly on both platforms">
        Test 1: Mock isMobilePlatform() → true, offline=true. Verify "Offline Data" button present. Test 2: Mock isMobilePlatform() → false, offline=true. Verify "Offline Data" button present. Both platforms should show identical offline button.
      </test>
    </ideas>
  </tests>
</story-context>
