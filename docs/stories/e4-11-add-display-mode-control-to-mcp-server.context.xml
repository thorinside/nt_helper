<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <metadata>
    <story-id>E4.11</story-id>
    <story-key>e4-11-add-display-mode-control-to-mcp-server</story-key>
    <title>Add display mode control to MCP server</title>
    <generated-date>2025-11-21</generated-date>
  </metadata>

  <story-overview>
    <user-story>
      As an LLM client debugging or testing hardware display behavior,
      I want to programmatically switch the Disting NT's display mode and capture screenshots of each mode,
      so that I can inspect all available display views without manual hardware interaction.
    </user-story>

    <implementation-summary>
      Extend the existing MCP `show` tool to accept an optional `display_mode` parameter.
      When provided with target "screen", the tool will change the display mode before capturing a screenshot.
      This enables LLM clients to programmatically view all four hardware display modes.
    </implementation-summary>
  </story-overview>

  <technical-context>
    <primary-files>
      <file path="lib/mcp/tools/disting_tools.dart" purpose="Extend show tool handler with display_mode parameter"/>
      <file path="lib/cubit/disting_state.dart" purpose="DisplayMode enum definition"/>
      <file path="lib/cubit/disting_cubit.dart" purpose="setDisplayMode() method"/>
    </primary-files>

    <display-mode-mappings>
      <mapping string="parameter" enum="DisplayMode.parameterView" description="Hardware parameter list"/>
      <mapping string="algorithm" enum="DisplayMode.algorithmUI" description="Custom algorithm interface"/>
      <mapping string="overview" enum="DisplayMode.overviewUI" description="All slots overview"/>
      <mapping string="vu_meters" enum="DisplayMode.overviewVUMeters" description="VU meter display"/>
    </display-mode-mappings>

    <implementation-notes>
      <note>Add optional display_mode parameter to show tool JSON schema</note>
      <note>Validate display_mode is one of four allowed string values</note>
      <note>Map string to DisplayMode enum using the mappings above</note>
      <note>Call DistingCubit.setDisplayMode(mode) when display_mode provided with target "screen"</note>
      <note>Add 200ms delay after mode change: await Future.delayed(Duration(milliseconds: 200))</note>
      <note>Only works in connected mode - return error if offline/demo</note>
      <note>Default behavior preserved when display_mode not provided</note>
    </implementation-notes>

    <testing-requirements>
      <requirement>Unit tests for display_mode parameter validation</requirement>
      <requirement>Unit tests for string to enum mapping</requirement>
      <requirement>Integration test for mode change + screenshot flow</requirement>
      <requirement>Error handling tests for invalid display_mode values</requirement>
      <requirement>Error handling tests for offline/demo mode</requirement>
      <requirement>Verify flutter analyze passes with zero warnings</requirement>
      <requirement>Verify all existing tests still pass</requirement>
    </testing-requirements>
  </technical-context>

  <acceptance-criteria>
    <criterion id="1">Extend show tool to accept optional display_mode parameter: "parameter" | "algorithm" | "overview" | "vu_meters"</criterion>
    <criterion id="2">When display_mode provided with target: "screen", set display mode before capturing screenshot</criterion>
    <criterion id="3">Display mode changes use existing DistingCubit.setDisplayMode() method</criterion>
    <criterion id="4">Mode enum mapping as specified in display-mode-mappings</criterion>
    <criterion id="5">Mode change completes before screenshot capture (brief delay ~200ms to allow screen update)</criterion>
    <criterion id="6">Default behavior (no display_mode parameter): capture current screen without changing mode</criterion>
    <criterion id="7">Mode changes persist on hardware (same behavior as UI buttons)</criterion>
    <criterion id="8">Tool validates display_mode value and returns error if invalid</criterion>
    <criterion id="9">Tool works only in connected mode (clear error if offline/demo)</criterion>
    <criterion id="10">Example usage: show(target: "screen", display_mode: "vu_meters") returns screenshot of VU meter display</criterion>
    <criterion id="11">Example usage: show(target: "screen") returns screenshot of current display (no mode change)</criterion>
    <criterion id="12">JSON schema documents display_mode parameter with all four mode options</criterion>
    <criterion id="13">JSON schema includes examples for each display mode</criterion>
    <criterion id="14">flutter analyze passes with zero warnings</criterion>
    <criterion id="15">All tests pass</criterion>
  </acceptance-criteria>

  <architecture-constraints>
    <constraint>Must use existing DisplayMode enum from disting_state.dart</constraint>
    <constraint>Must use existing DistingCubit.setDisplayMode() method</constraint>
    <constraint>Must preserve existing show tool behavior when display_mode not provided</constraint>
    <constraint>Must only work in connected mode</constraint>
    <constraint>Must add 200ms delay after mode change for screen update</constraint>
  </architecture-constraints>

  <references>
    <reference source="docs/epics.md" section="Epic 4 Story E4.11"/>
    <reference source="lib/cubit/disting_state.dart" description="DisplayMode enum definition"/>
    <reference source="lib/cubit/disting_cubit.dart" description="setDisplayMode() method"/>
    <reference source="lib/mcp/tools/disting_tools.dart" description="show tool implementation"/>
  </references>
</story-context>
