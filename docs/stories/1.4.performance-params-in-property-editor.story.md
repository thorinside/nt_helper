# Story 1.4: Display Performance Parameters at Top of Algorithm Property Editor

## Status

Draft

## Story

**As a** musician editing algorithm parameters in the synchronized screen,
**I want** performance parameters displayed in a collapsible section at the top of the property editor,
**so that** I can quickly access, edit, and manage performance page assignments without scrolling through all parameters

## Acceptance Criteria

1. Algorithm property editor displays "Performance Parameters" section at top (above regular parameters)
2. Section is collapsible/expandable with clear visual indicator (chevron icon)
3. Section shows only parameters from current algorithm where `perfPageIndex > 0`
4. Each performance parameter displays: page number badge, parameter name, value control, remove button
5. Page number badge shows which page (e.g., "P1", "P2", etc.)
6. Clicking remove button sets `perfPageIndex = 0` (removes from performance page)
7. Value controls work identically to regular parameter controls
8. Section is collapsed by default if no performance parameters, expanded if parameters exist
9. All three operation modes (demo, offline, connected) work correctly
10. `flutter analyze` passes with zero warnings
11. UI follows existing property editor patterns and theme

## Tasks / Subtasks

- [ ] Locate algorithm property editor in synchronized screen (AC: 1)
  - [ ] Find property editor implementation (likely in `lib/ui/synchronized_screen.dart` or related widget)
  - [ ] Identify where parameter list is rendered
  - [ ] Understand existing parameter display widgets

- [ ] Design collapsible section UI (AC: 1, 2, 8)
  - [ ] Use `ExpansionTile` or custom collapsible widget
  - [ ] Header: "Performance Parameters" with parameter count (e.g., "Performance Parameters (3)")
  - [ ] Chevron icon indicates expanded/collapsed state
  - [ ] Default state: collapsed if empty, expanded if has parameters
  - [ ] Follow existing app theme and styling

- [ ] Filter performance parameters for current algorithm (AC: 3)
  - [ ] Get current slot/algorithm from DistingCubit
  - [ ] Filter parameters where `perfPageIndex > 0`
  - [ ] Sort by perfPageIndex, then parameter number
  - [ ] Return empty list if no performance parameters

- [ ] Design performance parameter row UI (AC: 4, 5, 7)
  - [ ] Row layout: [Page Badge] [Parameter Name] [Value Control] [Remove Button]
  - [ ] Page badge: Colored chip/badge with "P1", "P2", etc.
  - [ ] Parameter name: Same style as regular parameters
  - [ ] Value control: Reuse existing parameter control widgets (slider, text input, dropdown, etc.)
  - [ ] Remove button: IconButton with X or trash icon

- [ ] Implement remove functionality (AC: 6)
  - [ ] Remove button calls `setPerformancePageMapping(slotIndex, paramIndex, 0)`
  - [ ] Uses SysEx 0x54 handler from Story 1.2
  - [ ] Parameter immediately removed from performance section
  - [ ] Parameter still visible in regular parameter list below
  - [ ] Show confirmation dialog or toast message

- [ ] Implement collapsible state management (AC: 2, 8)
  - [ ] Add `_isPerfSectionExpanded` state variable
  - [ ] Default: `false` if no parameters, `true` if parameters exist
  - [ ] Toggle on header tap
  - [ ] Persist state during session (optional)

- [ ] Integrate with existing parameter controls (AC: 7)
  - [ ] Reuse existing parameter value widgets (sliders, dropdowns, etc.)
  - [ ] Ensure parameter value changes work correctly
  - [ ] Parameter updates sync with hardware (via DistingCubit)
  - [ ] No duplicate logic - call existing parameter update methods

- [ ] Handle empty state (AC: 3, 8)
  - [ ] If no performance parameters, section shows "No parameters assigned"
  - [ ] Section collapsed by default when empty
  - [ ] Optional: Show "Click to assign" hint text

- [ ] Style page number badges (AC: 5)
  - [ ] Use colored chips/badges (Material Chip widget)
  - [ ] Different colors for different pages (or cycling colors)
  - [ ] Text: "P1" through "P15"
  - [ ] Small, compact design

- [ ] Test all operation modes (AC: 9)
  - [ ] Test connected mode: Remove button works, values update
  - [ ] Test demo mode: Remove button ignored (no-op from Story 1.2)
  - [ ] Test offline mode: Remove button ignored (no-op from Story 1.2)
  - [ ] Verify no exceptions in any mode

- [ ] Test dynamic behavior
  - [ ] Parameter appears when assigned to performance page
  - [ ] Parameter disappears when removed
  - [ ] Section collapses when last parameter removed
  - [ ] Section expands when first parameter added

- [ ] Run flutter analyze (AC: 10)
  - [ ] Run `flutter analyze` and ensure zero warnings
  - [ ] Fix any linter issues immediately

## Dev Notes

### Algorithm Property Editor Location

[Source: lib/ui/synchronized_screen.dart, docs/architecture/source-tree.md]

The synchronized screen shows the main interface when connected to hardware. The property editor likely displays parameters for the currently selected algorithm/slot.

**Expected structure:**
- Main screen: `lib/ui/synchronized_screen.dart`
- Parameter display widgets: Reusable components for sliders, dropdowns, etc.
- Current slot selection state managed by DistingCubit

### Collapsible Section Implementation

```dart
class PerformanceParametersSection extends StatefulWidget {
  final int slotIndex;
  final List<ParameterInfo> parameters;
  final List<PackedMappingData> mappings;

  @override
  State<PerformanceParametersSection> createState() =>
      _PerformanceParametersSectionState();
}

class _PerformanceParametersSectionState
    extends State<PerformanceParametersSection> {
  late bool _isExpanded;

  @override
  void initState() {
    super.initState();
    // Default: expanded if has parameters, collapsed if empty
    _isExpanded = _getPerformanceParameters().isNotEmpty;
  }

  List<int> _getPerformanceParameters() {
    final perfParams = <int>[];
    for (int i = 0; i < widget.mappings.length; i++) {
      if (widget.mappings[i].perfPageIndex > 0) {
        perfParams.add(i);
      }
    }
    return perfParams;
  }

  @override
  Widget build(BuildContext context) {
    final perfParams = _getPerformanceParameters();

    return ExpansionTile(
      title: Text(
        'Performance Parameters (${perfParams.length})',
        style: Theme.of(context).textTheme.titleMedium,
      ),
      initiallyExpanded: _isExpanded,
      children: perfParams.isEmpty
        ? [
            Padding(
              padding: EdgeInsets.all(16),
              child: Text(
                'No parameters assigned to performance pages',
                style: TextStyle(color: Colors.grey),
              ),
            ),
          ]
        : perfParams.map((paramIndex) {
            return _buildPerformanceParameterRow(
              paramIndex,
              widget.parameters[paramIndex],
              widget.mappings[paramIndex],
            );
          }).toList(),
    );
  }

  Widget _buildPerformanceParameterRow(
    int paramIndex,
    ParameterInfo param,
    PackedMappingData mapping,
  ) {
    return ListTile(
      leading: _buildPageBadge(mapping.perfPageIndex),
      title: Text(param.name),
      subtitle: ParameterValueControl(
        slotIndex: widget.slotIndex,
        parameterIndex: paramIndex,
        parameter: param,
        // ... existing parameter control props
      ),
      trailing: IconButton(
        icon: Icon(Icons.close),
        tooltip: 'Remove from performance page',
        onPressed: () => _removeFromPerformancePage(paramIndex),
      ),
    );
  }

  Widget _buildPageBadge(int pageIndex) {
    return Chip(
      label: Text('P$pageIndex'),
      backgroundColor: _getPageColor(pageIndex),
      labelStyle: TextStyle(color: Colors.white, fontSize: 12),
    );
  }

  Color _getPageColor(int pageIndex) {
    // Cycle through colors for different pages
    final colors = [
      Colors.blue,
      Colors.green,
      Colors.orange,
      Colors.purple,
      Colors.red,
    ];
    return colors[(pageIndex - 1) % colors.length];
  }

  Future<void> _removeFromPerformancePage(int paramIndex) async {
    final cubit = context.read<DistingCubit>();
    // Call SysEx 0x54 to set perfPageIndex = 0
    await cubit.setPerformancePageMapping(
      widget.slotIndex,
      paramIndex,
      0, // Remove from performance page
    );

    // Show confirmation
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('Removed from performance page')),
    );
  }
}
```

### Integration with DistingCubit

[Source: lib/cubit/disting_cubit.dart]

**Add method to DistingCubit:**
```dart
Future<void> setPerformancePageMapping(
  int slotIndex,
  int parameterNumber,
  int perfPageIndex,
) async {
  return state.maybeWhen(
    synchronized: (disting, _, __, ___, ____, _____) async {
      await disting.setPerformancePageMapping(
        slotIndex,
        parameterNumber,
        perfPageIndex,
      );
      // Optionally refresh state to update UI
    },
    orElse: () => throw StateError('Not synchronized'),
  );
}
```

### Reusing Parameter Controls

[Source: Existing property editor implementation]

The property editor likely has existing widgets for different parameter types:
- Slider for numeric ranges
- Dropdown for enums
- Text input for text parameters
- Toggle for boolean parameters

**Reuse these widgets** rather than recreating them. The performance parameters section should look identical to regular parameters, just grouped at the top.

### Page Badge Colors

Use distinct colors for visual differentiation:
- Page 1: Blue
- Page 2: Green
- Page 3: Orange
- Page 4: Purple
- Page 5: Red
- (Cycle repeats for pages 6-15)

### File Locations

[Source: docs/architecture/source-tree.md]

- `lib/ui/synchronized_screen.dart` - Main screen (likely contains property editor)
- `lib/cubit/disting_cubit.dart` - Add setPerformancePageMapping method
- Possibly: `lib/ui/widgets/parameter_*.dart` - Existing parameter widgets to reuse

### Technical Constraints

[Source: docs/architecture/coding-standards.md]

- Follow existing property editor patterns exactly
- Use BlocBuilder to access DistingCubit state
- Use `debugPrint()` for logging
- `flutter analyze` must pass with zero warnings

## Testing

### Manual Testing Checklist

- [ ] Performance section appears at top of property editor
- [ ] Section shows only performance parameters for current algorithm
- [ ] Page badges display correct page numbers
- [ ] Parameter controls work (can edit values)
- [ ] Remove button removes parameter from performance page
- [ ] Parameter still visible in regular list after removal
- [ ] Section collapses when empty
- [ ] Section expands when has parameters
- [ ] Works in connected mode (remove button functional)
- [ ] Works in demo mode (remove button no-op)
- [ ] Works in offline mode (remove button no-op)
- [ ] UI matches existing property editor style

### Edge Cases to Test

- [ ] Algorithm with no performance parameters (collapsed empty section)
- [ ] Algorithm with all parameters on performance pages (large list)
- [ ] Remove last parameter (section becomes empty, collapses)
- [ ] Multiple parameters on same page (grouped together)
- [ ] Switch between algorithms (section updates correctly)

### Quality Assurance

1. Run `flutter analyze` - zero warnings
2. Test on desktop (macOS/Linux/Windows)
3. Test on mobile if applicable
4. Test all three operation modes
5. Verify no regression in regular parameter editing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Story created from Epic 1 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_To be filled by QA agent_
