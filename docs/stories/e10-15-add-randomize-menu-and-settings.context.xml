<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>10</epicId>
    <storyId>15</storyId>
    <title>Add Randomize Menu and Settings</title>
    <status>drafted</status>
    <generatedAt>2025-11-23</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/e10-15-add-randomize-menu-and-settings.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Step Sequencer user</asA>
    <iWant>to randomize sequence parameters via a menu action and configure randomization settings</iWant>
    <soThat>I can quickly generate new musical ideas with controlled randomization of pitches, rhythms, and probabilities</soThat>
    <tasks>
      - Add Parameter Discovery for Randomize Parameters (AC: #7)
      - Add Overflow Menu to Step Sequencer Header (AC: #1, #2)
      - Implement Randomize Trigger Action (AC: #3)
      - Create Randomize Settings Dialog Widget (AC: #4, #8)
      - Build Parameter Editors in Settings Dialog (AC: #5, #6)
      - Wire Menu to Dialog (AC: #4)
      - Handle Offline and Demo Mode (AC: #9)
      - Add User Feedback (AC: #10)
      - Add Tests
      - Code Quality Validation
    </tasks>
  </story>

  <acceptanceCriteria>
    AC1: Three-Dot Overflow Menu in Header - Step Sequencer header includes overflow menu (three-dot icon) positioned top-right with theme-aware styling
    AC2: Menu Options - Two items: "Randomize" with shuffle icon, "Randomize Settings..." with settings icon
    AC3: Randomize Action Behavior - Triggers randomization by setting Randomise parameter to 1, waits 100ms, resets to 0, closes menu, optional snackbar feedback
    AC4: Randomize Settings Dialog - Opens full-screen/large dialog with title, scrollable content, all 17 randomize parameters using existing parameter editors
    AC5: Randomize Parameters Display - All 17 parameters displayed in scrollable list with appropriate control types (dropdowns, sliders, switches)
    AC6: Parameter Editor Reuse - Uses existing parameter editing infrastructure, passes DistingCubit for updates, all changes use updateParameterValue with debouncing
    AC7: Parameter Discovery - StepSequencerParams provides getters for all 17 randomize parameters with fallback naming patterns
    AC8: Responsive Dialog Layout - Mobile: full-screen with AppBar; Tablet/Desktop: centered dialog max 600px width; scrollable content
    AC9: Offline and Demo Mode Support - Works in all modes (Connected, Offline, Demo) using existing infrastructure, cached values in offline, queued sync
    AC10: User Feedback - Optional snackbar "Randomizing sequence..." after trigger, menu closes after action, no loading spinner needed
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-10.md</path>
        <title>Epic: Visual Step Sequencer UI Widget</title>
        <section>Story 15: Add Randomize Menu and Settings</section>
        <snippet>Story for adding three-dot overflow menu with randomize trigger and settings dialog. Randomise parameter (0-1) triggers randomization, 16 additional parameters control randomization behavior (distribution, ranges, probabilities).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>nt_helper Brownfield Architecture</title>
        <section>Critical Architecture: Step Sequencer UI (Epic 10)</section>
        <snippet>Step Sequencer uses existing AlgorithmViewRegistry pattern, no separate cubit needed, leverages DistingCubit for all parameter updates. Parameter discovery via StepSequencerParams service, debounced writes (50ms), automatic offline mode support.</snippet>
      </doc>
      <doc>
        <path>docs/manual-1.10.0.md</path>
        <title>Firmware Manual 1.10.0</title>
        <section>Step Sequencer Randomization Parameters</section>
        <snippet>Randomise parameter (0-1) triggers randomization. Additional parameters control: what to randomize (0-3), distribution (0-1 uniform/normal), pitch ranges, rhythm ranges, probabilities (note, tie, accent, repeat, ratchet). Probabilities map 0-127 firmware to 0-100% UI.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>lib/ui/step_sequencer_view.dart</path>
        <kind>widget</kind>
        <symbol>StepSequencerView</symbol>
        <lines>1-800+</lines>
        <reason>Main Step Sequencer widget - add overflow menu to header, implement randomize trigger action, navigate to settings dialog</reason>
      </file>
      <file>
        <path>lib/services/step_sequencer_params.dart</path>
        <kind>service</kind>
        <symbol>StepSequencerParams</symbol>
        <lines>1-300+</lines>
        <reason>Parameter discovery service - add 17 getter properties for randomize parameters with fallback naming patterns</reason>
      </file>
      <file>
        <path>lib/cubit/disting_cubit.dart</path>
        <kind>cubit</kind>
        <symbol>DistingCubit</symbol>
        <lines>1-1000+</lines>
        <reason>Central state manager - provides updateParameterValue method for all parameter changes, handles debouncing and offline tracking automatically</reason>
      </file>
      <file>
        <path>lib/ui/widgets/step_sequencer/playback_controls.dart</path>
        <kind>widget</kind>
        <symbol>PlaybackControls</symbol>
        <lines>1-400+</lines>
        <reason>Reference for parameter editor widgets (dropdowns, sliders) that can be reused in randomize settings dialog</reason>
      </file>
    </code>
    <dependencies>
      flutter:
        - flutter: SDK
        - flutter_bloc: ^9.1.1 (BlocBuilder for reactive UI)
        - material: icons for overflow menu (Icons.more_vert, Icons.shuffle, Icons.settings)
      dart: []
    </dependencies>
  </artifacts>

  <constraints>
    - MUST pass flutter analyze with zero warnings before commit
    - NO debug logging (debugPrint) unless explicitly requested
    - Reuse existing parameter editor widgets - do not create custom editors
    - All parameter updates MUST use cubit.updateParameterValue() - no custom update logic
    - Leverage existing debouncing infrastructure (50ms) - no manual debouncing needed
    - Leverage existing offline mode infrastructure - no custom dirty tracking needed
    - Follow AlgorithmViewRegistry pattern - widget is embedded in synchronized_screen
    - Use existing Slot data structure - do not create separate state for randomize settings
    - Mobile-first responsive design - full-screen dialog on mobile, centered on desktop
    - Theme-aware styling - use Theme.of(context) for colors and text styles
  </constraints>

  <interfaces>
    <interface>
      <name>DistingCubit.updateParameterValue</name>
      <kind>method</kind>
      <signature>Future&lt;void&gt; updateParameterValue(int slotIndex, int parameterNumber, dynamic value)</signature>
        <path>lib/cubit/disting_cubit.dart</path>
      </interface>
      <interface>
        <name>StepSequencerParams.fromSlot</name>
        <kind>factory</kind>
        <signature>StepSequencerParams.fromSlot(Slot slot)</signature>
        <path>lib/services/step_sequencer_params.dart</path>
      </interface>
      <interface>
        <name>PopupMenuButton</name>
        <kind>Flutter widget</kind>
        <signature>PopupMenuButton&lt;T&gt;({icon, itemBuilder, onSelected})</signature>
        <path>flutter/material</path>
      </interface>
      <interface>
        <name>showDialog</name>
        <kind>Flutter function</kind>
        <signature>Future&lt;T?&gt; showDialog({context, builder, barrierDismissible})</signature>
        <path>flutter/material</path>
      </interface>
    </interfaces>

  <tests>
    <standards>Unit tests for parameter discovery using test/services/step_sequencer_params_test.dart pattern. Widget tests for UI components following test/ui/ structure. Use mocktail for mocking DistingCubit. Integration tests verify full workflow (menu tap → parameter update sequence). Flutter test framework with bloc_test for cubit testing.</standards>
    <locations>test/services/step_sequencer_params_test.dart, test/ui/widgets/step_sequencer/, test/ui/step_sequencer_view_test.dart</locations>
    <ideas>
      - AC7: Test discovery of all 17 randomize parameters, test fallback naming patterns, test missing parameter handling returns null
      - AC1-AC2: Test overflow menu renders with two items (Randomize, Randomize Settings...), test icon rendering
      - AC3: Test randomize action triggers parameter sequence (value 1 → wait 100ms → value 0), verify cubit updateParameterValue calls
      - AC4-AC5: Test settings dialog renders all 17 parameters, test scrollable content, test parameter editors update values
      - AC8: Test responsive layout (mobile full-screen vs desktop centered), test dialog close behavior
      - AC9: Test offline mode - changes cached and synced on reconnect, test demo mode - mock randomization updates
      - Integration: Full workflow test - open menu, trigger randomize, verify parameter sequence, open settings, change parameter, verify hardware update
    </ideas>
  </tests>
</story-context>
