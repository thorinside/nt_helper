<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>7.7</storyId>
    <title>Add I/O Flags to Offline Metadata</title>
    <status>in-progress</status>
    <generatedAt>2025-11-18</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/7-7-add-io-flags-to-offline-metadata.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer maintaining the nt_helper offline metadata infrastructure</asA>
    <iWant>I/O flags stored in the offline database schema and included in JSON metadata export/import</iWant>
    <soThat>offline mode can provide I/O flag data without requiring live hardware connection</soThat>
    <tasks>
- Task 1: Update database schema (AC-1) - Add ioFlags column to Parameters table (nullable integer), position after powerOfTen field, update documentation, regenerate Drift code
- Task 2: Create database migration (AC-2) - Write migration to add ioFlags column, test on empty and populated databases, verify data preservation, document strategy
- Task 3: Update JSON export (AC-3) - Add ioFlags to parameter export, handle null values explicitly, increment version to 2, test export produces valid JSON
- Task 4: Update JSON import (AC-4) - Update _importParameters() in MetadataImportService, read ioFlags field, handle missing field and explicit null, validate flag range (0-15 or null)
- Task 5: Update metadata DAO (AC-5) - Add ioFlags to parameter queries, update getFullAlgorithmDetails() query, update parameter wrapper/model classes
- Task 6: Update offline mode (AC-6) - Modify OfflineDistingMidiManager to read ioFlags from DB, default null to 0, pass to ParameterInfo constructor
- Task 7: Verify mock mode (AC-7) - Confirm mock mode returns ioFlags = 0, no database dependency, document behavior
- Task 8: Test backwards compatibility (AC-8) - Test migration from old schema, import of old JSON format, export/import roundtrip, verify graceful degradation
- Task 9: Write unit tests (AC-9) - Test database migration, JSON export/import with ioFlags, import without ioFlags (old format), import with null, flag range validation, offline mode retrieval
- Task 10: Write integration tests (AC-10) - Test import old/new JSON formats, schema migration, export/import roundtrip
- Task 11: Update documentation (AC-11) - Update database schema docs, document export format v2, note bundled metadata lacks flags, add inline comments, update migration history
- Task 12: Add output mode usage persistence (AC-12) - Create ParameterOutputModeUsage table, export/import support, DAO methods, offline mode integration
- Task 13: Code quality validation (AC-13) - Run flutter analyze, run all tests, test migrations, verify import/export
    </tasks>
  </story>

  <acceptanceCriteria>
### AC-1: Database Schema Updates
1. Add `ioFlags` integer column to `Parameters` table in lib/db/tables.dart
2. Column is nullable with no default value (allows distinguishing "no data" from "all flags off")
3. Column appears after `powerOfTen` field (maintain logical grouping)
4. Update table documentation to describe `ioFlags` column purpose

### AC-2: Database Migration
5. Create database migration to add `ioFlags` column to existing databases
6. Migration handles databases with existing parameter data (preserves all existing data)
7. Existing parameters have `ioFlags = null` after migration (no data available)
8. Migration tested with databases at various schema versions
9. Migration rollback strategy documented (if needed)

### AC-3: JSON Export Implementation
10. Update metadata export to include `ioFlags` field in parameters
11. Export format: `"ioFlags": <int|null>` for each parameter entry
12. When `ioFlags` is null, export as `"ioFlags": null` (explicit null, not omitted)
13. Export preserves all existing fields (backwards compatible)
14. Update export version number to indicate schema change (version 2)

### AC-4: JSON Import Implementation
15. Update `MetadataImportService._importParameters()` to read `ioFlags` field
16. Handle missing `ioFlags` in old JSON files (treat as `null`, not error)
17. Handle `"ioFlags": null` explicitly (store as null in database)
18. Handle `"ioFlags": 0` through `"ioFlags": 15` (valid flag values)
19. Import validates flag values are in valid range (0-15 or null)

### AC-5: Metadata DAO Updates
20. Update `MetadataDao.getFullAlgorithmDetails()` to select `ioFlags` column
21. Update parameter queries to include `ioFlags` in SELECT statements
22. Update `ParameterEntry` wrapper class to expose `ioFlags` (if needed)
23. Verify queries work with both null and non-null `ioFlags` values

### AC-6: Offline Mode Integration
24. `OfflineDistingMidiManager` retrieves `ioFlags` from database when available
25. When `ioFlags` is null in database, return 0 (default: no flags set)
26. `ParameterInfo` constructed from database includes `ioFlags` value
27. Offline mode behavior matches online mode when metadata is available

### AC-7: Mock Mode Behavior
28. `MockDistingMidiManager` continues to return `ioFlags = 0` for all parameters
29. Mock mode doesn't require database (hardcoded mock data)
30. Document that mock mode has no I/O flag data

### AC-8: Backwards Compatibility
31. Old databases without `ioFlags` column work after migration
32. Old JSON files without `ioFlags` field import successfully (treat as null)
33. Export format remains compatible with import from older versions
34. New JSON files can be imported into older app versions (column ignored gracefully)

### AC-9: Unit Testing
35. Unit test verifies database migration adds `ioFlags` column
36. Unit test verifies JSON export includes `ioFlags` field
37. Unit test verifies JSON import reads `ioFlags` field correctly
38. Unit test verifies import handles missing `ioFlags` (old format)
39. Unit test verifies import handles `"ioFlags": null`
40. Unit test verifies import validates flag range (0-15 or null)
41. Unit test verifies offline mode retrieves `ioFlags` from database

### AC-10: Integration Testing
42. Integration test imports old JSON without `ioFlags` (no errors)
43. Integration test imports new JSON with `ioFlags` (data stored correctly)
44. Integration test verifies migration from old to new schema
45. Integration test exports and re-imports metadata (roundtrip)

### AC-11: Documentation
46. Update database schema documentation with `ioFlags` column
47. Document JSON export format version 2 changes
48. Document that bundled metadata still lacks I/O flags (Story 7.8)
49. Add inline code comments explaining null vs 0 distinction
50. Update migration documentation with schema version history

### AC-12: Output Mode Usage Persistence
55. Create new table `ParameterOutputModeUsage` to store output mode relationships
56. Columns: `algorithmGuid` (TEXT), `parameterNumber` (INTEGER), `affectedOutputNumbers` (TEXT - JSON array)
57. Composite primary key: `(algorithmGuid, parameterNumber)`
58. Migration creates table in same v10 migration (no separate v11 needed)
59. `MetadataSyncService` queries output mode usage for parameters with `isOutputMode` flag
60. Store output mode usage data in `ParameterOutputModeUsage` table during sync
61. `AlgorithmJsonExporter` exports `ParameterOutputModeUsage` table
62. Export version remains v2 (both ioFlags and outputModeUsage added together)
63. `MetadataImportService` imports `parameterOutputModeUsage` table
64. Import handles missing table (v1 format) gracefully
65. Create DAO method `getOutputModeUsage(algorithmGuid, parameterNumber)` → `List<int>`
66. `OfflineDistingMidiManager.requestOutputModeUsage()` reads from database
67. Unit tests for output mode usage table and DAO methods
68. Integration test for metadata sync collecting output mode usage
69. Integration test for export/import of output mode usage data

### AC-13: Code Quality
70. `flutter analyze` passes with zero warnings
71. All existing tests pass with no regressions
72. Database migrations execute successfully
73. JSON import/export roundtrip preserves all data (ioFlags + output mode usage)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epic-7-context.md" title="Epic 7 Technical Context" section="Offline Metadata Infrastructure">
        Details database schema (Parameters table currently at schema v9), JSON export/import format (currently v1), and the goal to add I/O flags to offline metadata. Describes the firmware changes (commit 71bf796) that added I/O flags in bits 2-5 of the last byte in parameter info SysEx messages. Documents the migration strategy and data flow for Stories 7.7-7.9.
      </doc>
      <doc path="docs/epic-7-context.md" title="Epic 7 Technical Context" section="Database Schema Migration">
        Documents the migration path from schema v9 to v10 with Drift migration strategy. Shows that ioFlags column should be added with ALTER TABLE, existing rows get ioFlags = null, and onUpgrade logic should check if (from &lt; 10) to add the column.
      </doc>
      <doc path="docs/epic-7-context.md" title="Epic 7 Technical Context" section="JSON Format Evolution">
        Documents JSON format version 1 (current, no ioFlags) and version 2 (with ioFlags field). Shows export format with exportVersion: 2 and parameters array including ioFlags. Explains import compatibility: v2 importer handles v1 format (missing ioFlags → null), v1 importer ignores ioFlags field.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Database Layer">
        Describes Drift ORM setup with current schema version 9 (now updating to 10), table definitions in lib/db/tables.dart, DAOs for metadata and presets, migration strategy in lib/db/database.dart using MigrationStrategy.onUpgrade.
      </doc>
      <doc path="docs/stories/7-3-add-io-flags-to-parameter-info.md" title="Story 7.3" section="Prerequisite Story">
        Story 7.3 adds ioFlags to ParameterInfo runtime model by extracting bits 2-5 from the last byte of parameter info SysEx responses. This story (7.7) extends that work to offline database schema and JSON metadata persistence.
      </doc>
      <doc path="docs/metadata-collection-process.md" title="Metadata Collection Process" section="Collection Workflow">
        Documents the process for collecting metadata from hardware, exporting to JSON, and bundling with the app. Story 7.8 will use this process to regenerate the bundled metadata with I/O flags included.
      </doc>
    </docs>
    <code>
      <artifact path="lib/db/tables.dart" kind="database_schema" symbol="Parameters" lines="42-65" reason="Defines Parameters table schema. Column ioFlags already added at line 61 (after rawUnitIndex). Need to verify position matches AC-1#3 requirement (after powerOfTen)."/>
      <artifact path="lib/db/database.dart" kind="database_core" symbol="AppDatabase" lines="46,60-100" reason="Contains schema version (currently 10 at line 46) and MigrationStrategy with onUpgrade logic. Migration for ioFlags should be at 'if (from &lt; 10)' to add column to v9 databases."/>
      <artifact path="lib/services/metadata_import_service.dart" kind="service" symbol="_importParameters" lines="152-200" reason="Imports parameters from JSON. Need to add ioFlags field reading with validation (0-15 or null), handling missing field for v1 format compatibility."/>
      <artifact path="lib/services/metadata_import_service.dart" kind="service" symbol="importFromJson" lines="25-61" reason="Top-level import coordinator. Handles exportType validation and table import ordering. May need to handle exportVersion field."/>
      <artifact path="lib/services/algorithm_json_exporter.dart" kind="service" symbol="exportFullMetadata" lines="105-250" reason="Exports full database metadata to JSON. Need to add ioFlags field to parameter export, set exportVersion: 2, and handle null values explicitly."/>
      <artifact path="lib/domain/offline_disting_midi_manager.dart" kind="domain" symbol="requestParameterInfo" lines="180-220" reason="Retrieves parameter data from database for offline mode. Need to read ioFlags from database and pass to ParameterInfo constructor, defaulting null to 0."/>
      <artifact path="lib/domain/offline_disting_midi_manager.dart" kind="domain" symbol="requestOutputModeUsage" lines="104-110" reason="Currently returns null for output mode usage in offline mode. AC-12 requires reading from ParameterOutputModeUsage table instead."/>
      <artifact path="lib/db/daos/metadata_dao.dart" kind="dao" symbol="MetadataDao" reason="Queries for algorithm and parameter metadata. Need to ensure all parameter queries include ioFlags column in SELECT statements."/>
      <artifact path="lib/domain/mock_disting_midi_manager.dart" kind="domain" symbol="MockDistingMidiManager" reason="Returns hardcoded mock data. AC-7 requires verification that mock mode returns ioFlags = 0 (default parameter value from Story 7.3)."/>
      <artifact path="lib/domain/disting_nt_sysex.dart" kind="model" symbol="ParameterInfo" reason="Runtime parameter info model with ioFlags field added in Story 7.3. Offline mode constructs this from database data."/>
    </code>
    <dependencies>
      <flutter>
        <package name="drift" version="^2.23.0" notes="ORM for database schema, migrations, and queries. Handles schema changes via MigrationStrategy."/>
        <package name="flutter_bloc" version="^9.1.1" notes="State management using Cubit pattern"/>
        <package name="flutter_lints" version="^5.0.0" notes="Linting rules - flutter analyze must pass with zero warnings"/>
      </flutter>
    </dependencies>
  </artifacts>

  <constraints>
    - Database schema version currently at v10 (bumped from v9 for ioFlags column)
    - Drift ORM manages schema changes via migrations - must add migration logic in MigrationStrategy.onUpgrade
    - Database migrations MUST preserve all existing data - existing parameters will have ioFlags = null after migration
    - JSON export format version must increment from 1 to 2 to indicate schema change (ioFlags + output mode usage)
    - Import MUST handle both old (v1, no ioFlags) and new (v2, with ioFlags) JSON formats for backwards compatibility
    - ioFlags values: null (no data) or 0-15 (4-bit flags) - validate during import
    - Null vs 0 distinction: null = no data available, 0 = flags explicitly set to zero (no input/output/audio/mode)
    - flutter analyze MUST pass with zero warnings before commit (zero tolerance policy)
    - This story provides infrastructure only - bundled metadata regeneration happens in Story 7.8
    - Offline mode will still have null ioFlags until Story 7.8 regenerates bundled metadata
    - AC-12 adds ParameterOutputModeUsage table in same v10 migration (no v11 needed)
    - Output mode usage stored as JSON array of integers in TEXT column
    - All test files follow naming pattern: test/**/*_test.dart
  </constraints>

  <interfaces>
    <interface name="Parameters Table Schema" kind="database_table" signature="Parameters(algorithmGuid, parameterNumber, name, minValue, maxValue, defaultValue, unitId, powerOfTen, rawUnitIndex, ioFlags)" path="lib/db/tables.dart">
      Column ioFlags already added at line 61. Verify position: AC-1#3 requires "after powerOfTen field" but current implementation has it after rawUnitIndex. Column definition: IntColumn get ioFlags => integer().nullable();
    </interface>
    <interface name="ParameterOutputModeUsage Table" kind="database_table" signature="ParameterOutputModeUsage(algorithmGuid, parameterNumber, affectedOutputNumbers)" path="lib/db/tables.dart">
      New table for AC-12. Columns: algorithmGuid (TEXT, FK to Algorithms), parameterNumber (INTEGER), affectedOutputNumbers (TEXT - JSON array of integers). Primary key: (algorithmGuid, parameterNumber).
    </interface>
    <interface name="Migration Strategy" kind="database_migration" signature="onUpgrade(Migrator m, int from, int to)" path="lib/db/database.dart">
      Current schema version: 10 (line 46). Migration logic needed: if (from &lt; 10) { await m.addColumn(parameters, parameters.ioFlags); await m.createTable(parameterOutputModeUsage); }
    </interface>
    <interface name="JSON Parameter Import" kind="json_import" signature="_importParameters(List&lt;dynamic&gt;? paramsList)" path="lib/services/metadata_import_service.dart">
      Add ioFlags field reading: int? ioFlags = paramData['ioFlags'] as int?; with range validation (0-15 or null). Handle missing field for v1 format (treat as null).
    </interface>
    <interface name="JSON Export Format v2" kind="json_export" signature="exportFullMetadata()" path="lib/services/algorithm_json_exporter.dart">
      Add exportVersion: 2 field, include ioFlags in parameter export, export ParameterOutputModeUsage table. Format: {"exportVersion": 2, "tables": {"parameters": [...], "parameterOutputModeUsage": [...]}}
    </interface>
    <interface name="ParameterInfo Construction" kind="domain_model" signature="ParameterInfo(..., ioFlags: int)" path="lib/domain/offline_disting_midi_manager.dart">
      In requestParameterInfo(), pass ioFlags from database to ParameterInfo constructor, default null to 0: ioFlags: dbParam.ioFlags ?? 0
    </interface>
    <interface name="Output Mode Usage Retrieval" kind="domain_method" signature="requestOutputModeUsage(int algorithmIndex, int parameterNumber)" path="lib/domain/offline_disting_midi_manager.dart">
      Currently returns null (line 109). AC-12#66 requires reading from ParameterOutputModeUsage table and returning OutputModeUsage object.
    </interface>
    <interface name="MetadataDao Query Methods" kind="dao" signature="getFullAlgorithmDetails(String guid)" path="lib/db/daos/metadata_dao.dart">
      Ensure parameter queries include ioFlags column. Drift auto-generates SELECT based on table schema, but verify any custom queries include ioFlags.
    </interface>
  </interfaces>

  <tests>
    <standards>
      Uses flutter test framework with package:test. Unit tests in test/ directory mirror lib/ structure. Integration tests use real database instances with AppDatabase.forTesting(). Mock implementations available for MIDI managers. Test conventions: descriptive test names, arrange-act-assert pattern, isolated test databases. Tests are run via flutter test command. All tests must pass before commit (AC-13#71).
    </standards>
    <locations>
      test/db/ - Database schema and migration tests (e.g., io_flags_migration_test.dart)
      test/services/ - Service layer tests including metadata import/export (e.g., io_flags_import_export_test.dart)
      test/domain/ - Domain model tests including offline MIDI manager (e.g., offline_disting_midi_manager_test.dart)
      test/integration/ - Integration tests for end-to-end scenarios (e.g., io_flags_integration_test.dart)
    </locations>
    <ideas>
      AC-9#35: Unit test in test/db/io_flags_migration_test.dart verifies migration adds ioFlags column
      AC-9#36: Unit test verifies AlgorithmJsonExporter emits ioFlags field in exported JSON
      AC-9#37: Unit test in test/services/io_flags_import_export_test.dart verifies JSON import reads ioFlags correctly
      AC-9#38: Unit test verifies import handles missing ioFlags (old v1 format) - treat as null, no error
      AC-9#39: Unit test verifies import handles explicit "ioFlags": null in JSON
      AC-9#40: Unit test verifies import validates ioFlags range (0-15 or null, reject/handle invalid values)
      AC-9#41: Unit test in test/domain/offline_disting_midi_manager_test.dart verifies offline mode retrieves ioFlags from database and defaults null to 0
      AC-10#42: Integration test in test/integration/io_flags_integration_test.dart imports old JSON format (v1) without ioFlags - no errors, data stored with null
      AC-10#43: Integration test imports new JSON format (v2) with ioFlags - data stored correctly in database
      AC-10#44: Integration test verifies migration from schema v9 to v10 - column added, existing data preserved, all ioFlags are null
      AC-10#45: Integration test exports database to JSON and re-imports - roundtrip preserves all fields including ioFlags
      AC-12#67: Unit tests for ParameterOutputModeUsage table creation, DAO methods, and import/export
      AC-12#68: Integration test for MetadataSyncService collecting output mode usage data
      AC-12#69: Integration test for export/import roundtrip of output mode usage data
    </ideas>
  </tests>
</story-context>
