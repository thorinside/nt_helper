<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <story id="e10-8-offline-mode-support">
    <title>Offline Mode Support for Step Sequencer</title>
    <epic>Epic 10 - Visual Step Sequencer UI Widget</epic>
    <status>in-progress</status>
    <created>2025-11-23</created>
  </story>

  <objective>
    Enable Step Sequencer widget to work seamlessly in offline mode with clear visual feedback when hardware is disconnected, leveraging existing offline infrastructure.
  </objective>

  <dependencies>
    <dependency status="done">e10-1-algorithm-widget-registration - Widget registration in AlgorithmViewRegistry</dependency>
    <dependency status="review">e10-2-step-grid-component - Visual step grid implementation</dependency>
    <dependency status="done">e10-3-step-selection-and-editing - Step editing modal</dependency>
    <dependency status="review">e10-4-scale-quantization - Quantize controls</dependency>
    <dependency status="ready-for-dev">e10-5-sequence-selector - Sequence selector widget</dependency>
    <dependency status="review">e10-6-playback-controls - Playback control widgets</dependency>
    <dependency status="drafted">e10-7-auto-sync-with-debouncing - Auto-sync with debouncing</dependency>
    <note>Story 8 is relatively independent as it primarily adds UI feedback for existing offline infrastructure. Can proceed but should ensure integration with other Step Sequencer components.</note>
  </dependencies>

  <architecture>
    <existing-infrastructure>
      <component name="OfflineDistingMidiManager">
        <file>lib/domain/offline_disting_midi_manager.dart</file>
        <description>Handles all offline mode operations: local state updates, dirty parameter tracking, reconnection sync</description>
        <capabilities>
          <capability>Updates local state immediately when hardware disconnected</capability>
          <capability>Tracks dirty parameters in Map&lt;String, dynamic&gt;</capability>
          <capability>No MIDI writes attempted offline</capability>
          <capability>Bulk sync on reconnect via syncDirtyParameters()</capability>
        </capabilities>
      </component>

      <component name="DistingCubit">
        <file>lib/cubit/disting_cubit.dart</file>
        <description>State management for all Disting hardware interactions</description>
        <connection-states>
          <state>connected - Live hardware connection</state>
          <state>offline - No hardware, local editing only</state>
          <state>mock - Demo mode with simulated hardware</state>
        </connection-states>
        <methods>
          <method name="updateParameterValue">Updates parameter and marks as dirty if offline</method>
          <method name="syncDirtyParameters">Bulk syncs all dirty params when reconnecting</method>
        </methods>
      </component>

      <component name="DistingState">
        <file>lib/cubit/disting_state.dart</file>
        <description>State variants for different connection modes</description>
        <states>
          <state name="synchronized">Connected to hardware, fully synced</state>
          <state name="offline">Disconnected, editing locally</state>
          <state name="loading">Connecting or loading data</state>
        </states>
      </component>
    </existing-infrastructure>

    <new-components>
      <component name="Offline Banner">
        <location>lib/ui/step_sequencer_view.dart</location>
        <description>Visual banner at top of Step Sequencer view showing offline status</description>
        <design>
          <color>Orange/amber background (Colors.orange.shade100)</color>
          <icon>cloud_off icon</icon>
          <text>"Offline - editing locally"</text>
          <dismissible>true (but reappears next session)</dismissible>
        </design>
      </component>

      <component name="Sync Indicator Offline State">
        <location>lib/ui/widgets/step_sequencer/sync_indicator.dart (or step_sequencer_view.dart)</location>
        <description>Extend existing sync indicator to show offline state</description>
        <states>
          <state name="synced" color="green">All changes synced to hardware</state>
          <state name="editing" color="orange">Local edits pending sync</state>
          <state name="syncing" color="blue">Currently syncing to hardware</state>
          <state name="error" color="red">Sync error occurred</state>
          <state name="offline" color="orange">Hardware disconnected</state>
        </states>
      </component>
    </new-components>
  </architecture>

  <implementation-guidance>
    <principle>Leverage existing offline infrastructure - minimal new code required</principle>
    <principle>UI feedback is primary goal - make offline state obvious</principle>
    <principle>All editing must work offline without restrictions</principle>
    <principle>Reconnection flow should be seamless and clear</principle>

    <file-modifications>
      <file path="lib/ui/step_sequencer_view.dart">
        <change type="add">Offline banner widget at top when state is offline</change>
        <change type="add">BlocBuilder to monitor connection status</change>
        <change type="modify">Layout to accommodate banner (Column with banner + existing content)</change>
        <code-pattern>
          BlocBuilder&lt;DistingCubit, DistingState&gt;(
            builder: (context, state) {
              final isOffline = state.maybeWhen(
                offline: (_) => true,
                orElse: () => false,
              );

              return Column(
                children: [
                  if (isOffline) _buildOfflineBanner(),
                  Expanded(child: _buildStepSequencerContent()),
                ],
              );
            },
          )
        </code-pattern>
      </file>

      <file path="lib/ui/widgets/step_sequencer/sync_indicator.dart (or inline in step_sequencer_view.dart)">
        <change type="add">Offline state to sync indicator</change>
        <change type="modify">Color and label logic to handle offline</change>
        <code-pattern>
          Color _getSyncStatusColor(DistingState state) {
            return state.maybeWhen(
              synchronized: (_,__,___,____,_____,______) => Colors.green,
              offline: (_) => Colors.orange,
              orElse: () => Colors.grey,
            );
          }

          String _getSyncStatusLabel(DistingState state) {
            return state.maybeWhen(
              synchronized: (_,__,___,____,_____,______) => 'Synced',
              offline: (_) => 'Offline',
              orElse: () => 'Unknown',
            );
          }
        </code-pattern>
      </file>
    </file-modifications>

    <testing-approach>
      <manual-test>
        <step>1. Disconnect hardware or switch to Mock/Offline mode</step>
        <step>2. Navigate to Step Sequencer algorithm</step>
        <step>3. Verify "Offline - editing locally" banner appears</step>
        <step>4. Verify sync indicator shows "Offline" with orange color</step>
        <step>5. Edit multiple step parameters (pitch, velocity, etc.)</step>
        <step>6. Verify edits work without errors</step>
        <step>7. Verify local state updates immediately (no lag)</step>
        <step>8. Reconnect hardware or switch to Live mode</step>
        <step>9. Verify reconnection prompt appears (if DistingCubit supports this)</step>
        <step>10. Verify sync completes and parameters match hardware</step>
      </manual-test>

      <widget-test file="test/ui/step_sequencer_view_test.dart">
        <test name="shows offline banner when disconnected">
          Mock DistingCubit to return offline state, pump StepSequencerView, verify banner text and icon
        </test>
        <test name="hides offline banner when connected">
          Mock DistingCubit to return synchronized state, pump StepSequencerView, verify banner not present
        </test>
        <test name="sync indicator shows offline state">
          Mock offline state, verify sync indicator color is orange and text is "Offline"
        </test>
      </widget-test>
    </testing-approach>
  </implementation-guidance>

  <acceptance-criteria>
    <criterion id="AC8.1">
      <description>When offline: "Offline - editing locally" banner shown at top of Step Sequencer view</description>
      <verification>
        - Banner appears when DistingState is offline
        - Banner uses orange/amber color scheme
        - Banner shows cloud_off icon
        - Banner text is clear and concise
        - Banner is dismissible with X button
      </verification>
    </criterion>

    <criterion id="AC8.2">
      <description>All editing works normally (no restrictions)</description>
      <verification>
        - Step editing modal opens and saves changes
        - Quantize controls work (UI-only, no hardware)
        - Playback controls update local state
        - Sequence selector works
        - No error dialogs or exceptions
      </verification>
    </criterion>

    <criterion id="AC8.3">
      <description>Changes tracked in dirty params map</description>
      <verification>
        - Verify DistingCubit.updateParameterValue called for each edit
        - Verify parameters marked as dirty (debug inspection or logging)
        - No MIDI write attempts when offline
        - Local state reflects edits immediately
      </verification>
    </criterion>

    <criterion id="AC8.4">
      <description>When hardware reconnects → "Sync X changes?" prompt</description>
      <verification>
        - Use existing DistingCubit reconnection logic
        - Prompt shows count of dirty parameters
        - User can review or cancel sync
      </verification>
      <note>This may already be handled by DistingCubit - verify existing behavior</note>
    </criterion>

    <criterion id="AC8.5">
      <description>User confirms → bulk sync all dirty params</description>
      <verification>
        - Uses DistingCubit.syncDirtyParameters()
        - Parameters sync to hardware
        - Sync completes without errors
        - Hardware values match local state
      </verification>
    </criterion>

    <criterion id="AC8.6">
      <description>Progress indicator during bulk sync</description>
      <verification>
        - Shows "Syncing..." message or progress bar
        - Updates progress as params sync
        - Shows completion: "All changes synced"
      </verification>
      <note>This may already exist in DistingCubit - verify and use if available</note>
    </criterion>
  </acceptance-criteria>

  <relevant-files>
    <core-files>
      <file path="lib/ui/step_sequencer_view.dart">
        <purpose>Main Step Sequencer widget - add offline banner here</purpose>
        <key-sections>
          <section>BlocBuilder for DistingState</section>
          <section>Main layout Column/Expanded structure</section>
        </key-sections>
      </file>

      <file path="lib/cubit/disting_cubit.dart">
        <purpose>State management - provides offline state and sync methods</purpose>
        <key-methods>
          <method>updateParameterValue - marks params dirty when offline</method>
          <method>syncDirtyParameters - bulk sync on reconnect</method>
        </key-methods>
      </file>

      <file path="lib/cubit/disting_state.dart">
        <purpose>State definitions - offline state variant</purpose>
        <key-states>
          <state>synchronized - connected and synced</state>
          <state>offline - disconnected, local editing</state>
        </key-states>
      </file>

      <file path="lib/domain/offline_disting_midi_manager.dart">
        <purpose>Offline mode implementation - understand how it works</purpose>
        <key-features>
          <feature>Local state updates</feature>
          <feature>Dirty parameter tracking</feature>
          <feature>No MIDI writes offline</feature>
        </key-features>
      </file>
    </core-files>

    <reference-files>
      <file path="docs/epics/epic-step-sequencer-ui.md">Epic definition with all 8 stories</file>
      <file path="docs/epics/epic-step-sequencer-ui-technical-context.md">Technical architecture and patterns</file>
      <file path="lib/ui/notes_algorithm_view.dart">Reference for algorithm widget pattern</file>
      <file path="lib/ui/algorithm_registry.dart">Widget registration system</file>
    </reference-files>

    <test-files>
      <file path="test/ui/step_sequencer_view_test.dart" status="to-create">Widget tests for offline banner</file>
      <file path="test/cubit/disting_cubit_test.dart" status="exists">May need to verify offline behavior</file>
    </test-files>
  </relevant-files>

  <risks-and-mitigations>
    <risk severity="low">
      <description>Offline banner may overlap with existing UI elements</description>
      <mitigation>Use Column layout with banner at top, existing content in Expanded below</mitigation>
    </risk>

    <risk severity="low">
      <description>Dependencies on incomplete stories (2, 4, 5, 6, 7 not done)</description>
      <mitigation>Focus on adding offline UI feedback to existing StepSequencerView structure. If widget doesn't exist yet, create minimal version or wait for dependencies.</mitigation>
    </risk>

    <risk severity="low">
      <description>Reconnection sync may already be implemented at app level</description>
      <mitigation>Research existing reconnection flow in DistingCubit before implementing. Reuse if exists.</mitigation>
    </risk>
  </risks-and-mitigations>

  <success-metrics>
    <metric>Offline banner displays correctly when hardware disconnected</metric>
    <metric>All Step Sequencer edits work offline without errors</metric>
    <metric>Sync indicator shows offline state visually</metric>
    <metric>Reconnection sync works (if not already implemented globally)</metric>
    <metric>Zero flutter analyze warnings</metric>
    <metric>All tests pass</metric>
  </success-metrics>

  <notes>
    <note>This is the final story (8 of 8) in Epic 10</note>
    <note>Estimated 2 hours - minimal new code due to existing offline infrastructure</note>
    <note>Primary work is UI feedback, not infrastructure changes</note>
    <note>May need to coordinate with Stories 2-7 if they're incomplete</note>
    <note>Check if StepSequencerView widget exists before modifying</note>
  </notes>
</story-context>
