<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>9</epicId>
    <storyId>2</storyId>
    <title>Bottom Sheet Component Implementation</title>
    <status>drafted</status>
    <generatedAt>2025-11-16</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/9-2-bottom-sheet-component-implementation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a mobile user tapping "View Options"</asA>
    <iWant>to see clearly labeled display mode choices in a bottom sheet</iWant>
    <soThat>I can easily select the hardware display mode I need without squinting at tiny icons</soThat>
    <tasks>
- Task 1: Create bottom sheet method (AC: 1-2)
  - Add `_showDisplayModeBottomSheet(BuildContext context)` method to `_SynchronizedScreenState`
  - Use `showModalBottomSheet()` from Material
  - Return `showModalBottomSheet<void>`

- Task 2: Implement bottom sheet structure (AC: 3-6)
  - Wrap content in `SafeArea` widget
  - Use `Column` with `mainAxisSize: MainAxisSize.min`
  - Add handle indicator widget (Container: 40x4, gray, rounded)
  - Add header widget with "Hardware Display Mode" text
  - Add 4 ListTile widgets for options

- Task 3: Create bottom sheet header helper (AC: 4-5)
  - Add `_buildBottomSheetHeader()` method
  - Return Padding widget with handle + text
  - Handle: 40px wide, 4px tall, Colors.grey[300], rounded 2px
  - Text: "Hardware Display Mode", size 16, weight 600
  - Padding: 16px all around, 12px between handle and text

- Task 4: Create bottom sheet option helper (AC: 7-14)
  - Add `_buildDisplayModeOption()` method with parameters: BuildContext context, IconData icon, String title, String subtitle, DisplayMode mode
  - Return ListTile with icon, title, subtitle
  - Set contentPadding: horizontal 24px, vertical 8px
  - In onTap: call Navigator.pop(context) then setDisplayMode(mode)

- Task 5: Add 4 display mode options (AC: 7-10)
  - Option 1: Parameter View (Icons.list_alt_rounded, "Hardware parameter list", DisplayMode.parameters)
  - Option 2: Algorithm UI (Icons.line_axis_rounded, "Custom algorithm interface", DisplayMode.algorithmUI)
  - Option 3: Overview UI (Icons.line_weight_rounded, "All slots overview", DisplayMode.overview)
  - Option 4: Overview VU Meters (Icons.leaderboard_rounded, "VU meter display", DisplayMode.overviewVUs)

- Task 6: Wire up "View Options" button (AC: 23)
  - Update Story 9.1's placeholder `onPressed: () {}`
  - Change to `onPressed: () => _showDisplayModeBottomSheet(context)`

- Task 7: Verify Material default behaviors (AC: 15-21)
  - Test tapping outside dismisses (no code needed, Material default)
  - Test swiping down dismisses (no code needed, Material default)
  - Test Android back button dismisses (no code needed, Material default)
  - Verify slide-up animation (Material default)
  - Verify background scrim (Material default)
  - Verify ripple effects on options (Material default)

- Task 8: Verify touch targets (AC: 22)
  - Measure ListTile height (should be 56px+ by default)
  - Test on device with layout bounds enabled

- Task 9: Manual testing (AC: 24-27)
  - Test on iOS simulator
  - Test on Android emulator
  - Test on macOS (verify desktop unchanged)

- Task 10: Edge case testing (AC: 28-29)
  - Rapid tap "View Options" multiple times
  - Open sheet, switch to offline mode (verify no crash)
  - Open sheet, disconnect hardware (verify graceful handling)

- Task 11: Code quality (AC: 30)
  - Run `flutter analyze`
  - Fix any warnings or errors
    </tasks>
  </story>

  <acceptanceCriteria>
1. Method `_showDisplayModeBottomSheet(BuildContext context)` created in `_SynchronizedScreenState`
2. Uses `showModalBottomSheet()` from Material framework
3. Bottom sheet wrapped in SafeArea for notch/home indicator safety
4. Bottom sheet has visual handle indicator at top (40px wide, 4px tall, gray, centered)
5. Bottom sheet has header text "Hardware Display Mode" (16px, weight 600, padding 16px)
6. Bottom sheet contains 4 options using ListTile widget
7. Option 1: Parameter View - icon `Icons.list_alt_rounded`, subtitle "Hardware parameter list"
8. Option 2: Algorithm UI - icon `Icons.line_axis_rounded`, subtitle "Custom algorithm interface"
9. Option 3: Overview UI - icon `Icons.line_weight_rounded`, subtitle "All slots overview"
10. Option 4: Overview VU Meters - icon `Icons.leaderboard_rounded`, subtitle "VU meter display"
11. Each option has leading icon, title text, and subtitle text
12. Options have horizontal padding 24px, vertical padding 8px
13. Each option's `onTap` calls `context.read<DistingCubit>().setDisplayMode(mode)` with correct mode
14. Each option's `onTap` calls `Navigator.pop(context)` to auto-dismiss sheet
15. Display mode changes propagate to hardware correctly (same behavior as desktop buttons)
16. Tapping outside bottom sheet dismisses it (Material default behavior)
17. Swiping down dismisses bottom sheet (Material default behavior)
18. Android back button dismisses bottom sheet (Material default behavior)
19. Bottom sheet animates smoothly with slide-up animation (Material default)
20. Background dims when bottom sheet opens (Material default scrim)
21. Option tiles show visual feedback on tap (Material ripple effect)
22. Options meet minimum 56px touch target height
23. "View Options" button `onPressed` now calls `_showDisplayModeBottomSheet(context)`
24. No errors in debug console when opening/closing bottom sheet
25. Manual test on iOS simulator: sheet opens, options work, auto-dismisses
26. Manual test on Android emulator: sheet opens, options work, back button dismisses
27. Manual test on desktop: verify 4 buttons still visible (sheet not used)
28. Edge case: rapid tapping "View Options" doesn't cause crashes
29. Edge case: opening sheet then switching to offline mode doesn't crash
30. `flutter analyze` passes with zero warnings
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/mobile-bottom-bar-epic.md</path>
        <title>Epic 9: Mobile Bottom Bar Optimization</title>
        <section>Story 2: Bottom Sheet Component Implementation</section>
        <snippet>Implement modal bottom sheet with 4 display mode options (Parameter View, Algorithm UI, Overview UI, Overview VU Meters) that replaces desktop 4-button layout on mobile platforms. Bottom sheet should use Material 3 ListTile components with icons and subtitles.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>nt_helper UX Design Specification</title>
        <section>Bottom Sheet Interaction Design</section>
        <snippet>Modal bottom sheet triggered by "View Options" button. Two-tap interaction: tap button, tap mode. Auto-dismisses after selection. Uses Material 3 bottom sheet with SafeArea wrapper.</snippet>
      </doc>
      <doc>
        <path>docs/mobile-bottom-bar-prd.md</path>
        <title>Mobile Bottom Bar Optimization - Product Requirements Document</title>
        <section>FR4: Bottom Sheet Component</section>
        <snippet>Bottom sheet must contain header "Hardware Display Mode" and 4 ListTile options. Each option calls setDisplayMode() and auto-dismisses. Must be dismissible via swipe-down or tap outside.</snippet>
      </doc>
      <doc>
        <path>docs/stories/9-1-platform-detection-and-conditional-layout.md</path>
        <title>Story 9.1: Platform Detection and Conditional Layout</title>
        <section>Implementation</section>
        <snippet>Story 9.1 implemented platform detection using PlatformInteractionService.isMobilePlatform(). Mobile layout renders single "View Options" button with placeholder onPressed handler awaiting Story 9.2 implementation.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>lib/ui/synchronized_screen.dart</path>
        <kind>widget</kind>
        <symbol>_SynchronizedScreenState</symbol>
        <lines>79-657</lines>
        <reason>Main implementation file. Contains _buildBottomAppBar() method with Story 9.1 placeholder button at line 580 that needs bottom sheet wiring. All three new methods will be added to this class.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/synchronized_screen.dart</path>
        <kind>method</kind>
        <symbol>_buildBottomAppBar</symbol>
        <lines>512-657</lines>
        <reason>Contains platform-conditional layout with placeholder "View Options" button (line 577-583) that needs onPressed implementation to call _showDisplayModeBottomSheet(context).</reason>
      </artifact>
      <artifact>
        <path>lib/cubit/disting_cubit.dart</path>
        <kind>cubit</kind>
        <symbol>setDisplayMode</symbol>
        <lines>2085</lines>
        <reason>Existing method that changes hardware display mode. Bottom sheet options must call context.read&lt;DistingCubit&gt;().setDisplayMode(mode) to maintain same behavior as desktop buttons.</reason>
      </artifact>
      <artifact>
        <path>lib/core/platform/platform_interaction_service.dart</path>
        <kind>service</kind>
        <symbol>PlatformInteractionService</symbol>
        <reason>Already used in _buildBottomAppBar() for platform detection. No changes needed, but context reference for understanding platform-conditional logic.</reason>
      </artifact>
      <artifact>
        <path>test/ui/synchronized_screen_bottom_bar_test.dart</path>
        <kind>test</kind>
        <symbol>synchronized_screen_bottom_bar_test</symbol>
        <lines>1-80</lines>
        <reason>Existing test file for bottom bar platform detection (Story 9.1). Tests use MockDistingCubit, MockPlatformInteractionService. Pattern to follow for testing bottom sheet behavior.</reason>
      </artifact>
    </code>
    <dependencies>
      <flutter>
        <package>flutter</package>
        <version>sdk</version>
        <usage>Material 3 framework - showModalBottomSheet, SafeArea, ListTile, Icons</usage>
      </flutter>
      <flutter_bloc>
        <package>flutter_bloc</package>
        <version>^9.1.1</version>
        <usage>context.read&lt;DistingCubit&gt;() for setDisplayMode calls</usage>
      </flutter_bloc>
      <haptic_feedback>
        <package>haptic_feedback</package>
        <version>^0.6.0</version>
        <usage>Already in dependencies - optional for Story 9.3 accessibility enhancements</usage>
      </haptic_feedback>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Single file modification: lib/ui/synchronized_screen.dart only</constraint>
    <constraint>Three new private methods added to _SynchronizedScreenState class: _showDisplayModeBottomSheet, _buildDisplayModeOption, _buildBottomSheetHeader</constraint>
    <constraint>No new imports required - all Material widgets and DistingCubit already imported</constraint>
    <constraint>Must wire up Story 9.1 placeholder button onPressed at line 580</constraint>
    <constraint>Must use exact same DisplayMode enum values and setDisplayMode() method as desktop buttons for hardware compatibility</constraint>
    <constraint>Must maintain existing desktop behavior - no changes to 4-button desktop layout (lines 584-623)</constraint>
    <constraint>Must use Material 3 defaults: auto-dismiss gestures, slide-up animation, background scrim, ripple effects</constraint>
    <constraint>ListTile must meet 56px minimum height for touch targets (Material default)</constraint>
    <constraint>Code must pass flutter analyze with zero warnings</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>DisplayMode enum</name>
      <kind>enum</kind>
      <signature>enum DisplayMode { parameters(0), algorithmUI(1), overview(2), overviewVUs(3) }</signature>
      <path>lib/domain/disting_nt_sysex.dart</path>
    </interface>
    <interface>
      <name>DistingCubit.setDisplayMode</name>
      <kind>cubit method</kind>
      <signature>void setDisplayMode(DisplayMode displayMode)</signature>
      <path>lib/cubit/disting_cubit.dart</path>
    </interface>
    <interface>
      <name>showModalBottomSheet</name>
      <kind>Material framework function</kind>
      <signature>Future&lt;T?&gt; showModalBottomSheet&lt;T&gt;({required BuildContext context, required WidgetBuilder builder})</signature>
      <path>flutter/material</path>
    </interface>
    <interface>
      <name>Navigator.pop</name>
      <kind>Material framework function</kind>
      <signature>void pop&lt;T&gt;(BuildContext context, [T? result])</signature>
      <path>flutter/widgets</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Flutter widget testing using flutter_test package. Mock DistingCubit and PlatformInteractionService using mocktail. Test pattern: createTestWidget helper returns MaterialApp with BlocProvider. Verify widget tree contains expected widgets using find.byType, find.byIcon, find.text. Manual testing on iOS simulator, Android emulator, macOS desktop required per AC 25-27.</standards>
    <locations>test/ui/synchronized_screen_bottom_bar_test.dart</locations>
    <ideas>
      <idea ac="1-2">Widget test: Verify _showDisplayModeBottomSheet method exists and returns bottom sheet with SafeArea wrapper</idea>
      <idea ac="3-5">Widget test: Find SafeArea, Column, handle Container (40x4), header Text "Hardware Display Mode"</idea>
      <idea ac="6-14">Widget test: Find 4 ListTile widgets with correct icons, titles, subtitles, and onTap behavior calling setDisplayMode</idea>
      <idea ac="15">Integration test: Mock setDisplayMode, tap option, verify method called with correct DisplayMode value</idea>
      <idea ac="16-21">Manual test only: Material default behaviors (tap outside, swipe, back button, animation, scrim, ripple)</idea>
      <idea ac="22">Widget test: Measure ListTile constraints, verify minHeight >= 56</idea>
      <idea ac="23">Widget test: Find "View Options" IconButton, verify onPressed is not empty/null</idea>
      <idea ac="24-29">Manual testing required: iOS simulator, Android emulator, desktop, edge cases</idea>
      <idea ac="30">CI check: flutter analyze must pass</idea>
    </ideas>
  </tests>
</story-context>
