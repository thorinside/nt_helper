<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>8</storyId>
    <title>Generate Updated Metadata Bundle with I/O Flags</title>
    <status>blocked</status>
    <generatedAt>2025-11-18</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/Users/nealsanche/nosuch/nt_helper/docs/stories/7-8-generate-updated-metadata-bundle-with-io-flags.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer maintaining the nt_helper bundled metadata</asA>
    <iWant>to regenerate `assets/metadata/full_metadata.json` with I/O flag data from live hardware</iWant>
    <soThat>offline mode has access to I/O flags without requiring users to connect to hardware</soThat>
    <tasks>
      - Task 1: Prepare hardware and environment (AC-1)
        - Verify hardware has latest firmware
        - Establish stable MIDI connection
        - Verify all factory algorithms available
        - Allocate time for metadata collection (~30-60 min)

      - Task 2: Create/update collection script (AC-2)
        - Write or locate existing metadata collection tool
        - Implement algorithm iteration logic
        - Implement parameter info querying
        - Implement I/O flag extraction from responses
        - Store data in structured format

      - Task 3: Collect metadata from hardware (AC-2, AC-3)
        - Run collection script against hardware
        - Monitor progress and handle any failures
        - Validate all algorithms collected
        - Verify flag data completeness
        - Spot-check known algorithms

      - Task 4: Generate JSON export (AC-4)
        - Export collected data to JSON v2 format
        - Include all required tables
        - Verify ioFlags present for all params
        - Validate JSON structure
        - Check file size is reasonable

      - Task 5: Update bundled metadata (AC-5)
        - Replace `assets/metadata/full_metadata.json`
        - Test app loads new metadata
        - Verify offline mode has I/O flags
        - Test fresh install scenario
        - Verify no data corruption

      - Task 6: Test backwards compatibility (AC-6)
        - Confirm old apps ignore new field
        - Confirm new app imports old format
        - Document metadata version

      - Task 7: Document process (AC-7)
        - Document collection process
        - Document hardware requirements
        - Document verification steps
        - Update changelog/release notes

      - Task 8: Final validation (AC-8)
        - Verify script is documented
        - Validate JSON file
        - Run flutter analyze
        - Test app with new metadata
    </tasks>
  </story>

  <acceptanceCriteria>
    AC-1: Hardware Connection Setup
    - Access to distingNT hardware with latest firmware (supports I/O flags)
    - Hardware has all factory algorithms available
    - MIDI connection stable and reliable
    - Sufficient time allocated for querying all algorithms (potentially long-running)

    AC-2: Metadata Collection Script
    - Create or update metadata collection script/tool
    - Script connects to hardware via MIDI
    - Script iterates through all factory algorithms
    - For each algorithm: Load algorithm into slot, Request all parameter info (SysEx 0x43), Collect I/O flags from responses, Store parameter metadata with I/O flags

    AC-3: Data Validation
    - Verify all factory algorithms queried successfully
    - Verify no algorithms skipped or failed
    - Verify I/O flags present for all parameters
    - Validate flag values are in valid range (0-15)
    - Cross-reference with known algorithm list (completeness check)
    - Spot-check known algorithms for expected flag values

    AC-4: JSON Export Generation
    - Export collected metadata to JSON using updated export format (v2)
    - Include all required tables: units, algorithms, parameters, enums, pages
    - Include `ioFlags` field for all parameters
    - Verify JSON is valid and well-formed
    - Verify export version is 2 (indicates I/O flags present)
    - Verify file size is reasonable (should be similar to old version)

    AC-5: Bundle Update
    - Replace `assets/metadata/full_metadata.json` with new version
    - Verify new file loads successfully in app
    - Verify offline mode has I/O flags after loading new metadata
    - Test import with new bundled metadata on fresh install
    - Verify no data loss or corruption

    AC-6: Backwards Compatibility
    - Old app versions ignore `ioFlags` field gracefully (tested in Story 7.7)
    - New app can still import old metadata (null flags, tested in Story 7.7)
    - Document metadata version in export file (v2)

    AC-7: Documentation
    - Document metadata collection process for future updates
    - Document hardware setup requirements
    - Document export verification steps
    - Add metadata generation date to JSON file
    - Update CHANGELOG or release notes about new metadata

    AC-8: Code Quality
    - Metadata collection script is repeatable and documented
    - JSON file passes validation (well-formed JSON)
    - No `flutter analyze` warnings related to bundled asset
    - App loads and uses new metadata successfully
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/metadata-collection-process.md" title="Metadata Collection Process" section="Complete Guide">
        Detailed step-by-step process for collecting factory algorithm metadata from hardware and generating updated bundled metadata file with I/O flags. Includes prerequisites, sync process, export steps, validation, and testing procedures.
      </doc>
      <doc path="docs/epic-7-context.md" title="Epic 7 Technical Context" section="SysEx Updates & I/O Metadata">
        Technical context for Epic 7 covering I/O flags extraction from firmware, routing framework architecture, offline metadata infrastructure, and transition from pattern matching to hardware-provided data.
      </doc>
      <doc path="docs/stories/7-7-add-io-flags-to-offline-metadata.md" title="Story 7.7" section="Database & JSON Infrastructure">
        Infrastructure story that added ioFlags column to Parameters table, updated JSON export/import to include ioFlags field, and established export version 2 format. Provides foundation for this story's metadata collection.
      </doc>
      <doc path="docs/stories/7-3-add-io-flags-to-parameter-info.md" title="Story 7.3" section="Runtime I/O Flags">
        Adds I/O flags to runtime ParameterInfo model from SysEx 0x43 responses. Hardware connection must support I/O flags for metadata collection to succeed.
      </doc>
    </docs>
    <code>
      <artifact path="lib/services/algorithm_json_exporter.dart" kind="service" symbol="AlgorithmJsonExporter" reason="Exports all metadata tables to JSON v2 format with ioFlags field. exportFullMetadata() method generates bundled metadata file.">
        <interface>Future&lt;void&gt; exportFullMetadata(String filePath)</interface>
        <interface>Future&lt;Map&lt;String, dynamic&gt;&gt; getFullExportPreview()</interface>
        <note>Debug-only methods (kDebugMode check). Export version 2 includes ioFlags in parameters table.</note>
      </artifact>
      <artifact path="lib/services/metadata_sync_service.dart" kind="service" symbol="MetadataSyncService" reason="Synchronizes algorithm metadata from hardware to database. Used to collect complete metadata with I/O flags from device.">
        <interface>Future&lt;void&gt; syncAllAlgorithmMetadata({onProgress, onError, onContinueRequired, onCheckpoint, resumeFromIndex, isCancelled})</interface>
        <note>Progress reporting, error handling, checkpoint support, and cancellation support for long-running sync operations.</note>
      </artifact>
      <artifact path="lib/services/metadata_import_service.dart" kind="service" symbol="MetadataImportService" reason="Imports metadata from JSON files. Validates imported data including ioFlags field. Used to verify bundled metadata loads correctly.">
        <interface>Future&lt;void&gt; importFromJson(String jsonPath)</interface>
        <note>Handles backward compatibility for old JSON files without ioFlags field.</note>
      </artifact>
      <artifact path="lib/ui/widgets/debug_metadata_export_dialog.dart" kind="ui" symbol="DebugMetadataExportDialog" reason="UI dialog for debug metadata export. Provides preview and file selection for metadata export process.">
        <note>Debug-only widget for triggering exportFullMetadata(). Accessible from Offline Data screen three-dot menu.</note>
      </artifact>
      <artifact path="lib/ui/metadata_sync/metadata_sync_page.dart" kind="ui" symbol="MetadataSyncPage" reason="UI screen for syncing algorithm metadata from hardware. Entry point for metadata collection workflow.">
        <note>Shows progress, allows cancellation, handles errors, and displays sync results.</note>
      </artifact>
      <artifact path="assets/metadata/full_metadata.json" kind="asset" symbol="Bundled Metadata" reason="Current bundled metadata file (v1 format without ioFlags). Will be replaced with v2 version containing I/O flags.">
        <note>File to be backed up and replaced. Asset loaded on first app launch to populate offline database.</note>
      </artifact>
    </code>
    <dependencies>
      <flutter>
        <package name="drift" purpose="Database ORM for metadata storage and querying"/>
        <package name="flutter_midi_command" purpose="MIDI communication with Disting NT hardware"/>
        <package name="shared_preferences" purpose="App settings and state persistence"/>
      </flutter>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="hardware">Hardware must have latest firmware supporting I/O flags in SysEx 0x43 parameter info responses.</constraint>
    <constraint type="time">Metadata collection is long-running (30-60 minutes for ~100 factory algorithms). Requires stable MIDI connection throughout.</constraint>
    <constraint type="mode">Metadata export is debug-only (kDebugMode check). Must run app in debug configuration.</constraint>
    <constraint type="asset">Bundled metadata file is loaded as Flutter asset. Changes require app rebuild to take effect.</constraint>
    <constraint type="compatibility">Export v2 format must remain backward compatible - old apps should ignore ioFlags field gracefully.</constraint>
    <constraint type="testing">Fresh install testing requires clearing app database to force metadata import from bundled file.</constraint>
    <constraint type="validation">All factory algorithms must be collected successfully. No skipped or failed algorithms allowed.</constraint>
  </constraints>

  <interfaces>
    <interface name="AlgorithmJsonExporter.exportFullMetadata" kind="service method">
      <signature>Future&lt;void&gt; exportFullMetadata(String filePath) async</signature>
      <description>Exports all metadata tables to JSON v2 format with ioFlags. Debug-only method.</description>
      <parameters>filePath: Absolute path where JSON file should be written</parameters>
      <returns>Future that completes when export finishes or throws on error</returns>
      <path>lib/services/algorithm_json_exporter.dart</path>
    </interface>
    <interface name="MetadataSyncService.syncAllAlgorithmMetadata" kind="service method">
      <signature>Future&lt;void&gt; syncAllAlgorithmMetadata({onProgress, onError, onContinueRequired, onCheckpoint, resumeFromIndex, isCancelled})</signature>
      <description>Syncs all algorithm metadata from connected hardware to database with I/O flags</description>
      <parameters>Progress callbacks, error handling, checkpoint support, resumption, cancellation</parameters>
      <returns>Future that completes when all algorithms synced or error occurs</returns>
      <path>lib/services/metadata_sync_service.dart</path>
    </interface>
    <interface name="DebugMetadataExportDialog" kind="Flutter widget">
      <signature>DebugMetadataExportDialog({Key? key})</signature>
      <description>Debug-only UI for previewing and exporting full metadata to JSON file</description>
      <usage>Accessed from Offline Data screen three-dot menu in debug builds</usage>
      <path>lib/ui/widgets/debug_metadata_export_dialog.dart</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing uses Flutter test framework with unit tests and integration tests. Metadata services have dedicated test coverage. Integration tests verify end-to-end workflows including database migrations and import/export. Mock mode provides deterministic testing without hardware. Tests should verify JSON structure, database schema compatibility, and backward compatibility.
    </standards>
    <locations>
      test/services/metadata_sync_service_test.dart
      test/services/metadata_import_service_test.dart
      test/services/io_flags_import_export_test.dart
      test/integration/metadata_upgrade_integration_test.dart
      test/integration/io_flags_integration_test.dart
    </locations>
    <ideas>
      <test-idea ac="AC-3, AC-4">Validate exported JSON structure has exportVersion=2 and all parameters have ioFlags field (unit test)</test-idea>
      <test-idea ac="AC-5">Test fresh install scenario - clear database, load bundled metadata, verify ioFlags present in offline mode (integration test)</test-idea>
      <test-idea ac="AC-6">Verify backward compatibility - old JSON imports successfully with ioFlags treated as null (unit test)</test-idea>
      <test-idea ac="AC-3">Spot-check known algorithms (clck, pycv, eucl) for expected ioFlags values after import (integration test)</test-idea>
      <test-idea ac="AC-8">Run flutter analyze on project after bundled metadata replacement to verify no warnings (validation test)</test-idea>
    </ideas>
  </tests>
</story-context>
