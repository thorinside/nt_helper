<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>10</epicId>
    <storyId>2</storyId>
    <title>Step Grid Component</title>
    <status>drafted</status>
    <generatedAt>2025-11-23</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/e10-2-step-grid-component.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>to see all 16 steps as a visual grid</iWant>
    <soThat>I can see my sequence at a glance</soThat>
    <tasks>
      - Create StepGridView widget with responsive layout (GridView desktop, horizontal ListView mobile)
      - Create StepColumnWidget for individual steps with pitch bar, velocity indicator, step number, and active highlighting
      - Create PitchBarPainter CustomPaint with dark teal gradient background and bright teal fill
      - Integrate StepGridView into StepSequencerView, replacing placeholder UI
      - Add responsive layout support with mobile detection (width ≤ 768px)
      - Widget testing for StepColumnWidget
      - Integration testing for full grid rendering
      - Run flutter analyze
    </tasks>
  </story>

  <acceptanceCriteria>
    - AC2.1: Display 16 step columns in horizontal grid
    - AC2.2: Each step shows pitch as vertical bar (gradient fill)
    - AC2.3: Each step shows velocity as horizontal indicator below pitch
    - AC2.4: Step numbers labeled 1-16
    - AC2.5: Grid is scrollable if content exceeds screen width (mobile)
    - AC2.6: Active step highlighted with border color change
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-step-sequencer-ui.md</path>
        <title>Epic: Visual Step Sequencer UI Widget</title>
        <section>Story 2: Step Grid Component</section>
        <snippet>As a user I want to see all 16 steps as a visual grid, so that I can see my sequence at a glance. Display 16 step columns in horizontal grid with pitch bars (gradient fill) and velocity indicators.</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-step-sequencer-ui-technical-context.md</path>
        <title>Technical Context: Step Sequencer UI Epic</title>
        <section>CustomPaint for Step Bars</section>
        <snippet>Use CustomPainter for pitch bar visualization with gradient fills. Background: Linear gradient from darkTeal (bottom) to darkerTeal (top). Fill: Bright teal from bottom to (pitchValue / 127.0) × height. Performance: RepaintBoundary wrapping, shouldRepaint optimization.</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-step-sequencer-ui-technical-context.md</path>
        <title>Technical Context: Step Sequencer UI Epic</title>
        <section>Responsive Breakpoints</section>
        <snippet>Mobile ≤ 768px → horizontal scroll (ListView.builder), Tablet 769-1024px → may show subset with scroll, Desktop > 1024px → all 16 steps visible (GridView). Use MediaQuery for detection.</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-step-sequencer-ui-technical-context.md</path>
        <title>Technical Context: Step Sequencer UI Epic</title>
        <section>State Management</section>
        <snippet>No new Cubit required. Use BlocBuilder with DistingCubit for parameter values (read-only). Use buildWhen optimization to rebuild only when parameter values change. Local widget state for UI-only concerns.</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-step-sequencer-ui-technical-context.md</path>
        <title>Technical Context: Step Sequencer UI Epic</title>
        <section>Performance Considerations</section>
        <snippet>Target 60fps: Use RepaintBoundary for each StepColumnWidget, CustomPaint shouldRepaint optimization, BlocBuilder precision (only rebuild on parameter value changes), ListView.builder for lazy loading, const constructors where possible.</snippet>
      </doc>
      <doc>
        <path>docs/research-step-sequencer-2025-11-23.md</path>
        <title>Step Sequencer Research</title>
        <section>Visual Design Research</section>
        <snippet>Research findings on step sequencer visual patterns and user experience expectations.</snippet>
      </doc>
      <doc>
        <path>docs/step-sequencer-ui-mockups.html</path>
        <title>Step Sequencer UI Mockups</title>
        <section>Compact Grid Design</section>
        <snippet>Visual mockups showing 16-column grid layout with teal color scheme, pitch bars with gradient fills, responsive mobile and desktop layouts.</snippet>
      </doc>
      <doc>
        <path>docs/stories/e10-1-algorithm-widget-registration.md</path>
        <title>Story 10.1: Algorithm Widget Registration</title>
        <section>Completion Notes</section>
        <snippet>Created StepSequencerParams service for parameter discovery with flexible regex patterns. Widget registration in AlgorithmViewRegistry via case 'spsq'. All 1096 tests pass.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>lib/ui/step_sequencer_view.dart</path>
        <kind>widget</kind>
        <symbol>StepSequencerView</symbol>
        <lines>1-88</lines>
        <reason>Main widget for Step Sequencer algorithm - placeholder to be enhanced with StepGridView in this story</reason>
      </artifact>
      <artifact>
        <path>lib/services/step_sequencer_params.dart</path>
        <kind>service</kind>
        <symbol>StepSequencerParams</symbol>
        <lines>1-160</lines>
        <reason>Parameter discovery service created in Story 10.1 - use to extract pitch and velocity values for grid visualization</reason>
      </artifact>
      <artifact>
        <path>lib/ui/notes_algorithm_view.dart</path>
        <kind>widget</kind>
        <symbol>NotesAlgorithmView</symbol>
        <lines>1-100</lines>
        <reason>Reference implementation of algorithm-specific view pattern - shows StatefulWidget structure with BlocBuilder integration</reason>
      </artifact>
      <artifact>
        <path>lib/ui/algorithm_registry.dart</path>
        <kind>registry</kind>
        <symbol>AlgorithmViewRegistry</symbol>
        <lines>8</lines>
        <reason>Widget registry with case 'spsq' returning StepSequencerView - no changes needed</reason>
      </artifact>
      <artifact>
        <path>lib/cubit/disting_cubit.dart</path>
        <kind>cubit</kind>
        <symbol>DistingCubit</symbol>
        <lines>1-1000+</lines>
        <reason>State management for slot data and parameter values - use with BlocBuilder to access pitch/velocity values for rendering</reason>
      </artifact>
      <artifact>
        <path>test/ui/widgets/routing/algorithm_node_widget_test.dart</path>
        <kind>test</kind>
        <symbol>widget tests</symbol>
        <lines>all</lines>
        <reason>Example widget test pattern to follow for StepColumnWidget tests</reason>
      </artifact>
    </code>

    <dependencies>
      <flutter>
        <package name="flutter" version="sdk" />
        <package name="flutter_bloc" version="^9.1.1" />
        <package name="bloc" version="^9.1.0" />
        <package name="equatable" version="^2.0.7" />
      </flutter>
      <dev>
        <package name="flutter_test" version="sdk" />
        <package name="mockito" version="^5.5.1" />
        <package name="mocktail" version="^1.0.4" />
        <package name="bloc_test" version="^10.0.0" />
      </dev>
    </dependencies>
  </artifacts>

  <constraints>
    - MUST use existing DistingCubit for state management (no new Cubit)
    - MUST use CustomPaint for pitch bar visualization (not stacked Containers)
    - MUST implement responsive layout: mobile ≤ 768px horizontal scroll, desktop grid view
    - MUST wrap StepColumnWidget with RepaintBoundary for performance
    - MUST implement shouldRepaint optimization in CustomPainter
    - MUST use BlocBuilder with buildWhen to rebuild only on parameter value changes
    - MUST use teal color scheme: primaryTeal (#14b8a6), darkTeal (#0f766e), darkerTeal (#115e59), brightTeal (#5eead4)
    - MUST use StepSequencerParams service from Story 10.1 for parameter discovery
    - MUST support dark mode (use Theme.of(context) for colors)
    - MUST pass flutter analyze with zero warnings
    - MUST maintain 60fps performance during scrolling
  </constraints>

  <interfaces>
    <interface>
      <name>StepSequencerParams.fromSlot</name>
      <kind>constructor</kind>
      <signature>StepSequencerParams.fromSlot(Slot slot)</signature>
      <path>lib/services/step_sequencer_params.dart</path>
      <usage>Instantiate to discover parameter structure and get pitch/velocity indices</usage>
    </interface>
    <interface>
      <name>StepSequencerParams.getPitch</name>
      <kind>method</kind>
      <signature>int? getPitch(int step)</signature>
      <path>lib/services/step_sequencer_params.dart</path>
      <usage>Get parameter index for pitch of step 1-16 (1-indexed), returns null if not found</usage>
    </interface>
    <interface>
      <name>StepSequencerParams.getVelocity</name>
      <kind>method</kind>
      <signature>int? getVelocity(int step)</signature>
      <path>lib/services/step_sequencer_params.dart</path>
      <usage>Get parameter index for velocity of step 1-16 (1-indexed), returns null if not found</usage>
    </interface>
    <interface>
      <name>BlocBuilder&lt;DistingCubit, DistingState&gt;</name>
      <kind>widget</kind>
      <signature>BlocBuilder&lt;DistingCubit, DistingState&gt;(buildWhen: (prev, curr) =&gt; condition, builder: (context, state) =&gt; widget)</signature>
      <path>flutter_bloc package</path>
      <usage>Rebuild widget when DistingCubit state changes - use buildWhen to optimize for parameter value changes only</usage>
    </interface>
    <interface>
      <name>CustomPainter</name>
      <kind>abstract class</kind>
      <signature>class PitchBarPainter extends CustomPainter { void paint(Canvas canvas, Size size); bool shouldRepaint(covariant CustomPainter oldDelegate); }</signature>
      <path>flutter framework</path>
      <usage>Implement for efficient pitch bar rendering with gradient background and fill</usage>
    </interface>
    <interface>
      <name>MediaQuery.of(context).size.width</name>
      <kind>property</kind>
      <signature>double width = MediaQuery.of(context).size.width</signature>
      <path>flutter framework</path>
      <usage>Get screen width for responsive breakpoint detection (mobile ≤ 768px)</usage>
    </interface>
  </interfaces>

  <tests>
    <standards>
      This project uses Flutter's widget testing framework with mockito/mocktail for mocks and bloc_test for Cubit testing. Tests must pass `flutter test` with zero failures. Widget tests should verify UI rendering, user interactions, and state changes. Integration tests verify full workflows. All tests use descriptive names and follow AAA pattern (Arrange, Act, Assert). Test files mirror source structure in test/ directory.
    </standards>

    <locations>
      - test/ui/widgets/step_sequencer/ (new - for StepColumnWidget tests)
      - test/ui/widgets/routing/ (existing - reference for widget test patterns)
      - test/services/ (for service unit tests if needed)
    </locations>

    <ideas>
      <test ac="AC2.1">
        <description>Test StepGridView renders 16 step columns</description>
        <approach>Create widget test with mock Slot data, pump StepGridView, verify find.byType(StepColumnWidget) finds 16 widgets</approach>
      </test>
      <test ac="AC2.2">
        <description>Test pitch bar CustomPaint renders correctly</description>
        <approach>Widget test for PitchBarPainter with different pitch values (0, 64, 127), verify paint() called with correct Canvas operations</approach>
      </test>
      <test ac="AC2.3">
        <description>Test velocity indicator displays</description>
        <approach>Widget test for StepColumnWidget with velocity value, verify indicator widget present and shows correct value</approach>
      </test>
      <test ac="AC2.4">
        <description>Test step numbers labeled 1-16</description>
        <approach>Widget test verifying Text widgets show "1" through "16" (1-indexed display)</approach>
      </test>
      <test ac="AC2.5">
        <description>Test horizontal scroll on mobile</description>
        <approach>Widget test with narrow screen width (600px), verify SingleChildScrollView with horizontal axis present</approach>
      </test>
      <test ac="AC2.6">
        <description>Test active step highlighting</description>
        <approach>Widget test with isActive=true parameter, verify border color matches primaryTeal and width is 2px</approach>
      </test>
      <test ac="integration">
        <description>Integration test for full grid with BlocBuilder</description>
        <approach>Create test with DistingCubit mock providing Slot data, verify grid renders with correct pitch/velocity values from slot parameters</approach>
      </test>
      <test ac="performance">
        <description>Performance profiling test</description>
        <approach>Manual testing with Flutter DevTools to verify 60fps during scrolling on real device</approach>
      </test>
    </ideas>
  </tests>
</story-context>
