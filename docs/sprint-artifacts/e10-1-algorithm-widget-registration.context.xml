<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>10</epicId>
    <storyId>1</storyId>
    <title>Algorithm Widget Registration</title>
    <status>drafted</status>
    <generatedAt>2025-11-23</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/e10-1-algorithm-widget-registration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>Step Sequencer algorithm to render custom widget</iWant>
    <soThat>users see visual UI instead of parameter list</soThat>
    <tasks>
      <task id="1" ac="1.1,1.2">
        <description>Add Step Sequencer case to AlgorithmViewRegistry</description>
        <subtasks>
          <subtask>Open lib/ui/algorithm_registry.dart</subtask>
          <subtask>Add case 'spsq': in findViewFor() method</subtask>
          <subtask>Return StepSequencerView(slot: slot, firmwareVersion: firmwareVersion)</subtask>
          <subtask>Add import for StepSequencerView</subtask>
        </subtasks>
      </task>
      <task id="2" ac="1.3,1.4">
        <description>Create StepSequencerView widget</description>
        <subtasks>
          <subtask>Create lib/ui/step_sequencer_view.dart</subtask>
          <subtask>Implement basic widget that accepts slot and firmwareVersion</subtask>
          <subtask>Add try-catch with fallback to error message if widget fails</subtask>
          <subtask>Display placeholder UI (e.g., "Step Sequencer Widget - Coming Soon")</subtask>
          <subtask>Test navigation to Step Sequencer algorithm shows new widget</subtask>
        </subtasks>
      </task>
      <task id="3" ac="1.5">
        <description>Create StepSequencerParams service for parameter discovery</description>
        <subtasks>
          <subtask>Create lib/services/step_sequencer_params.dart</subtask>
          <subtask>Implement StepSequencerParams.fromSlot(Slot slot) factory</subtask>
          <subtask>Implement _discoverNumSteps() using regex pattern matching</subtask>
          <subtask>Implement _buildParameterMap() to index all parameters</subtask>
          <subtask>Support multiple naming patterns: "1. Pitch", "Step 1 Pitch", "1_Pitch"</subtask>
        </subtasks>
      </task>
      <task id="4" ac="1.6,1.7,1.8,1.9">
        <description>Implement parameter discovery verification</description>
        <subtasks>
          <subtask>Add logging for discovered step count</subtask>
          <subtask>Implement getter methods for step parameters (getPitch, getVelocity, getMod, etc.)</subtask>
          <subtask>Implement getter methods for global parameters (direction, startStep, etc.)</subtask>
          <subtask>Add debug logging (not errors) for missing parameters using debugPrint()</subtask>
          <subtask>Test with actual Step Sequencer algorithm slot data</subtask>
        </subtasks>
      </task>
      <task id="5">
        <description>Integration testing</description>
        <subtasks>
          <subtask>Load Step Sequencer algorithm in app</subtask>
          <subtask>Verify StepSequencerView renders instead of parameter list</subtask>
          <subtask>Verify parameter discovery logs show correct counts</subtask>
          <subtask>Verify no errors in console (warnings are acceptable)</subtask>
          <subtask>Test fallback behavior if widget initialization fails</subtask>
        </subtasks>
      </task>
      <task id="6">
        <description>Run flutter analyze</description>
        <subtasks>
          <subtask>Run flutter analyze and ensure zero warnings</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1.1">Add case 'spsq': to AlgorithmViewRegistry (lib/ui/algorithm_registry.dart:8)</criterion>
    <criterion id="1.2">Return StepSequencerView(slot: slot, firmwareVersion: firmwareVersion)</criterion>
    <criterion id="1.3">Widget renders when user navigates to Step Sequencer algorithm</criterion>
    <criterion id="1.4">Fallback to parameter list if widget fails to load</criterion>
    <criterion id="1.5">StepSequencerParams.fromSlot() discovers parameter structure from slot data</criterion>
    <criterion id="1.6">Verify number of steps discovered (log count, expect 16)</criterion>
    <criterion id="1.7">Verify all step parameters found (Pitch, Velocity, Mod, Division, Pattern, Ties, Probability)</criterion>
    <criterion id="1.8">Verify global parameters found (Direction, Start/End Step, Gate/Trigger/Glide)</criterion>
    <criterion id="1.9">Log warnings (not errors) for any missing parameters</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-step-sequencer-ui.md</path>
        <title>Epic: Visual Step Sequencer UI Widget</title>
        <section>Story 1: Algorithm Widget Registration</section>
        <snippet>Transform the Step Sequencer algorithm from a boring parameter list into an intuitive visual grid interface. Story 1 registers the custom widget via AlgorithmViewRegistry pattern.</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-step-sequencer-ui-technical-context.md</path>
        <title>Technical Context: Step Sequencer UI Epic</title>
        <section>AlgorithmViewRegistry Pattern</section>
        <snippet>The implementation leverages the existing AlgorithmViewRegistry pattern (see NotesAlgorithmView). Add case 'spsq': to switch statement in findViewFor() method. Integration point: lib/ui/synchronized_screen.dart already calls AlgorithmViewRegistry.findViewFor() when rendering slot details.</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-step-sequencer-ui-technical-context.md</path>
        <title>Technical Context: Step Sequencer UI Epic</title>
        <section>Parameter Mapping Strategy</section>
        <snippet>The Step Sequencer has 50+ parameters. Use StepSequencerParams.fromSlot() to discover parameter structure from algorithm metadata and parameter names. Support multiple naming patterns: "1. Pitch", "Step 1 Pitch", "1_Pitch". Discover number of steps from parameter names (expect 16).</snippet>
      </doc>
      <doc>
        <path>docs/research-step-sequencer-2025-11-23.md</path>
        <title>Step Sequencer Research</title>
        <section>Parameter Structure</section>
        <snippet>Research document analyzing Step Sequencer parameters, UI patterns, and implementation approach.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>lib/ui/algorithm_registry.dart</path>
        <kind>registry</kind>
        <symbol>AlgorithmViewRegistry.findViewFor</symbol>
        <lines>7-13</lines>
        <reason>This is the integration point where the new Step Sequencer widget will be registered. Currently has case for 'note' algorithm, need to add case for 'spsq'.</reason>
      </file>
      <file>
        <path>lib/ui/notes_algorithm_view.dart</path>
        <kind>widget</kind>
        <symbol>NotesAlgorithmView</symbol>
        <lines>1-50</lines>
        <reason>Reference implementation showing the pattern for algorithm-specific widgets. Shows how to accept slot and firmwareVersion parameters, use BlocBuilder for state management, and implement StatefulWidget pattern.</reason>
      </file>
      <file>
        <path>lib/cubit/disting_cubit.dart</path>
        <kind>cubit</kind>
        <symbol>DistingCubit</symbol>
        <lines>all</lines>
        <reason>Source of truth for Slot objects with algorithm, parameters, and values. Provides updateParameterValue() method for MIDI writes. No changes needed but will be used by future stories.</reason>
      </file>
    </code>
    <dependencies>
      <flutter>
        <package name="flutter">SDK framework</package>
        <package name="flutter_bloc">State management (BlocBuilder, BlocProvider)</package>
      </flutter>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Must follow existing AlgorithmViewRegistry pattern established by NotesAlgorithmView</constraint>
    <constraint>Widget must accept Slot and FirmwareVersion parameters</constraint>
    <constraint>Must use StatefulWidget if local state needed, StatelessWidget if purely reactive</constraint>
    <constraint>Parameter discovery must be flexible to handle multiple naming patterns</constraint>
    <constraint>Missing parameters should log warnings (debugPrint), not throw errors</constraint>
    <constraint>Must run flutter analyze with zero warnings before commit</constraint>
    <constraint>No changes to MIDI layer, state management core, or SysEx commands</constraint>
    <constraint>Fallback to parameter list if widget fails to load (error handling)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>AlgorithmViewRegistry.findViewFor</name>
      <kind>factory method</kind>
      <signature>static Widget? findViewFor(Slot slot, FirmwareVersion firmwareVersion)</signature>
      <path>lib/ui/algorithm_registry.dart</path>
    </interface>
    <interface>
      <name>Slot</name>
      <kind>data model</kind>
      <signature>class Slot with algorithm, parameters, parameterValues, routing info</signature>
      <path>lib/cubit/disting_cubit.dart</path>
    </interface>
    <interface>
      <name>FirmwareVersion</name>
      <kind>data model</kind>
      <signature>class FirmwareVersion</signature>
      <path>lib/models/firmware_version.dart</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Flutter testing framework. Widget tests for UI components. Integration tests for full workflows. Run flutter analyze before commit. Test on desktop (macOS) and mobile (iOS/Android) platforms. Verify both success path (widget renders) and error path (fallback to parameter list).
    </standards>
    <locations>
      <location>test/ui/</location>
      <location>test/services/</location>
      <location>test/integration/</location>
    </locations>
    <ideas>
      <idea ac="1.1,1.2">Unit test: AlgorithmViewRegistry.findViewFor('spsq') returns StepSequencerView instance</idea>
      <idea ac="1.3">Widget test: StepSequencerView renders without errors when provided valid Slot</idea>
      <idea ac="1.4">Widget test: Fallback behavior when widget initialization throws exception</idea>
      <idea ac="1.5,1.6,1.7,1.8">Unit test: StepSequencerParams.fromSlot() with mock slot data discovers correct parameter structure</idea>
      <idea ac="1.9">Unit test: Verify debugPrint called for missing parameters, no exceptions thrown</idea>
      <idea>Integration test: Load Step Sequencer algorithm in app, verify custom widget displayed instead of parameter list</idea>
    </ideas>
  </tests>
</story-context>
