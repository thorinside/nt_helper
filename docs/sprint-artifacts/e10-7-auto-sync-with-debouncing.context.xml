<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>10</epicId>
    <storyId>7</storyId>
    <title>Auto-Sync with Debouncing</title>
    <status>drafted</status>
    <generatedAt>2025-11-23</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/e10-7-auto-sync-with-debouncing.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>my edits to sync automatically to hardware</iWant>
    <soThat>I don't have to press a sync button</soThat>
    <tasks>
      - Implement automatic parameter synchronization with 50ms debouncing
      - Prevent excessive MIDI writes during rapid slider drags
      - Provide visual sync status feedback (synced, editing, syncing, error states)
      - Handle write failures with error indication and retry mechanism
      - Support per-parameter independent debouncing for concurrent operations
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC7.1">
      <description>Parameter changes trigger MIDI write after 50ms debounce</description>
      <details>
        - When user changes a parameter (via slider, dropdown, or input), a debounced write is scheduled
        - Debounce delay is 50ms (configurable if needed for testing)
        - Timer starts/resets on each parameter change
        - MIDI write only occurs once after user stops changing the parameter for 50ms
      </details>
    </criterion>
    <criterion id="AC7.2">
      <description>Rapid edits (slider drag) only write final value</description>
      <details>
        - During continuous slider drag, intermediate values do NOT trigger MIDI writes
        - Each parameter change resets the 50ms timer for that parameter
        - Only the final value (when user releases slider or stops dragging for 50ms) is written to hardware
        - Prevents MIDI message queue flooding during rapid edits
      </details>
    </criterion>
    <criterion id="AC7.3">
      <description>Sync status indicator shows: Synced (green), Editing (orange), Syncing (blue)</description>
      <details>
        - Synced (green): All parameters in sync with hardware, no pending changes
        - Editing (orange): User actively editing, debounce timers pending
        - Syncing (blue): MIDI write in progress, waiting for confirmation
        - Error (red): MIDI write failed, with retry button
        - Status indicator updates in real-time based on debouncer state
      </details>
    </criterion>
    <criterion id="AC7.4">
      <description>Failed writes show error indicator with retry button</description>
      <details>
        - If MIDI write fails (timeout, disconnected hardware, etc.), status shows red error
        - Retry button appears next to error indicator
        - Clicking retry attempts to write all failed parameters again
        - Error message shows which parameters failed (for debugging)
      </details>
    </criterion>
    <criterion id="AC7.5">
      <description>Debouncer per parameter (multiple params can sync concurrently)</description>
      <details>
        - Each parameter has independent debounce timer
        - Multiple parameters can have pending timers simultaneously
        - Parameters sync as soon as their individual 50ms delay elapses
        - No artificial queueing - leverage existing DistingMessageScheduler for MIDI queueing
      </details>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-step-sequencer-ui.md</path>
        <title>Epic: Visual Step Sequencer UI Widget</title>
        <section>Story 7: Auto-Sync with Debouncing</section>
        <snippet>Implements automatic parameter synchronization with debouncing to ensure smooth editing while preventing excessive MIDI writes. Parameter changes trigger MIDI write after 50ms debounce, rapid edits only write final value, sync status indicator shows state (synced/editing/syncing/error), failed writes show error with retry button.</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-step-sequencer-ui-technical-context.md</path>
        <title>Technical Context: Step Sequencer UI Epic</title>
        <section>2. Parameter Value Debouncing (lines 154-211)</section>
        <snippet>Implement 50ms debounce using Timer in the widget, not in DistingCubit. Each parameter can have an independent debounce timer. ParameterWriteDebouncer class provides schedule() method to cancel old timers and schedule new ones. Usage includes preview value updates and disposing timers in widget dispose().</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/e10-3-step-selection-and-editing.md</path>
        <title>Story 3: Step Selection and Editing</title>
        <section>Dev Notes - Learnings</section>
        <snippet>Story 3 already uses ParameterWriteDebouncer in the step edit modal. This story extracts the debouncer into a reusable utility at lib/util/parameter_write_debouncer.dart. Check lib/ui/widgets/step_sequencer/step_edit_modal.dart for current implementation pattern.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>lib/util/parameter_write_debouncer.dart</path>
        <kind>utility</kind>
        <symbol>ParameterWriteDebouncer</symbol>
        <lines>1-62</lines>
        <reason>ALREADY EXISTS - Utility class for debouncing parameter writes. Provides schedule() method with Timer-based debouncing, dispose() for cleanup, and pendingCount getter. This is the core component required by the story.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/widgets/step_sequencer/step_edit_modal.dart</path>
        <kind>widget</kind>
        <symbol>_StepEditModalState._debounceTimers</symbol>
        <lines>34, 47-54, 99-110</lines>
        <reason>Reference implementation of manual debouncing using Map&lt;String, Timer&gt;. Shows pattern of canceling existing timer, scheduling new one, and cleanup in dispose(). This is the pattern that needs to be replaced with ParameterWriteDebouncer.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/widgets/step_sequencer/playback_controls.dart</path>
        <kind>widget</kind>
        <symbol>PlaybackControls._debouncer</symbol>
        <lines>40</lines>
        <reason>Already uses ParameterWriteDebouncer for playback control parameter updates. Good reference for how to integrate the debouncer with parameter updates.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/step_sequencer_view.dart</path>
        <kind>widget</kind>
        <symbol>StepSequencerView</symbol>
        <lines>1-327</lines>
        <reason>Main step sequencer view that needs sync status indicator added to header. Currently has quantize controls, sequence selector, step grid, and playback controls.</reason>
      </artifact>
      <artifact>
        <path>lib/cubit/disting_cubit.dart</path>
        <kind>cubit</kind>
        <symbol>DistingCubit.updateParameterValue</symbol>
        <lines>1-100</lines>
        <reason>Core state management method called after debounce delay. Handles MIDI writes via IDistingMidiManager. Returns Future for error handling.</reason>
      </artifact>
      <artifact>
        <path>test/util/parameter_write_debouncer_test.dart</path>
        <kind>test</kind>
        <symbol>ParameterWriteDebouncer Tests</symbol>
        <lines>1-116</lines>
        <reason>ALREADY EXISTS - Complete test suite for ParameterWriteDebouncer covering debouncing, multiple keys, disposal, and pending count tracking.</reason>
      </artifact>
    </code>
    <dependencies>
      <flutter>
        <package name="flutter" version="sdk" ecosystem="flutter"/>
        <package name="flutter_bloc" version="^9.1.1" ecosystem="flutter"/>
        <package name="bloc" version="^9.1.0" ecosystem="flutter"/>
      </flutter>
      <dart>
        <package name="async" version="^2.13.0" ecosystem="dart"/>
      </dart>
    </dependencies>
  </artifacts>

  <constraints>
    - Zero tolerance for flutter analyze errors
    - All existing tests must pass
    - Debouncing must happen in UI layer, not in DistingCubit (architecture decision from technical context)
    - Each widget instance maintains its own debouncer
    - No changes to MIDI layer or state management core
    - Leverage existing DistingMessageScheduler for MIDI queueing
    - Must work identically in Live, Mock, and Offline modes
    - 50ms debounce delay is standard (configurable for testing if needed)
    - Sync status must update in real-time based on debouncer state
    - Error handling must provide actionable feedback to users
  </constraints>

  <interfaces>
    <interface>
      <name>ParameterWriteDebouncer.schedule</name>
      <kind>method</kind>
      <signature>void schedule(String key, void Function() callback, Duration delay)</signature>
      <path>lib/util/parameter_write_debouncer.dart</path>
      <usage>Primary method for scheduling debounced writes. Key uniquely identifies parameter, callback executes after delay.</usage>
    </interface>
    <interface>
      <name>ParameterWriteDebouncer.dispose</name>
      <kind>method</kind>
      <signature>void dispose()</signature>
      <path>lib/util/parameter_write_debouncer.dart</path>
      <usage>Must be called in widget dispose() to prevent memory leaks.</usage>
    </interface>
    <interface>
      <name>ParameterWriteDebouncer.pendingCount</name>
      <kind>getter</kind>
      <signature>int get pendingCount</signature>
      <path>lib/util/parameter_write_debouncer.dart</path>
      <usage>Returns number of currently pending timers. Used for sync status determination.</usage>
    </interface>
    <interface>
      <name>DistingCubit.updateParameterValue</name>
      <kind>method</kind>
      <signature>Future&lt;void&gt; updateParameterValue({required int algorithmIndex, required int parameterNumber, required dynamic value, required bool userIsChangingTheValue})</signature>
      <path>lib/cubit/disting_cubit.dart</path>
      <usage>Called after debounce delay to write parameter to hardware. Returns Future for error handling.</usage>
    </interface>
  </interfaces>

  <tests>
    <standards>
      - Unit tests using flutter_test for utility classes
      - Widget tests for UI components with MaterialApp wrappers
      - Integration tests with BlocProvider for cubit interactions
      - Mock MIDI manager for testing hardware interactions
      - Async testing with Future.delayed for timer-based behavior
      - Test coverage for error cases and edge conditions
    </standards>
    <locations>
      - test/util/ - Unit tests for utility classes
      - test/ui/widgets/step_sequencer/ - Widget tests for step sequencer components
      - test/integration/ - Integration tests (if needed)
    </locations>
    <ideas>
      <idea ac="AC7.1">
        <test>Unit test: Parameter change schedules debounced write after 50ms</test>
        <test>Unit test: Multiple parameter changes reset timer, only final value written</test>
      </idea>
      <idea ac="AC7.2">
        <test>Unit test: Rapid calls (10 changes in 100ms) result in only 1 callback execution</test>
        <test>Integration test: Slider drag generates many events but only final value syncs to hardware</test>
      </idea>
      <idea ac="AC7.3">
        <test>Widget test: Sync status indicator shows correct color for each state</test>
        <test>Widget test: Status updates from synced → editing when parameter changes</test>
        <test>Widget test: Status updates from editing → syncing → synced after write completes</test>
      </idea>
      <idea ac="AC7.4">
        <test>Widget test: Error status shows red color and retry button</test>
        <test>Integration test: Failed MIDI write triggers error state and retry succeeds</test>
      </idea>
      <idea ac="AC7.5">
        <test>Unit test: Multiple parameters with independent timers sync concurrently</test>
        <test>Unit test: pendingCount tracks active timers correctly</test>
      </idea>
    </ideas>
  </tests>
</story-context>
