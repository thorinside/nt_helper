<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>10</storyId>
    <title>Persist Output Mode Usage to Database</title>
    <status>pending</status>
    <generatedAt>2025-11-21</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/Users/nealsanche/nosuch/nt_helper/docs/stories/7-10-persist-output-mode-usage-to-database.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer maintaining the nt_helper offline metadata system</asA>
    <iWant>output mode usage relationships persisted to the database and included in metadata exports</iWant>
    <soThat>offline mode has access to output mode data and the routing editor can display correct Add/Replace mode indicators without requiring hardware connection</soThat>
    <tasks>
      - Task 1: Diagnose current state ✓ COMPLETE
      - Task 2: Update metadata sync to query output mode usage (AC-3) **PRIMARY TASK**
        - Add output mode usage collection after line 674 in _syncInstantiatedAlgorithmParams()
        - Loop through parameterInfos checking paramInfo.isOutputMode
        - For each output mode parameter, call _distingManager.requestOutputModeUsage(0, paramNum)
        - Build list of ParameterOutputModeUsageEntry objects
        - Call metadataDao.upsertOutputModeUsage(entries) before line 676
        - Add individual try-catch per parameter with debugPrint logging
        - Add same logic to rescanSingleAlgorithm() method for consistency
        - Test with Euclidean algorithm (177 params should have ioFlags >= 8)
      - Task 3: Verify data collection works (AC-7)
      - Task 4: Verify export/import includes data (AC-4, AC-5)
      - Task 5: Optional - Runtime persistence (AC-2)
      - Task 6: Optional - Offline mode access (AC-6)
      - Task 7: Code quality (AC-8)
    </tasks>
  </story>

  <acceptanceCriteria>
    AC-1: Database Persistence Layer ✓ (Already Exists)
      - MetadataDao methods getAllOutputModeUsage() and upsertOutputModeUsage() already exist
      - Uses InsertMode.insertOrReplace for upsert behavior
      - No validation needed - firmware provides the data

    AC-2: Runtime State to Database Sync
      - When OutputModeUsageResponse is received in DistingCubit, persist to database via MetadataDao
      - Store algorithm GUID + parameter number + affected parameters list
      - Sync occurs automatically during parameter metadata sync
      - Only persist for non-mock, non-demo modes
      - Database write doesn't block UI updates

    AC-3: Metadata Collection Integration (PRIMARY TASK)
      - Update MetadataSyncService._syncInstantiatedAlgorithmParams() to query output mode usage
      - After collecting parameter info, check for parameters with isOutputMode=true
      - Call _distingManager.requestOutputModeUsage(slot: 0, parameterNumber: pNum)
      - Wait for OutputModeUsageResponse
      - Build ParameterOutputModeUsageEntry with algorithmGuid, parameterNumber, affectedOutputNumbers
      - After all parameters processed, batch insert via metadataDao.upsertOutputModeUsage(entries)
      - Log parameters with output mode flag but no usage data (potential firmware issues)

    AC-4: Export Enhancement
      - AlgorithmJsonExporter.exportFullMetadata() already queries table
      - Verify export includes all parameterOutputModeUsage entries
      - Export format: {algorithmGuid, parameterNumber, affectedOutputNumbers}
      - Non-zero count in summary when data present

    AC-5: Import Enhancement
      - MetadataImportService reads parameterOutputModeUsage from JSON
      - Imports entries into database table
      - Handles empty array gracefully
      - Validates foreign key references

    AC-6: Offline Mode Support
      - Offline routing framework can query output mode data from database
      - OfflineDistingMidiManager provides access to stored output mode relationships
      - Routing editor displays Add/Replace mode indicators in offline mode

    AC-7: Data Validation
      - Unit test verifies database insert/query round-trip
      - Unit test verifies export includes output mode data
      - Unit test verifies import populates database correctly
      - Integration test with hardware verifies automatic persistence
      - Verify exported JSON has non-zero totalParameterOutputModeUsage count
      - Verify all parameters with isOutputMode=true have corresponding usage entries

    AC-8: Code Quality
      - No flutter analyze warnings
      - Follow existing DAO patterns for database operations
      - Error handling for database write failures
      - Documentation comments for new DAO methods
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epic-7-context.md</path>
        <title>Epic 7: SysEx Updates - Technical Context</title>
        <section>Output Mode Usage (SysEx 0x55)</section>
        <snippet>New message type 0x55 queries output mode usage relationships. Explicitly maps mode parameters to their controlled outputs, replacing pattern matching for Add/Replace mode visualization.</snippet>
      </doc>
      <doc>
        <path>docs/metadata-collection-process.md</path>
        <title>Metadata Collection Process</title>
        <section>Step 2: Sync All Algorithm Metadata</section>
        <snippet>Describes the metadata sync process that collects parameter info from hardware. This story adds output mode usage collection to this process.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>nt_helper Brownfield Architecture Document</title>
        <section>Database Layer</section>
        <snippet>Database uses Drift ORM with schema version 7. Metadata DAO provides algorithm metadata access. Story adds output mode usage persistence to existing DAO methods.</snippet>
      </doc>
      <doc>
        <path>docs/stories/7-4-synchronize-output-mode-usage-data.md</path>
        <title>Story 7.4: Synchronize Output Mode Usage Data</title>
        <section>Implementation</section>
        <snippet>Implemented runtime collection of output mode usage via SysEx 0x55. This story connects runtime collection to database persistence.</snippet>
      </doc>
      <doc>
        <path>docs/stories/7-7-add-io-flags-to-offline-metadata.md</path>
        <title>Story 7.7: Add I/O Flags to Offline Metadata</title>
        <section>Database Schema</section>
        <snippet>Added ParameterOutputModeUsage table with foreign keys and JSON field for affected output numbers. This story populates that table.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>lib/db/tables.dart</path>
        <kind>table</kind>
        <symbol>ParameterOutputModeUsage</symbol>
        <lines>111-126</lines>
        <reason>Database table schema for storing output mode usage relationships. Already exists with proper foreign keys and JSON converter for affected output numbers.</reason>
      </artifact>
      <artifact>
        <path>lib/db/daos/metadata_dao.dart</path>
        <kind>dao</kind>
        <symbol>getAllOutputModeUsage, upsertOutputModeUsage</symbol>
        <lines>299-336</lines>
        <reason>DAO methods for querying and persisting output mode usage. Already implemented with upsert behavior using InsertMode.insertOrReplace. No changes needed.</reason>
      </artifact>
      <artifact>
        <path>lib/services/metadata_sync_service.dart</path>
        <kind>service</kind>
        <symbol>_syncInstantiatedAlgorithmParams</symbol>
        <lines>596-737</lines>
        <reason>PRIMARY MODIFICATION TARGET. Collects parameter info from hardware but missing output mode usage collection. Add code after line 674 to query and persist output mode usage for parameters with isOutputMode flag.</reason>
      </artifact>
      <artifact>
        <path>lib/services/metadata_sync_service.dart</path>
        <kind>service</kind>
        <symbol>rescanSingleAlgorithm</symbol>
        <lines>740-806</lines>
        <reason>SECONDARY MODIFICATION TARGET. Needs same output mode collection logic for consistency when rescanning individual algorithms.</reason>
      </artifact>
      <artifact>
        <path>lib/services/algorithm_json_exporter.dart</path>
        <kind>service</kind>
        <symbol>exportFullMetadata</symbol>
        <lines>122-123, 218-226, 241</lines>
        <reason>Export logic already queries parameterOutputModeUsage table and includes in JSON. Works correctly, just has no data to export currently.</reason>
      </artifact>
      <artifact>
        <path>lib/services/metadata_import_service.dart</path>
        <kind>service</kind>
        <symbol>_importParameterOutputModeUsage</symbol>
        <lines>276-304</lines>
        <reason>Import logic already reads parameterOutputModeUsage from JSON and populates database. Complete implementation, no changes needed.</reason>
      </artifact>
      <artifact>
        <path>lib/domain/sysex/requests/request_output_mode_usage.dart</path>
        <kind>request</kind>
        <symbol>RequestOutputModeUsageMessage</symbol>
        <lines>1-30</lines>
        <reason>SysEx 0x55 request message implementation. Used by _distingManager.requestOutputModeUsage() to query hardware for affected parameters.</reason>
      </artifact>
      <artifact>
        <path>lib/domain/sysex/responses/output_mode_usage_response.dart</path>
        <kind>response</kind>
        <symbol>OutputModeUsageResponse</symbol>
        <lines>1-30</lines>
        <reason>SysEx 0x55 response parser. Extracts affected parameter numbers from hardware response.</reason>
      </artifact>
      <artifact>
        <path>lib/domain/i_disting_midi_manager.dart</path>
        <kind>interface</kind>
        <symbol>requestOutputModeUsage</symbol>
        <lines>unknown</lines>
        <reason>Interface method for requesting output mode usage. Called by metadata sync service to query hardware.</reason>
      </artifact>
      <artifact>
        <path>lib/domain/disting_nt_sysex.dart</path>
        <kind>model</kind>
        <symbol>ParameterInfo.isOutputMode</symbol>
        <lines>unknown</lines>
        <reason>Helper getter that checks bit 3 of ioFlags (value 8). Used to identify parameters that need output mode usage querying.</reason>
      </artifact>
    </code>
    <dependencies>
      <flutter>
        <package>drift</package>
        <version>^2.29.0</version>
        <purpose>ORM for database operations with type-safe queries and migrations</purpose>
      </flutter>
      <flutter>
        <package>flutter_bloc</package>
        <version>^9.1.1</version>
        <purpose>State management using Cubit pattern for DistingCubit and other state</purpose>
      </flutter>
      <flutter>
        <package>flutter_midi_command</package>
        <version>^0.5.3</version>
        <purpose>MIDI communication with Disting NT hardware</purpose>
      </flutter>
    </dependencies>
  </artifacts>

  <constraints>
    - Follow existing DAO patterns for database operations (batch insert with InsertMode.insertOrReplace)
    - No flutter analyze warnings tolerated
    - Use try-catch per parameter to avoid failing entire sync on individual parameter errors
    - Only persist for non-mock, non-demo modes (connected hardware mode)
    - Database writes must not block UI updates
    - Use existing MetadataDao methods (upsertOutputModeUsage) - no new DAO methods needed
    - Preserve existing parameter insertion at line 668-674, add output mode collection after
    - Add same logic to both _syncInstantiatedAlgorithmParams and rescanSingleAlgorithm for consistency
    - Use debugPrint for error logging (not print or log statements)
  </constraints>
  <interfaces>
    <interface>
      <name>IDistingMidiManager.requestOutputModeUsage</name>
      <kind>method</kind>
      <signature>Future&lt;OutputModeUsage?&gt; requestOutputModeUsage(int slot, int parameterNumber)</signature>
      <path>lib/domain/i_disting_midi_manager.dart</path>
    </interface>
    <interface>
      <name>MetadataDao.upsertOutputModeUsage</name>
      <kind>method</kind>
      <signature>Future&lt;void&gt; upsertOutputModeUsage(List&lt;ParameterOutputModeUsageEntry&gt; entries)</signature>
      <path>lib/db/daos/metadata_dao.dart</path>
    </interface>
    <interface>
      <name>ParameterInfo.isOutputMode</name>
      <kind>getter</kind>
      <signature>bool get isOutputMode =&gt; (ioFlags &amp; 8) != 0</signature>
      <path>lib/domain/disting_nt_sysex.dart</path>
    </interface>
    <interface>
      <name>OutputModeUsage.affectedParameterNumbers</name>
      <kind>property</kind>
      <signature>List&lt;int&gt; affectedParameterNumbers</signature>
      <path>lib/domain/disting_nt_sysex.dart</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Project uses flutter test framework with unit and integration tests. Tests should verify database operations (insert/query), export includes data, and import populates correctly. Integration tests with hardware verify automatic persistence. All tests must pass before commit. Run 'flutter analyze' to ensure zero warnings.
    </standards>
    <locations>
      test/ - Unit tests for services and models
      test/db/ - Database and DAO tests
      test/services/ - Service layer tests
    </locations>
    <ideas>
      - AC-7.1: Unit test MetadataDao round-trip (insert entries, query back, verify match)
      - AC-7.2: Unit test export includes output mode data (mock database, export, verify JSON has parameterOutputModeUsage array)
      - AC-7.3: Unit test import populates database (import JSON with output mode data, verify database entries created)
      - AC-7.4: Integration test with hardware verifies automatic persistence (connect hardware, sync algorithm with output mode params, verify database populated)
      - AC-7.5: Verify exported JSON has non-zero totalParameterOutputModeUsage count after sync
      - AC-7.6: Verify all parameters with isOutputMode=true have corresponding usage entries in database
      - Manual test: Load Euclidean algorithm (has output mode params), run sync, verify database has entries
    </ideas>
  </tests>
</story-context>
