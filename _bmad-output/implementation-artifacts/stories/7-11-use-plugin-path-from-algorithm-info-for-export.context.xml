<story-context id="7-11-use-plugin-path-from-algorithm-info-for-export" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>11</storyId>
    <title>Use Plugin Path from Algorithm Info for Preset Export</title>
    <status>drafted</status>
    <generatedAt>2025-11-30</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/7-11-use-plugin-path-from-algorithm-info-for-export.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user exporting presets that contain community plugins</asA>
    <iWant>the export to use the plugin file paths from the preset's algorithm info to download plugins directly from the SD card</iWant>
    <soThat>plugin files are reliably included in the export package using the path known by the hardware</soThat>
    <tasks>
      <task id="1" ac="1">Update PresetDependencies model
        <subtask>Add pluginPaths field as Map&lt;String, String&gt; (GUID → SD card path)</subtask>
        <subtask>Update hasCommunityPlugins getter to consider pluginPaths</subtask>
        <subtask>Keep existing communityPlugins set for backward compatibility</subtask>
      </task>
      <task id="2" ac="2,3">Extract plugin paths from SynchronizedState slots
        <subtask>Access AlgorithmInfo from each slot in the preset</subtask>
        <subtask>Check algorithmInfo.isPlugin == true to identify plugins</subtask>
        <subtask>Extract algorithmInfo.filename (the SD card path)</subtask>
        <subtask>Populate pluginPaths[algorithmInfo.guid] = algorithmInfo.filename</subtask>
      </task>
      <task id="3" ac="4,5,6,7,8">Update FileCollector to use pluginPaths
        <subtask>Iterate over dependencies.pluginPaths entries</subtask>
        <subtask>Use fileSystem.readFile(path) to read each plugin from SD card</subtask>
        <subtask>Add to collected files with appropriate path in zip</subtask>
        <subtask>Handle read errors gracefully with warnings</subtask>
      </task>
      <task id="4" ac="2,3">Wire up export flow
        <subtask>Identify where PresetDependencies is built for export</subtask>
        <subtask>Ensure AlgorithmInfo is available from slots at that point</subtask>
        <subtask>Connect extraction logic to populate pluginPaths</subtask>
      </task>
      <task id="5" ac="9,10">Write tests
        <subtask>Unit test for pluginPaths population from mock AlgorithmInfo</subtask>
        <subtask>Test FileCollector reads from pluginPaths via file system</subtask>
        <subtask>Test error handling when file doesn't exist</subtask>
      </task>
      <task id="6" ac="11,12">Verify and validate
        <subtask>Run flutter analyze - zero warnings</subtask>
        <subtask>Run full test suite - all pass</subtask>
        <subtask>Manual test: export preset with community plugin, verify .elf included in zip</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">Add pluginPaths field to PresetDependencies as Map&lt;String, String&gt; mapping GUID to SD card file path</ac>
    <ac id="2">When analyzing slots from SynchronizedState, extract AlgorithmInfo.filename for algorithms where isPlugin == true</ac>
    <ac id="3">Populate pluginPaths[guid] = filename for each slot that has a non-null filename</ac>
    <ac id="4">FileCollector.collectDependencies() uses pluginPaths to read plugin files directly from SD card via SysEx</ac>
    <ac id="5">Use existing PresetFileSystem.readFile() to download plugin .elf files from the paths in pluginPaths</ac>
    <ac id="6">Plugin files are included in the export .zip at their original SD card paths</ac>
    <ac id="7">If plugin file cannot be read from SD card, add warning to export results (don't fail entire export)</ac>
    <ac id="8">Handle both relative paths and any path format the hardware returns</ac>
    <ac id="9">Unit test verifies pluginPaths populated correctly from slots with plugin algorithms</ac>
    <ac id="10">Integration test verifies export reads plugin file from SD card path in AlgorithmInfo</ac>
    <ac id="11">flutter analyze passes with zero warnings</ac>
    <ac id="12">All existing tests pass with no regressions</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/architecture.md" title="Architecture Document" section="Data Models and Database" snippet="PresetDependencies is a model class that tracks all dependencies for a preset including wavetables, samples, FM banks, community plugins, etc." />
      <doc path="docs/architecture.md" title="Architecture Document" section="SysEx Command System" snippet="AlgorithmInfo struct contains filename field parsed from SysEx response bytes representing the actual location of plugin file on SD card." />
    </docs>
    <code>
      <file path="lib/models/preset_dependencies.dart" kind="model" symbol="PresetDependencies" reason="Must add pluginPaths field - Map&lt;String, String&gt; for GUID to path mapping" />
      <file path="lib/services/file_collector.dart" kind="service" symbol="FileCollector.collectDependencies" lines="15-124" reason="Must update to use pluginPaths for direct SD card reads instead of database lookup" />
      <file path="lib/services/preset_analyzer.dart" kind="service" symbol="PresetAnalyzer.analyzeDependencies" lines="6-18" reason="May need new method to extract plugin paths from AlgorithmInfo" />
      <file path="lib/services/package_creator.dart" kind="service" symbol="PackageCreator.createPackage" lines="19-117" reason="Entry point for export - needs to pass AlgorithmInfo data to dependency analysis" />
      <file path="lib/ui/widgets/preset_package_dialog.dart" kind="widget" symbol="PresetPackageDialog" lines="51-75" reason="UI that triggers export - may need to pass SynchronizedState slots for AlgorithmInfo access" />
      <file path="lib/domain/disting_nt_sysex.dart" kind="model" symbol="AlgorithmInfo" lines="307-324" reason="Contains filename field with SD card path - source of plugin paths" />
      <file path="lib/domain/sysex/responses/algorithm_info_response.dart" kind="parser" symbol="AlgorithmInfoResponse.parse" lines="90-96" reason="Parses filename from SysEx response bytes" />
      <file path="lib/interfaces/preset_file_system.dart" kind="interface" symbol="PresetFileSystem.readFile" lines="5-6" reason="Existing interface for reading files from SD card via SysEx" />
      <file path="lib/cubit/disting_state.dart" kind="state" symbol="SynchronizedState.slots" reason="Contains List&lt;Slot&gt; with AlgorithmInfo available in connected mode" />
    </code>
    <dependencies>
      <flutter>3.35.1</flutter>
      <dart>>=3.8.1</dart>
      <package name="archive" version="^3.6.1" reason="Used by PackageCreator for ZIP creation" />
      <package name="flutter_bloc" version="^9.1.1" reason="State management - may need to access DistingCubit state" />
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>No database involvement - purely SysEx-based file retrieval using PresetFileSystem</constraint>
    <constraint>Must use existing PresetFileSystem.readFile() infrastructure</constraint>
    <constraint>Must maintain backward compatibility with existing communityPlugins Set</constraint>
    <constraint>flutter analyze MUST pass with zero warnings before commit</constraint>
    <constraint>Use debugPrint() for logging, never print()</constraint>
    <constraint>Follow existing Cubit pattern for state management</constraint>
  </constraints>

  <interfaces>
    <interface name="PresetFileSystem" kind="abstract interface" path="lib/interfaces/preset_file_system.dart">
      <signature>Future&lt;Uint8List?&gt; readFile(String relativePath)</signature>
      <note>Reads file from SD card via SysEx - use for downloading plugin .elf files</note>
    </interface>
    <interface name="AlgorithmInfo" kind="class" path="lib/domain/disting_nt_sysex.dart">
      <signature>class AlgorithmInfo { String? filename; bool isPlugin; String guid; ... }</signature>
      <note>Contains filename field with SD card path when isPlugin is true</note>
    </interface>
    <interface name="PresetDependencies" kind="class" path="lib/models/preset_dependencies.dart">
      <signature>class PresetDependencies { Set&lt;String&gt; communityPlugins; /* add: Map&lt;String, String&gt; pluginPaths */ }</signature>
      <note>Must add pluginPaths field to store GUID → path mapping</note>
    </interface>
  </interfaces>

  <tests>
    <standards>Use flutter_test framework with mocktail for mocking. Tests should cover unit tests for model changes and service logic. No TDD required but new features should include tests for visibility.</standards>
    <locations>
      <location>test/models/</location>
      <location>test/services/</location>
    </locations>
    <ideas>
      <idea ac="1,3">Test PresetDependencies.pluginPaths field can store and retrieve GUID-to-path mappings</idea>
      <idea ac="2,3">Test extraction of plugin paths from mock AlgorithmInfo with isPlugin=true and non-null filename</idea>
      <idea ac="4,5">Test FileCollector uses pluginPaths entries to call fileSystem.readFile() with correct paths</idea>
      <idea ac="7">Test error handling when fileSystem.readFile() returns null - should add warning, not fail</idea>
      <idea ac="8">Test handling of various path formats returned by hardware</idea>
    </ideas>
  </tests>
</story-context>
