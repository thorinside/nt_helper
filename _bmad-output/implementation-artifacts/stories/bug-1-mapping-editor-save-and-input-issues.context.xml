<story-context id="bug-1-mapping-editor-save-and-input-issues" v="1.0">
  <metadata>
    <epicId>BUG</epicId>
    <storyId>1</storyId>
    <title>Mapping Editor Save and Input Issues</title>
    <status>drafted</status>
    <generatedAt>2025-11-01</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/bug-1-mapping-editor-save-and-input-issues.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user configuring MIDI parameter mappings</asA>
    <iWant>parameter changes to save reliably with clear visual feedback, and be able to enter negative values in Min/Max fields</iWant>
    <soThat>I can see when my changes are saved, my configuration changes persist without workarounds, and I can set the full range of valid values</soThat>
    <tasks>
      <task id="1">Fix negative number input for MIDI/I2C Min/Max fields</task>
      <task id="2">Fix autosave reliability for ALL editable fields (26 controls across 4 tabs)</task>
      <task id="3">Add widget tests for autosave on all TextFields (9 tests)</task>
      <task id="4">Add widget tests for autosave on all Dropdowns and Switches (12 tests)</task>
      <task id="5">Add widget test for save-on-dispose behavior (3 tests)</task>
      <task id="6">Add unit tests for negative number input (6 tests)</task>
      <task id="7">Implement dirty state indicator UI</task>
      <task id="8">Add widget tests for dirty state indicator (7 tests)</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">
      <title>Reliable Parameter Saving - All Fields</title>
      <details>ALL parameter changes save reliably across 26 controls: CV (Volts, Delta, Source, CV Input, Unipolar, Gate), MIDI (Channel, Type, CC, Min, Max, Enabled, Symmetric, Relative), I2C (CC, Min, Max, Enabled, Symmetric), Performance (Page). Changes persist when switching tabs, closing editor, or navigating away. Pending saves flushed before widget disposal.</details>
    </criterion>
    <criterion id="2">
      <title>Negative Number Input Support</title>
      <details>MIDI Min/Max and I2C Min/Max fields accept negative number input via keyboard (range: -32768 to 32767). Users can type minus sign directly on all platforms (iOS, Android, desktop).</details>
    </criterion>
    <criterion id="3">
      <title>Input Validation</title>
      <details>Invalid input rejected with clear feedback. Values outside valid ranges clamped to min/max bounds. Text fields display clamped/validated values after input.</details>
    </criterion>
    <criterion id="4">
      <title>Visual Dirty State Indicator</title>
      <details>Visible indicator shows unsaved changes (dirty state), saving state during debounce period, and turns off when save completes. Visible but non-intrusive placement.</details>
    </criterion>
    <criterion id="5">
      <title>Widget Test Coverage</title>
      <details>Widget tests verify all TextFields trigger autosave after debounce, all DropdownMenus/Switches trigger immediate autosave, save called before disposal, rapid edits collapse to single save.</details>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>nt_helper Brownfield Architecture Document</title>
        <section>Quick Reference - Key Files</section>
        <snippet>Documents critical files including lib/ui/widgets/packed_mapping_data_editor.dart for mapping editor, lib/cubit/disting_cubit.dart for state management, and test patterns using flutter_test framework.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Tech Stack</title>
        <section>Actual Tech Stack</section>
        <snippet>Flutter 3.35.1, Dart >=3.8.1, flutter_bloc ^9.1.1 for state management, flutter_test for widget testing.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>lib/ui/widgets/packed_mapping_data_editor.dart</path>
        <kind>widget</kind>
        <symbol>PackedMappingDataEditor</symbol>
        <lines>1-807</lines>
        <reason>Primary widget requiring fixes for autosave and negative input support. Contains debounce logic, TextField builders, and all 26 editable controls.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/widgets/packed_mapping_data_editor.dart</path>
        <kind>method</kind>
        <symbol>_triggerOptimisticSave</symbol>
        <lines>117-122</lines>
        <reason>Debounce implementation that needs flush-before-dispose mechanism.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/widgets/packed_mapping_data_editor.dart</path>
        <kind>method</kind>
        <symbol>_buildNumericField</symbol>
        <lines>785-805</lines>
        <reason>TextField builder using TextInputType.number that blocks negative input. Needs signed parameter.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/widgets/packed_mapping_data_editor.dart</path>
        <kind>method</kind>
        <symbol>dispose</symbol>
        <lines>100-115</lines>
        <reason>Widget disposal that cancels timer without flushing pending saves.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/widgets/mapping_editor_bottom_sheet.dart</path>
        <kind>widget</kind>
        <symbol>MappingEditorBottomSheet</symbol>
        <lines>1-59</lines>
        <reason>Container widget that wraps PackedMappingDataEditor and provides onSave callback to DistingCubit.</reason>
      </artifact>
      <artifact>
        <path>lib/models/packed_mapping_data.dart</path>
        <kind>model</kind>
        <symbol>PackedMappingData</symbol>
        <lines>all</lines>
        <reason>Data model with midiMin, midiMax, i2cMin, i2cMax fields supporting signed 16-bit range (-32768 to 32767).</reason>
      </artifact>
      <artifact>
        <path>test/ui/widgets/packed_mapping_data_editor_test.dart</path>
        <kind>test</kind>
        <symbol>PackedMappingDataEditor - 14-bit CC Support</symbol>
        <lines>1-150</lines>
        <reason>Existing widget tests showing pattern for testing PackedMappingDataEditor: tab navigation, dropdown selection, switch state verification.</reason>
      </artifact>
      <artifact>
        <path>lib/cubit/disting_cubit.dart</path>
        <kind>cubit</kind>
        <symbol>DistingCubit.saveMapping</symbol>
        <lines>referenced</lines>
        <reason>Target method called by onSave callback to persist mapping changes to hardware.</reason>
      </artifact>
    </code>

    <dependencies>
      <flutter>
        <package name="flutter" sdk="true" />
        <package name="flutter_test" sdk="true" />
        <package name="flutter_bloc" version="^9.1.1" />
      </flutter>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use existing flutter_test framework and widget test patterns from test/ui/widgets/packed_mapping_data_editor_test.dart</constraint>
    <constraint>Maintain 1-second debounce duration (_debounceDuration constant) for autosave</constraint>
    <constraint>All file changes must pass flutter analyze with zero warnings</constraint>
    <constraint>Preserve existing onSave callback mechanism to DistingCubit.saveMapping</constraint>
    <constraint>Use MaterialApp test harness pattern from existing tests</constraint>
    <constraint>Support all platforms: iOS, Android, macOS, Linux, Windows</constraint>
    <constraint>Follow existing Cubit state management patterns</constraint>
    <constraint>Maintain copyWith pattern for PackedMappingData immutability</constraint>
    <constraint>Preserve existing tab navigation and UI structure</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>PackedMappingDataEditor constructor</name>
      <kind>widget constructor</kind>
      <signature>PackedMappingDataEditor({Key? key, required PackedMappingData initialData, required ValueChanged&lt;PackedMappingData&gt; onSave, required List&lt;Slot&gt; slots, required int algorithmIndex, required int parameterNumber})</signature>
      <path>lib/ui/widgets/packed_mapping_data_editor.dart</path>
    </interface>
    <interface>
      <name>onSave callback</name>
      <kind>callback</kind>
      <signature>ValueChanged&lt;PackedMappingData&gt; onSave</signature>
      <path>lib/ui/widgets/packed_mapping_data_editor.dart</path>
    </interface>
    <interface>
      <name>_buildNumericField</name>
      <kind>method</kind>
      <signature>Widget _buildNumericField({required String label, required TextEditingController controller, required VoidCallback onSubmit, VoidCallback? onChanged})</signature>
      <path>lib/ui/widgets/packed_mapping_data_editor.dart:785</path>
    </interface>
    <interface>
      <name>TextInputType.numberWithOptions</name>
      <kind>Flutter API</kind>
      <signature>TextInputType.numberWithOptions({bool signed = false, bool decimal = false})</signature>
      <path>Flutter SDK</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use flutter_test framework with testWidgets for widget tests. Follow existing pattern from test/ui/widgets/packed_mapping_data_editor_test.dart: MaterialApp harness, tab navigation via tester.tap(find.text('MIDI')), widget finding via byType and byWidgetPredicate, state verification with expect(). Use tester.pumpAndSettle() for async state updates. Test debounced saves using fake_async or tester.pump(Duration) for time advancement.
    </standards>

    <locations>
      <location>test/ui/widgets/packed_mapping_data_editor_test.dart</location>
      <location>test/ui/widgets/</location>
      <location>test/models/packed_mapping_data_test.dart</location>
    </locations>

    <ideas>
      <idea criterion="1">Widget test: Change Volts TextField, verify onSave called after 1 second debounce</idea>
      <idea criterion="1">Widget test: Change MIDI Min TextField, verify onSave called with updated value</idea>
      <idea criterion="1">Widget test: Toggle MIDI Enabled switch, verify onSave called immediately (no debounce)</idea>
      <idea criterion="1">Widget test: Select MIDI Channel dropdown, verify onSave called immediately</idea>
      <idea criterion="1">Widget test: Rapid edits on same TextField collapse to single onSave after final debounce</idea>
      <idea criterion="1">Widget test: Dispose widget with pending save, verify onSave was flushed before dispose</idea>
      <idea criterion="2">Widget test: MIDI Min TextField accepts "-700" input via keyboard simulation</idea>
      <idea criterion="2">Widget test: I2C Max TextField accepts negative values with signed keyboard type</idea>
      <idea criterion="2">Unit test: _updateMidiMinFromController clamps value to -32768</idea>
      <idea criterion="2">Unit test: _updateMidiMaxFromController clamps value to 32767</idea>
      <idea criterion="3">Widget test: Invalid input displays validation error or reverts to previous value</idea>
      <idea criterion="4">Widget test: Dirty indicator appears when TextField changed</idea>
      <idea criterion="4">Widget test: Dirty indicator shows "saving" state during debounce</idea>
      <idea criterion="4">Widget test: Dirty indicator clears when onSave completes</idea>
      <idea criterion="4">Widget test: Dirty indicator persists across tab switches until save</idea>
      <idea criterion="5">Integration test: All 26 controls trigger save correctly in real cubit scenario</idea>
    </ideas>
  </tests>
</story-context>
