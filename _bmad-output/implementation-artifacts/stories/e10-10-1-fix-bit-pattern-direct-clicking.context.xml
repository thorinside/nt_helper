<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>e10</epicId>
    <storyId>10.1</storyId>
    <title>Fix Bit Pattern Direct Clicking</title>
    <status>pending</status>
    <generatedAt>2025-11-23</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/e10-10-1-fix-bit-pattern-direct-clicking.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Step Sequencer user</asA>
    <iWant>to toggle bit pattern segments by clicking directly on the 8-segment value bar</iWant>
    <soThat>I can edit Pattern and Ties parameters quickly without opening dialog boxes</soThat>
    <tasks>
      <task id="1" title="Enhance tap handler in step_column_widget.dart" acs="1,2,7">
        <subtask>Implement _calculateBitIndexFromTapPosition(dy, barHeight) method</subtask>
        <subtask>Implement _toggleBit(bitIndex) method</subtask>
        <subtask>Update _handleBarInteraction() to call bit toggling for Pattern/Ties modes</subtask>
        <subtask>Add bounds checking (ignore taps outside bar)</subtask>
        <subtask>Test segment boundary detection (edge cases)</subtask>
      </task>
      <task id="2" title="Remove BitPatternEditorDialog dependency" acs="6">
        <subtask>Delete lib/ui/widgets/step_sequencer/bit_pattern_editor_dialog.dart</subtask>
        <subtask>Remove any _showBitPatternEditorDialog() method calls in step_column_widget.dart</subtask>
        <subtask>Remove any imports of BitPatternEditorDialog</subtask>
      </task>
      <task id="3" title="Verify visual feedback" acs="4,5">
        <subtask>Confirm PitchBarPainter already supports bit pattern mode</subtask>
        <subtask>Test that tapping segment immediately updates fill color</subtask>
        <subtask>Verify Pattern mode uses blue color (Color(0xFF3b82f6))</subtask>
        <subtask>Verify Ties mode uses yellow color (Color(0xFFeab308))</subtask>
      </task>
      <task id="4" title="Test debouncing" acs="3">
        <subtask>Verify _updateParameter() uses existing ParameterWriteDebouncer (50ms)</subtask>
        <subtask>Test rapid clicking triggers only one parameter write after debounce period</subtask>
      </task>
      <task id="5" title="Test offline mode" acs="8">
        <subtask>Test bit toggles in offline mode</subtask>
        <subtask>Verify changes persist in dirty params map</subtask>
        <subtask>Verify sync on reconnect (if testable)</subtask>
      </task>
      <task id="6" title="Add widget tests" acs="9">
        <subtask>Add test: Tapping bottom segment toggles bit 0</subtask>
        <subtask>Add test: Tapping top segment toggles bit 7</subtask>
        <subtask>Add test: Tapping middle segments (bits 1-6)</subtask>
        <subtask>Add test: Toggling already-set bit clears it</subtask>
        <subtask>Add test: Segment boundary detection</subtask>
        <subtask>Add test: Tapping outside bar bounds does nothing</subtask>
        <subtask>Add test: Rapid tapping triggers debouncing</subtask>
        <subtask>Run all tests: flutter test</subtask>
      </task>
      <task id="7" title="Code quality validation" acs="10">
        <subtask>Run flutter analyze - must pass with zero warnings</subtask>
        <subtask>Test other parameter modes (Pitch, Velocity, Mod, Division) - no regressions</subtask>
        <subtask>Manual testing on hardware (if available) or demo mode</subtask>
      </task>
      <task id="8" title="Update story documentation" note="separate from this story, PM task">
        <subtask>Update e10-3-step-selection-and-editing.md (AC3.1)</subtask>
        <subtask>Update e10-9-implement-bit-pattern-editor-for-ties.md (AC #4, #5)</subtask>
        <subtask>Update e10-10-implement-bit-pattern-editor-for-pattern.md (AC #3, #4)</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1" title="Direct Segment Clicking for Bit Patterns">
      When global parameter mode = Pattern or Ties, tapping a specific segment in the step value bar toggles that bit (0→1 or 1→0) without opening any dialog.
    </criterion>
    <criterion id="AC2" title="Accurate Segment-to-Bit Mapping">
      Segment detection correctly maps tap position to bits 0-7:
      - Bit 0: Bottom segment (dy near barHeight)
      - Bit 7: Top segment (dy near 0)
      - Each segment: barHeight / 8
    </criterion>
    <criterion id="AC3" title="Debounced Parameter Updates">
      Bit toggle calls updateParameterValue(slotIndex, paramNumber, newValue) with 50ms debounce (existing ParameterWriteDebouncer).
    </criterion>
    <criterion id="AC4" title="Immediate Visual Feedback">
      Tapped segment immediately updates fill color in PitchBarPainter:
      - Set bit (1): Filled segment with parameter color (blue for Pattern, yellow for Ties)
      - Unset bit (0): Empty segment with gray outline
    </criterion>
    <criterion id="AC5" title="Multi-Mode Support">
      Works for both:
      - Pattern mode: Blue color scheme (Color(0xFF3b82f6))
      - Ties mode: Yellow color scheme (Color(0xFFeab308))
    </criterion>
    <criterion id="AC6" title="Remove Dialog Dependency">
      BitPatternEditorDialog widget is deleted entirely. No tap handler calls to the dialog for Pattern/Ties modes.
    </criterion>
    <criterion id="AC7" title="Bug Fix - Edge Case Handling">
      Tap position correctly detects segment boundaries:
      - Test tapping at segment edges (e.g., exactly at 1/8, 2/8, 3/8 bar height)
      - Test tapping outside bar bounds (should be ignored)
      - Test rapid tapping (verify debouncing prevents excessive writes)
    </criterion>
    <criterion id="AC8" title="Offline Mode Support">
      Bit toggles persist in dirty parameters map and sync when hardware reconnects (existing offline infrastructure).
    </criterion>
    <criterion id="AC9" title="Test Coverage">
      All existing tests pass + new tests for direct segment clicking:
      - Test tapping bottom segment toggles bit 0
      - Test tapping top segment toggles bit 7
      - Test tapping middle segments (bits 1-6)
      - Test toggling already-set bit clears it
      - Test segment boundary detection
      - Test debouncing with rapid clicks
    </criterion>
    <criterion id="AC10" title="Code Quality">
      - flutter analyze passes with zero warnings
      - No regressions in existing functionality (other parameter modes: Pitch, Velocity, Mod, Division)
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epics/epic-step-sequencer-ui.md" title="Epic 10: Visual Step Sequencer UI Widget" section="User Stories">
        Epic overview describing the Step Sequencer visual grid interface that replaces parameter lists. Story 3 (AC3.1) notes: "For bit pattern parameters (Pattern, Ties): User taps directly on value bar segments to toggle individual bits (no modal)."
      </doc>
      <doc path="docs/epics/epic-step-sequencer-ui-technical-context.md" title="Step Sequencer Technical Context" section="Bit Pattern Visualization">
        Technical architecture for bit pattern visualization including CustomPaint implementation. Documents PitchBarPainter with _paintBitPattern method that divides bar into 8 segments (bit 0 at bottom, bit 7 at top). Segment height = size.height / 8.
      </doc>
      <doc path="docs/sprint-artifacts/e10-9-implement-bit-pattern-editor-for-ties.md" title="Story 10.9: Bit Pattern Editor for Ties" section="Acceptance Criteria (UPDATED 2025-11-23)">
        Documents dialog-based approach (AC4, AC5) that has been superseded: "UPDATED: Tapping a specific segment of the step bar in Ties mode toggles that bit directly (0→1 or 1→0) without opening a dialog (see story e10.10.1)"
      </doc>
      <doc path="docs/stories/e10-10-implement-bit-pattern-editor-for-pattern.md" title="Story e10-10: Bit Pattern Editor for Pattern" section="Acceptance Criteria (UPDATED 2025-11-23)">
        Documents dialog-based approach (AC3, AC4) that has been superseded: "UPDATED: Step bar 8-segment visualization allows direct bit toggling via tap, using blue color scheme (Pattern color) (see story e10.10.1)"
      </doc>
      <doc path="docs/stories/e10-3-step-selection-and-editing.md" title="Story: Step Selection and Editing" section="AC3.1 (UPDATED 2025-11-23)">
        Describes modal editing for continuous parameters but notes for bit patterns: "For bit pattern parameters (Pattern, Ties): User taps directly on value bar segments to toggle individual bits (no modal). See story e10.10.1 for direct bit clicking implementation."
      </doc>
      <doc path="docs/architecture.md" title="nt_helper Architecture" section="Step Sequencer UI (Epic 10)">
        Complete architecture documentation for Step Sequencer including AlgorithmViewRegistry pattern, parameter discovery service, debouncing, offline mode support. Documents StepParameter enum and global parameter mode selector.
      </doc>
    </docs>
    <code>
      <artifact path="lib/ui/widgets/step_sequencer/step_column_widget.dart" kind="widget" symbol="StepColumnWidget" lines="1-415" reason="Primary implementation file - already implements direct bit clicking via _handleBitPatternTap() method at lines 230-241. Contains _isBitPatternMode() check and tap gesture handling.">
      </artifact>
      <artifact path="lib/ui/widgets/step_sequencer/pitch_bar_painter.dart" kind="painter" symbol="PitchBarPainter" lines="1-137" reason="CustomPaint visualization - _paintBitPattern() method (lines 88-120) renders 8-segment bit pattern display. Already supports Pattern (blue) and Ties (yellow) color schemes.">
      </artifact>
      <artifact path="lib/util/parameter_write_debouncer.dart" kind="utility" symbol="ParameterWriteDebouncer" lines="1-62" reason="Debouncing infrastructure - schedule() method provides 50ms debounce for parameter writes to prevent excessive MIDI traffic during rapid changes.">
      </artifact>
      <artifact path="lib/services/step_sequencer_params.dart" kind="service" symbol="StepSequencerParams" reason="Parameter discovery service - fromSlot() factory discovers parameter structure, provides getPattern() and getTies() methods for accessing bit pattern parameter indices.">
      </artifact>
      <artifact path="lib/cubit/disting_cubit.dart" kind="cubit" symbol="DistingCubit.updateParameterValue" reason="State management - updateParameterValue() method handles all parameter updates with offline mode support and dirty parameter tracking.">
      </artifact>
      <artifact path="test/ui/widgets/step_sequencer/step_column_widget_test.dart" kind="test" reason="Existing widget tests for step column - will need to add tests for direct bit clicking, segment boundary detection, and tap position mapping.">
      </artifact>
    </code>
    <dependencies>
      <flutter>
        <package name="flutter" version=">=3.35.1" usage="Core framework for UI rendering and gesture detection">
        </package>
        <package name="flutter_bloc" version="^9.1.1" usage="State management via Cubit pattern - BlocBuilder and context.read() for parameter updates">
        </package>
      </flutter>
      <dart>
        <package name="dart" sdk=">=3.8.1" usage="Core language features including async/await and Timer for debouncing">
        </package>
      </dart>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="code_quality">flutter analyze must pass with zero warnings before commit - zero tolerance policy</constraint>
    <constraint type="debugging">Always use debugPrint() for logging, never print() - debugPrint() throttles output and is stripped in release builds</constraint>
    <constraint type="testing">All existing tests must pass - broken tests must be fixed regardless of whether related to current changes</constraint>
    <constraint type="state_management">Use existing DistingCubit.updateParameterValue() for all parameter changes - no new state management required</constraint>
    <constraint type="offline_mode">Bit toggles must work identically in offline mode - OfflineDistingMidiManager handles dirty parameter tracking automatically</constraint>
    <constraint type="color_scheme">Pattern mode uses Color(0xFF3b82f6) blue, Ties mode uses Color(0xFFeab308) yellow - these are established in StepColumnWidget._getActiveParameterColor()</constraint>
    <constraint type="segment_mapping">Bit 0 at bottom segment, Bit 7 at top segment - consistent with PitchBarPainter._paintBitPattern() implementation</constraint>
    <constraint type="debouncing">Use 50ms debounce duration - established pattern in Epic 10, prevents MIDI flooding during rapid changes</constraint>
    <constraint type="architecture">No BitPatternEditorDialog widget exists - it was removed in the commit that implemented direct clicking (4655c98)</constraint>
  </constraints>

  <interfaces>
    <interface name="DistingCubit.updateParameterValue" kind="method" path="lib/cubit/disting_cubit.dart">
      <signature>void updateParameterValue({required int algorithmIndex, required int parameterNumber, required dynamic value, bool userIsChangingTheValue = false})</signature>
      <purpose>Updates parameter value with offline mode support, debouncing, and dirty parameter tracking</purpose>
    </interface>
    <interface name="StepSequencerParams.fromSlot" kind="factory" path="lib/services/step_sequencer_params.dart">
      <signature>StepSequencerParams.fromSlot(Slot slot)</signature>
      <purpose>Discovers parameter structure from slot data, provides getPattern(step) and getTies(step) methods</purpose>
    </interface>
    <interface name="PitchBarPainter" kind="class" path="lib/ui/widgets/step_sequencer/pitch_bar_painter.dart">
      <signature>PitchBarPainter({required int pitchValue, required Color barColor, BarDisplayMode displayMode, int minValue, int maxValue})</signature>
      <purpose>CustomPaint visualization with BarDisplayMode.bitPattern for 8-segment display, _paintBitPattern() method</purpose>
    </interface>
    <interface name="ParameterWriteDebouncer.schedule" kind="method" path="lib/util/parameter_write_debouncer.dart">
      <signature>void schedule(String key, void Function() callback, Duration delay)</signature>
      <purpose>Debounces parameter writes - cancels pending timer for key and schedules new one, ensures only final value written</purpose>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Testing framework: flutter_test with mocktail for mocking and bloc_test for Cubit testing. Widget tests use tester.pumpWidget() and tester.tap()/tester.tapAt() for gesture simulation. Tests must use MockDistingMidiManager to avoid hardware dependency. Existing pattern in test/ui/widgets/step_sequencer/step_column_widget_test.dart shows testing with BlocProvider and mock slot data. All tests run via 'flutter test' command.
    </standards>
    <locations>
      test/ui/widgets/step_sequencer/ - Widget tests for step sequencer components
      test/cubit/ - Cubit state management tests
      test/services/ - Service unit tests
    </locations>
    <ideas>
      <test id="test_bit0_toggle" acceptance_criteria="AC2,AC9">
        Test tapping bottom segment (dy near barHeight) toggles bit 0. Setup: Pattern mode, value = 0b00000000. Tap at Offset(30, 270) near bottom. Verify value becomes 0b00000001.
      </test>
      <test id="test_bit7_toggle" acceptance_criteria="AC2,AC9">
        Test tapping top segment (dy near 0) toggles bit 7. Setup: Ties mode, value = 0b00000000. Tap at Offset(30, 10) near top. Verify value becomes 0b10000000 (decimal 128).
      </test>
      <test id="test_middle_bits" acceptance_criteria="AC2,AC9">
        Test tapping middle segments toggles bits 1-6. Iterate through segment positions, verify correct bit index calculation. Each segment height = barHeight / 8.
      </test>
      <test id="test_toggle_set_bit" acceptance_criteria="AC9">
        Test toggling already-set bit clears it. Setup: value = 0b00001010 (bits 1 and 3 set). Tap bit 1 segment. Verify value becomes 0b00001000 (bit 1 cleared, bit 3 still set).
      </test>
      <test id="test_segment_boundaries" acceptance_criteria="AC7,AC9">
        Test tapping exactly at segment boundaries (1/8, 2/8, 3/8 bar height). Verify floor division correctly maps to bit indices with no off-by-one errors.
      </test>
      <test id="test_out_of_bounds" acceptance_criteria="AC7,AC9">
        Test tapping outside bar bounds (dy < 0 or dy > barHeight) does nothing. Verify value unchanged after tap.
      </test>
      <test id="test_debouncing" acceptance_criteria="AC3,AC9">
        Test rapid tapping triggers debouncing. Tap same segment 5 times rapidly with 10ms intervals. Verify only one updateParameterValue() call after 50ms debounce period.
      </test>
      <test id="test_pattern_mode_color" acceptance_criteria="AC5">
        Test Pattern mode uses blue color (0xFF3b82f6). Verify PitchBarPainter receives correct barColor when activeParameter = StepParameter.pattern.
      </test>
      <test id="test_ties_mode_color" acceptance_criteria="AC5">
        Test Ties mode uses yellow color (0xFFeab308). Verify PitchBarPainter receives correct barColor when activeParameter = StepParameter.ties.
      </test>
      <test id="test_visual_feedback" acceptance_criteria="AC4">
        Test tapped segment updates visual immediately. Verify CustomPaint rebuilds with new value after tap, filled segments match bit pattern.
      </test>
    </ideas>
  </tests>
</story-context>
