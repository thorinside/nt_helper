<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>5</storyId>
    <title>Replace I/O Pattern Matching with Flag Data</title>
    <status>drafted</status>
    <generatedAt>2025-11-18</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/7-5-replace-io-pattern-matching-with-flag-data.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer maintaining the nt_helper routing system</asA>
    <iWant>input/output direction and audio/CV type determined from I/O flag data instead of parameter name pattern matching</iWant>
    <soThat>the routing framework uses hardware-provided metadata as the single source of truth for port configuration</soThat>
    <tasks>
      - Remove artificial port types (PortType.gate, PortType.clock) from enum
      - Replace input/output detection pattern matching with isInput/isOutput flag checks
      - Replace port type pattern matching with isAudio flag checks
      - Update all routing classes (Poly, MultiChannel, ES5, specialized)
      - Preserve Width parameter special case handling
      - Update port visualization to differentiate audio vs CV colors
      - Verify connection compatibility (all types can connect)
      - Handle offline/mock mode fallback (ioFlags = 0)
      - Write unit tests for flag-based detection
      - Write integration tests with real hardware
      - Update documentation explaining I/O flag usage
      - Code quality validation (flutter analyze, all tests pass)
    </tasks>
  </story>

  <acceptanceCriteria>
    AC-1: Remove PortType.gate and PortType.clock from port type enum, keep only audio and cv
    AC-2: Replace lowerName.contains('output') pattern matching with ParameterInfo.isInput/isOutput flag checks
    AC-3: Replace lowerName.contains('cv'/'gate'/'clock') pattern matching with ParameterInfo.isAudio flag checks
    AC-4: Update all routing classes in lib/core/routing/ to use flags instead of pattern matching
    AC-5: Preserve Width parameter special case logic unchanged
    AC-6: Update port visualization colors (audio=warm/orange, cv=cool/blue)
    AC-7: Verify Port.isCompatibleWith() returns true for all types, Port.canConnectTo() only checks direction
    AC-8: Handle offline/mock mode with ioFlags=0 using fallback logic
    AC-9: Unit tests verify input/output/audio/cv detection from flags and fallback behavior
    AC-10: Integration tests verify correct port types with real hardware
    AC-11: Documentation updates explain flag usage and pattern matching removal
    AC-12: flutter analyze passes, all existing tests pass, no name-based pattern matching remains
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epic-7-context.md</path>
        <title>Epic 7 Technical Context</title>
        <section>Firmware Changes - I/O Flags</section>
        <snippet>Last byte of parameter info response contains both powerOfTen (bits 0-1) and ioFlags (bits 2-5). Bit layout: isInput (bit 0), isOutput (bit 1), isAudio (bit 2), isOutputMode (bit 3). These flags enable data-driven routing instead of pattern matching.</snippet>
      </doc>
      <doc>
        <path>docs/epic-7-context.md</path>
        <title>Epic 7 Technical Context</title>
        <section>Current Pattern Matching Problems</section>
        <snippet>Existing code uses lowerName.contains('output'), contains('cv'), contains('gate'), contains('clock') to infer port properties. This is fragile, breaks on name changes, and creates artificial gate/clock types that don't exist in hardware.</snippet>
      </doc>
      <doc>
        <path>docs/stories/7-3-add-io-flags-to-parameter-info.md</path>
        <title>Story 7.3 - Add I/O Flags to Parameter Info</title>
        <section>Acceptance Criteria - Data Model</section>
        <snippet>ParameterInfo now includes ioFlags field with helper getters: isInput (bit 0), isOutput (bit 1), isAudio (bit 2), isOutputMode (bit 3). Story 7.3 provides the foundation data that Story 7.5 consumes.</snippet>
      </doc>
      <doc>
        <path>CLAUDE.md</path>
        <title>Project Documentation</title>
        <section>Routing System Architecture</section>
        <snippet>Routing framework is data-driven with AlgorithmRouting.fromSlot() factory creating instances from live Slot data. Specialized implementations include PolyAlgorithmRouting, MultiChannelAlgorithmRouting, ES5DirectOutputAlgorithmRouting. ConnectionDiscoveryService discovers connections via bus assignments (1-12 inputs, 13-20 outputs).</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>lib/core/routing/models/port.dart</path>
        <kind>model</kind>
        <symbol>PortType enum</symbol>
        <lines>8-20</lines>
        <reason>Port type enum currently includes gate and clock types that must be removed. Only audio and cv should remain as they map to the isAudio hardware flag.</reason>
      </artifact>
      <artifact>
        <path>lib/core/routing/models/port.dart</path>
        <kind>model</kind>
        <symbol>Port.isCompatibleWith()</symbol>
        <lines>174-177</lines>
        <reason>Already returns true for all port types. Must verify this behavior is preserved after removing gate/clock types.</reason>
      </artifact>
      <artifact>
        <path>lib/core/routing/models/port.dart</path>
        <kind>model</kind>
        <symbol>Port.canConnectTo()</symbol>
        <lines>158-170</lines>
        <reason>Connection logic based on direction only. Must verify no type-based restrictions exist.</reason>
      </artifact>
      <artifact>
        <path>lib/core/routing/multi_channel_algorithm_routing.dart</path>
        <kind>routing</kind>
        <symbol>Port type inference</symbol>
        <lines>748-770</lines>
        <reason>Contains the primary pattern matching logic to replace. Lines 749-756 detect input/output via lowerName.contains(), lines 758-770 infer port type via contains('cv'/'gate'/'clock'). Must replace with isInput/isOutput/isAudio flag checks.</reason>
      </artifact>
      <artifact>
        <path>lib/core/routing/poly_algorithm_routing.dart</path>
        <kind>routing</kind>
        <symbol>PolyAlgorithmRouting</symbol>
        <reason>Specialized routing for polyphonic algorithms. Must search for pattern matching and replace with flag checks.</reason>
      </artifact>
      <artifact>
        <path>lib/core/routing/es5_direct_output_algorithm_routing.dart</path>
        <kind>routing</kind>
        <symbol>ES5DirectOutputAlgorithmRouting</symbol>
        <reason>Base class for ES-5 expander routing. Must search for pattern matching and replace with flag checks.</reason>
      </artifact>
      <artifact>
        <path>lib/core/routing/clock_algorithm_routing.dart</path>
        <kind>routing</kind>
        <symbol>ClockAlgorithmRouting</symbol>
        <reason>Specialized routing for clock algorithms. Must verify uses flag-based detection.</reason>
      </artifact>
      <artifact>
        <path>lib/core/routing/euclidean_algorithm_routing.dart</path>
        <kind>routing</kind>
        <symbol>EuclideanAlgorithmRouting</symbol>
        <reason>Specialized routing for Euclidean algorithms. Must verify uses flag-based detection.</reason>
      </artifact>
      <artifact>
        <path>lib/core/routing/algorithm_routing.dart</path>
        <kind>routing</kind>
        <symbol>AlgorithmRouting.fromSlot()</symbol>
        <reason>Factory method that creates routing instances from Slot data. Must understand how ParameterInfo with ioFlags flows through this factory.</reason>
      </artifact>
      <artifact>
        <path>lib/domain/models/parameter_info.dart</path>
        <kind>model</kind>
        <symbol>ParameterInfo with ioFlags</symbol>
        <reason>Source of truth for I/O flags from Story 7.3. Fields: isInput, isOutput, isAudio, isOutputMode getters.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/widgets/routing/port_widget.dart</path>
        <kind>widget</kind>
        <symbol>Port visualization</symbol>
        <reason>Must update port color rendering to use isAudio flag: warm color (orange) for audio, cool color (blue) for CV.</reason>
      </artifact>
    </code>
    <dependencies>
      <flutter>
        flutter sdk, freezed (^3.2.0), json_serializable (^6.10.0)
      </flutter>
      <testing>
        flutter_test sdk, mockito (^5.5.0), mocktail (^1.0.4), test (^1.26.2), bloc_test (^10.0.0)
      </testing>
      <stateManagement>
        flutter_bloc (via cubit pattern)
      </stateManagement>
    </dependencies>
  </artifacts>

  <constraints>
    - MUST remove PortType.gate and PortType.clock entirely - they are artificial types not present in hardware
    - MUST use ParameterInfo.isInput/isOutput/isAudio flags as the single source of truth
    - MUST NOT use parameter name pattern matching for I/O detection (no lowerName.contains())
    - MUST preserve Width parameter special case handling unchanged
    - MUST ensure audio and CV ports can connect to each other (no type restrictions)
    - MUST support offline/mock mode with ioFlags=0 using fallback logic
    - MUST pass flutter analyze with zero warnings
    - MUST not add debug logging statements
    - Audio vs CV distinction is cosmetic only (affects port color, not connectivity)
    - All routing logic lives in lib/core/routing/ OO framework
    - Port model uses typesafe direct properties (no generic metadata maps)
    - Story 7.6 will handle output mode parameter matching (separate concern)
  </constraints>

  <interfaces>
    <interface>
      <name>ParameterInfo.ioFlags</name>
      <kind>data model</kind>
      <signature>int ioFlags; bool get isInput => (ioFlags &amp; 1) != 0; bool get isOutput => (ioFlags &amp; 2) != 0; bool get isAudio => (ioFlags &amp; 4) != 0; bool get isOutputMode => (ioFlags &amp; 8) != 0;</signature>
      <path>lib/domain/models/parameter_info.dart</path>
    </interface>
    <interface>
      <name>PortType enum</name>
      <kind>enum</kind>
      <signature>enum PortType { audio, cv, gate, clock } // gate and clock must be removed</signature>
      <path>lib/core/routing/models/port.dart</path>
    </interface>
    <interface>
      <name>Port.isCompatibleWith()</name>
      <kind>method</kind>
      <signature>bool isCompatibleWith(Port other) // Returns true for all types (Eurorack is voltage-based)</signature>
      <path>lib/core/routing/models/port.dart</path>
    </interface>
    <interface>
      <name>Port.canConnectTo()</name>
      <kind>method</kind>
      <signature>bool canConnectTo(Port other) // Checks direction only, not type</signature>
      <path>lib/core/routing/models/port.dart</path>
    </interface>
    <interface>
      <name>AlgorithmRouting.fromSlot()</name>
      <kind>factory</kind>
      <signature>static AlgorithmRouting? fromSlot(Slot slot) // Creates routing instances from Slot data including ParameterInfo with ioFlags</signature>
      <path>lib/core/routing/algorithm_routing.dart</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing uses flutter_test SDK with mockito/mocktail for mocks and bloc_test for cubit testing. Tests are organized by layer: unit tests in test/core/routing/, integration tests in test/integration/, widget tests in test/ui/widgets/. Tests follow existing patterns in routing_implementations_test.dart and routing_editor_cubit_*_test.dart files. All tests must pass before commits with zero warnings from flutter analyze.
    </standards>
    <locations>
      test/core/routing/*_test.dart - Core routing unit tests
      test/cubit/routing_editor_cubit_*_test.dart - Routing editor cubit tests
      test/integration/*routing*_test.dart - Integration tests with hardware simulation
      test/ui/widgets/routing/*_test.dart - Routing UI widget tests
    </locations>
    <ideas>
      AC-1: Test PortType enum has only audio and cv values, verify gate/clock removed
      AC-2: Test input detection using isInput flag with various ioFlags values (1, 3, 5, etc)
      AC-2: Test output detection using isOutput flag with various ioFlags values (2, 3, 6, etc)
      AC-3: Test audio port type when isAudio=true (ioFlags with bit 2 set)
      AC-3: Test CV port type when isAudio=false (ioFlags with bit 2 clear)
      AC-4: Test MultiChannelAlgorithmRouting uses flags not pattern matching
      AC-4: Test PolyAlgorithmRouting uses flags not pattern matching
      AC-7: Test Port.isCompatibleWith() returns true for audio-audio, audio-cv, cv-cv connections
      AC-7: Test Port.canConnectTo() allows output-to-input regardless of type
      AC-8: Test fallback logic when ioFlags=0 (offline/mock mode)
      AC-9: Test no gate or clock port types are created in any routing class
      AC-10: Integration test with real hardware verifies Clock algorithm input uses isInput flag
      AC-10: Integration test verifies Poly CV outputs use isOutput and isAudio flags
    </ideas>
  </tests>
</story-context>
