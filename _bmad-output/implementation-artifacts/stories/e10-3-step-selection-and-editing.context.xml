<?xml version="1.0" encoding="UTF-8"?>
<story-context>
  <story-id>e10-3-step-selection-and-editing</story-id>
  <epic-id>epic-10</epic-id>
  <title>Step Selection and Editing</title>
  <created>2025-11-23</created>

  <objective>
    Implement interactive step editing modal for the Step Sequencer visual UI, allowing users to tap individual steps and edit their parameters (pitch, velocity, mod, division, pattern, ties, probability) with copy/paste/clear/randomize functionality.
  </objective>

  <dependencies>
    <dependency status="completed">
      <story-id>e10-1</story-id>
      <description>Widget registration and parameter discovery - provides StepSequencerParams service</description>
    </dependency>
    <dependency status="in-review">
      <story-id>e10-2</story-id>
      <description>Step grid component - provides StepColumnWidget to add tap handlers to</description>
    </dependency>
  </dependencies>

  <existing-code>
    <file path="lib/ui/step_sequencer_view.dart">
      <description>Main Step Sequencer widget view - container for grid</description>
      <key-points>
        - Uses StepGridView to display 16 steps
        - Passes slot and slotIndex to child widgets
        - Error handling with fallback UI
      </key-points>
    </file>

    <file path="lib/services/step_sequencer_params.dart">
      <description>Parameter discovery service - maps step numbers to parameter indices</description>
      <key-points>
        - fromSlot() factory discovers parameter structure
        - getPitch(step), getVelocity(step), getMod(step), etc.
        - getDivision(step), getPattern(step), getTies(step), getProbability(step)
        - Supports multiple naming patterns ("1. Pitch", "Step 1 Pitch", "1_Pitch")
        - Returns null if parameter not found (graceful degradation)
      </key-points>
    </file>

    <file path="lib/ui/widgets/step_sequencer/step_column_widget.dart">
      <description>Individual step column showing pitch bar and velocity</description>
      <key-points>
        - Currently StatelessWidget - needs tap handler added
        - Displays step number, pitch bar, velocity indicator
        - Theme-aware colors (dark mode support)
        - Will need to invoke modal on tap gesture
      </key-points>
    </file>

    <file path="lib/ui/widgets/step_sequencer/step_grid_view.dart">
      <description>Grid container that lays out 16 step columns</description>
      <key-points>
        - Creates StepSequencerParams from slot
        - Reads parameter values from slot.parameterValues map
        - Passes pitch/velocity values to StepColumnWidget
        - Uses BlocBuilder to rebuild on parameter changes
      </key-points>
    </file>

    <file path="lib/cubit/disting_cubit.dart">
      <description>Main state management - handles parameter updates</description>
      <key-points>
        - updateParameterValue(algorithmIndex, parameterNumber, value, userIsChangingTheValue) method
        - Takes slot index (algorithmIndex), parameter number, new value
        - Handles MIDI write, offline mode, dirty tracking
        - No debouncing at cubit level - caller's responsibility
      </key-points>
    </file>

    <file path="lib/cubit/disting_state.dart">
      <description>State classes including Slot model</description>
      <key-points>
        - Slot contains: algorithm, parameters, parameterValues map
        - parameterValues: Map&lt;int, int&gt; - parameter index to MIDI value
      </key-points>
    </file>
  </existing-code>

  <new-files>
    <file path="lib/ui/widgets/step_sequencer/step_edit_modal.dart">
      <description>Modal dialog for editing individual step parameters</description>
      <requirements>
        - StatefulWidget for local state (debouncer, copied params)
        - Accepts: slotIndex, stepIndex (0-15), params, slot
        - Displays all step parameters with sliders
        - Primary params: Pitch (slider + numeric + note name), Velocity, Mod
        - Advanced params: Division, Pattern, Ties, Probability
        - Action buttons: Copy, Paste, Clear, Randomize
        - 50ms debouncing on parameter changes using Timer
        - Responsive: center modal on desktop, bottom sheet on mobile
        - Theme colors consistent with app theme
      </requirements>
    </file>
  </new-files>

  <modified-files>
    <file path="lib/ui/widgets/step_sequencer/step_column_widget.dart">
      <change>Add GestureDetector or InkWell wrapper to detect taps</change>
      <change>Add onTap callback parameter to widget constructor</change>
      <change>Parent (StepGridView) will provide onTap handler that shows modal</change>
    </file>

    <file path="lib/ui/widgets/step_sequencer/step_grid_view.dart">
      <change>Add _showStepEditModal() method to display modal</change>
      <change>Pass onTap: () => _showStepEditModal(stepIndex) to StepColumnWidget</change>
      <change>Use showDialog() for desktop, showModalBottomSheet() for mobile</change>
      <change>Instantiate StepEditModal with required parameters</change>
    </file>
  </modified-files>

  <technical-approach>
    <debouncing>
      <implementation>
        - Use dart:async Timer in _StepEditModalState
        - Map&lt;String, Timer&gt; to track timers per parameter
        - Cancel previous timer when new value comes in
        - Schedule MIDI write after 50ms of no changes
        - Dispose all timers in dispose() method
      </implementation>
      <rationale>
        - Prevents excessive MIDI writes during slider drag
        - DistingCubit doesn't provide debouncing
        - UI-level debouncing appropriate for interactive widgets
      </rationale>
    </debouncing>

    <copy-paste>
      <implementation>
        - Store copied values in Map&lt;String, int&gt; _copiedParams
        - Copy: Read all parameter values from slot.parameterValues
        - Paste: Write all copied values via updateParameterValue
        - Store in widget state (not persisted across app restarts)
      </implementation>
    </copy-paste>

    <clear>
      <implementation>
        - Show confirmation dialog before clearing
        - Default values: Pitch=60 (C4), Velocity=100, others=0
        - Update all step parameters to defaults
      </implementation>
    </clear>

    <randomize>
      <implementation>
        - Pitch: Random value 36-96 (C2-C7) - musical range
        - Velocity: Random value 40-127 (avoid very soft notes)
        - Mod: Random value based on parameter range
        - Other params: Random within spec ranges
        - Future: Check if quantize enabled and snap to scale
      </implementation>
    </randomize>

    <responsive-design>
      <desktop>
        - Use showDialog with centered AlertDialog
        - Max width 600px
        - Scrollable content if needed
      </desktop>
      <mobile>
        - Use showModalBottomSheet
        - Slides up from bottom
        - Takes 80% of screen height
        - Scrollable content
      </mobile>
      <detection>
        - MediaQuery.of(context).size.width
        - Mobile if width &lt;= 768px
      </detection>
    </responsive-design>

    <note-name-conversion>
      <implementation>
        - Create helper: String midiNoteToName(int midiNote)
        - Octave = midiNote ~/ 12 - 1
        - Note = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'][midiNote % 12]
        - Return "$Note$Octave" (e.g., "C4" for MIDI 60)
      </implementation>
    </note-name-conversion>
  </technical-approach>

  <acceptance-criteria>
    <ac id="3.1">
      <description>Tap step → opens modal with all per-step parameters</description>
      <verification>
        - Tap any step column in grid
        - Modal appears (dialog on desktop, bottom sheet on mobile)
        - Modal header shows "Edit Step X" (1-indexed)
        - All parameter controls visible
      </verification>
    </ac>

    <ac id="3.2">
      <description>Modal shows: Pitch (slider + numeric), Velocity (slider), Mod (slider)</description>
      <verification>
        - Pitch slider (0-127) with numeric value and note name display
        - Velocity slider (0-127) with numeric value
        - Mod slider with appropriate range
        - Current values loaded from slot state
      </verification>
    </ac>

    <ac id="3.3">
      <description>Modal shows advanced: Division, Pattern, Ties, Probability sliders</description>
      <verification>
        - Advanced parameters section present
        - Division, Pattern, Ties, Probability controls
        - All controls functional and show current values
      </verification>
    </ac>

    <ac id="3.4">
      <description>Changes call cubit.updateParameterValue()</description>
      <verification>
        - Slider changes trigger parameter updates
        - Parameters correctly resolved via StepSequencerParams
        - Updates debounced (50ms - final value written after drag)
        - Local state updates immediately for smooth UI
      </verification>
    </ac>

    <ac id="3.5">
      <description>Modal has Copy/Paste/Clear/Randomize buttons</description>
      <verification>
        - All four buttons present and labeled
        - Copy: Stores current step params
        - Paste: Applies stored params to current step
        - Clear: Resets to defaults (with confirmation)
        - Randomize: Generates musical random values
      </verification>
    </ac>

    <ac id="3.6">
      <description>Close modal → changes persist, auto-sync triggers</description>
      <verification>
        - Close button or tap outside dismisses modal
        - Changes already persisted (no explicit save needed)
        - Auto-sync happens via debouncer
        - No memory leaks (timers disposed)
      </verification>
    </ac>
  </acceptance-criteria>

  <testing-requirements>
    <unit-tests>
      <test>Debounce timer cancels previous timer</test>
      <test>Copy stores all parameter values correctly</test>
      <test>Paste applies all stored values</test>
      <test>Clear uses correct default values</test>
      <test>Randomize generates values within valid ranges</test>
      <test>MIDI note to name conversion (60 → "C4")</test>
    </unit-tests>

    <widget-tests>
      <test>Modal opens when step column tapped</test>
      <test>All sliders render with correct initial values</test>
      <test>All buttons present and enabled</test>
      <test>Modal closes on dismiss action</test>
      <test>Slider changes update displayed value</test>
    </widget-tests>

    <integration-tests>
      <test>Full workflow: open modal → edit pitch → close → verify value persisted</test>
      <test>Copy/paste between different steps</test>
      <test>Clear with confirmation dialog flow</test>
      <test>Randomize multiple parameters at once</test>
    </integration-tests>
  </testing-requirements>

  <out-of-scope>
    <item>Keyboard shortcuts for copy/paste (Cmd+C, Cmd+V) - future enhancement</item>
    <item>Multi-step selection and batch editing - future enhancement</item>
    <item>Undo/redo functionality - requires global undo stack</item>
    <item>Step parameter presets/templates - separate feature</item>
    <item>Visual pitch curve drawing - advanced gesture control</item>
    <item>Scale quantization integration - handled in Story 4</item>
  </out-of-scope>

  <risk-assessment>
    <risk level="low">
      <description>Debouncing complexity</description>
      <mitigation>Use simple Timer-based approach, well-tested pattern</mitigation>
    </risk>
    <risk level="low">
      <description>Responsive modal positioning</description>
      <mitigation>Use standard Flutter showDialog/showModalBottomSheet patterns</mitigation>
    </risk>
    <risk level="medium">
      <description>Parameter discovery may fail for some parameters</description>
      <mitigation>StepSequencerParams returns null for missing params, UI disables controls</mitigation>
    </risk>
  </risk-assessment>

  <definition-of-done>
    <item>All 6 acceptance criteria implemented and verified</item>
    <item>Unit tests written and passing</item>
    <item>Widget tests written and passing</item>
    <item>Integration test for full editing workflow passing</item>
    <item>flutter analyze passes with zero warnings</item>
    <item>Tested on both mobile and desktop layouts</item>
    <item>Dark mode support verified</item>
    <item>Code reviewed and approved</item>
    <item>Documentation updated (inline comments)</item>
  </definition-of-done>
</story-context>
