<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>10</epicId>
    <storyId>16</storyId>
    <title>Add Division Subdivision Display</title>
    <status>drafted</status>
    <generatedAt>2025-11-23</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/e10-16-add-division-subdivision-display.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Step Sequencer user</asA>
    <iWant>to see the number of subdivisions and their type (Ratchets/Repeats) below the Division parameter</iWant>
    <soThat>I can quickly understand how many substeps are active and whether the step will ratchet or repeat</soThat>
    <tasks>
      - Add subdivision calculation logic (_calculateSubdivisions, _getSubdivisionLabel)
      - Update step column widget to show subdivision label
      - Wire subdivision label to Division parameter value
      - Handle edge cases (Division = 7, out of range)
      - Responsive layout integration
      - Add theme support (light/dark mode)
      - Optional tooltip for ratchet vs repeat explanation
      - Add unit and widget tests
      - Update documentation
      - Code quality validation (flutter analyze, tests passing)
    </tasks>
  </story>

  <acceptanceCriteria>
    AC1: Division parameter baseline (range 0-14, default 7, values <7 are ratchets, >7 are repeats)
    AC2: Subdivision count calculation formula: subdivisions = |Division - 7| + 1
    AC3: Subdivision label display showing "X Ratchets" (Division < 7), "X Repeats" (Division > 7), "1" or hidden (Division = 7)
    AC4: Visual integration - label visible only when Division mode active, updates immediately
    AC5: Correlation with Pattern and Ties bits (1-8 subdivisions = 1-8 active bits)
    AC6: Interaction behavior - label is read-only, no tap handling
    AC7: Ratchet vs Repeat semantics accurately reflected in label text
    AC8: Edge case handling (Division = 7, out of range, missing parameter)
    AC9: Performance - calculation < 1ms, no layout thrashing
    AC10: Theme and accessibility support (dark mode, font scaling)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-10.md</path>
        <title>Epic: Visual Step Sequencer UI Widget</title>
        <section>Story 16</section>
        <snippet>Story 16 adds subdivision display below Division parameter showing ratchet/repeat count. Division parameter semantics: 7 is default (no subdivision), <7 creates ratchets (fast subdivided notes), >7 creates repeats (multiple sustained notes). Subdivision count formula: |Division - 7| + 1.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>nt_helper Brownfield Architecture</title>
        <section>Step Sequencer UI Architecture</section>
        <snippet>Step Sequencer uses custom widget replacing parameter list. Widget hierarchy: StepSequencerView > StepGridView > StepColumnWidget (16 columns). PitchBarPainter handles custom painting. State managed via DistingCubit. Responsive layout with mobile horizontal scroll and desktop full grid view.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>lib/ui/widgets/step_sequencer/step_column_widget.dart</path>
        <kind>widget</kind>
        <symbol>StepColumnWidget</symbol>
        <lines></lines>
        <reason>Primary widget that displays step columns including Division values. Needs modification to add subdivision label below Division value display.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/widgets/step_sequencer/step_grid_view.dart</path>
        <kind>widget</kind>
        <symbol>StepGridView</symbol>
        <lines></lines>
        <reason>Grid container managing 16 step columns. May need updates to ensure subdivision label visibility and layout integration.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/widgets/step_sequencer/pitch_bar_painter.dart</path>
        <kind>custom_painter</kind>
        <symbol>PitchBarPainter</symbol>
        <lines></lines>
        <reason>Custom painter for parameter visualization. Reference for understanding current rendering approach. Subdivision label will be a Text widget, not painted.</reason>
      </artifact>
      <artifact>
        <path>lib/services/step_sequencer_params.dart</path>
        <kind>service</kind>
        <symbol>StepSequencerParams</symbol>
        <lines>1-100</lines>
        <reason>Parameter discovery service for Step Sequencer. getDivision(step) method retrieves Division parameter values. Required for subdivision calculation.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/step_sequencer_view.dart</path>
        <kind>widget</kind>
        <symbol>StepSequencerView</symbol>
        <lines></lines>
        <reason>Top-level Step Sequencer widget. Contains mode selector logic that determines when Division mode is active.</reason>
      </artifact>
    </code>
    <dependencies>
      <dart>
        flutter: sdk
        flutter_bloc: ^9.1.1 (state management)
        equatable: ^2.0.7 (value equality)
      </dart>
    </dependencies>
  </artifacts>

  <constraints>
    - Zero tolerance for flutter analyze errors
    - All tests must pass before commit
    - Reuse existing widget patterns from Step Sequencer UI (Epic 10)
    - Label is purely informational (non-interactive, read-only)
    - Text styling: smaller font (10-12px), secondary color with opacity 0.7
    - Responsive: label must fit within step column width on mobile and desktop
    - Performance: calculation must be simple math, no caching needed
    - Theme-aware: respect light/dark mode and font scaling preferences
  </constraints>

  <interfaces>
    <interface>
      <name>StepSequencerParams.getDivision(int step)</name>
      <kind>service_method</kind>
      <signature>ParameterInfo? getDivision(int step)</signature>
      <path>lib/services/step_sequencer_params.dart</path>
    </interface>
    <interface>
      <name>Theme.of(context)</name>
      <kind>flutter_theme</kind>
      <signature>ThemeData Theme.of(BuildContext context)</signature>
      <path>flutter/material</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Flutter widget tests and unit tests. Use mocktail for mocking. Test file naming: *_test.dart in test/ directory mirroring lib/ structure. Widget tests use testWidgets, unit tests use test. BlocTest for cubit testing.</standards>
    <locations>test/ui/widgets/step_sequencer/, test/services/</locations>
    <ideas>
      AC2: Unit tests for _calculateSubdivisions() with values 0, 6, 7, 8, 14
      AC2: Unit tests for _getSubdivisionLabel() returning "8 Ratchets", "1", "8 Repeats"
      AC3: Widget test verifying subdivision label renders with correct text
      AC4: Widget test verifying label visible in Division mode, hidden in other modes
      AC4: Widget test verifying label updates when Division value changes
      AC8: Edge case tests for Division = 7, out of range values
      AC10: Widget test verifying theme color usage and dark mode support
    </ideas>
  </tests>
</story-context>
