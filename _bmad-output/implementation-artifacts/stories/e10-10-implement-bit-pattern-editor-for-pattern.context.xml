<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>10</epicId>
    <storyId>10</storyId>
    <title>Implement Bit Pattern Editor for Pattern</title>
    <status>drafted</status>
    <generatedAt>2025-11-23</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/e10-10-implement-bit-pattern-editor-for-pattern.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Step Sequencer user</asA>
    <iWant>to edit the Pattern parameter using the same bit pattern editor as Ties</iWant>
    <soThat>I can control which substeps play when Division > 0 using an intuitive visual interface</soThat>
    <tasks>
- [ ] Verify Pattern parameter discovery (AC: #5)
  - [ ] Check `StepSequencerParams.getPattern(step)` method exists
  - [ ] Verify Pattern parameter indices discoverable from slot data
  - [ ] Add logging to confirm Pattern parameters found for all 16 steps

- [ ] Update bit pattern visualization for Pattern mode (AC: #1, #2, #6, #7)
  - [ ] Confirm `PitchBarPainter` already supports bit pattern mode (implemented in Story 10.9)
  - [ ] Verify Pattern mode uses blue color (Color(0xFF3b82f6))
  - [ ] Test rendering: filled segments = substep plays, empty = substep muted

- [ ] Integrate Pattern parameter with bit pattern editor (AC: #3, #4, #5, #8, #9, #10)
  - [ ] Verify `_isBitPatternMode()` in step_column_widget.dart includes Pattern check
  - [ ] Update bit pattern editor color when parameter = Pattern (use blue Color(0xFF3b82f6))
  - [ ] Update dialog title: "Edit Pattern Bit Pattern"
  - [ ] Update help text to explain substep on/off behavior:
    - "Each bit controls whether a substep plays (1) or is muted (0)."
    - "Bit 0 = substep 0, Bit 1 = substep 1, etc."
    - "Only relevant when Division > 0 (multiple notes per step)."

- [ ] Test Pattern parameter behavior (AC: #11, #12, #13)
  - [ ] Test with Division = 0: verify Pattern has no audible effect
  - [ ] Test with Division = 1-14: verify Pattern controls which substeps play
  - [ ] Example test case:
    - Step 1: Division = 3 (4 substeps), Pattern = 0b00001010 (bits 1 and 3 set)
    - Expected: Only substeps 1 and 3 play, substeps 0 and 2 muted
  - [ ] Verify debouncing: rapid bit toggles â†’ single write after 50ms
  - [ ] Test offline mode: edits persist, sync on reconnect

- [ ] Validation and cleanup (AC: all)
  - [ ] Run `flutter analyze` (must pass with zero warnings)
  - [ ] Run tests: `flutter test test/ui/widgets/step_sequencer/step_column_widget_test.dart`
  - [ ] Manual testing on hardware (if available)
  - [ ] Verify Pattern and Ties modes both work correctly
  - [ ] Test switching between Pattern/Ties modes (different colors, different help text)
</tasks>
  </story>

  <acceptanceCriteria>
1. When global parameter mode = "Pattern", step bars show 8-segment bit pattern visualization (same as Ties)
2. Each segment represents one substep on/off state (bits 0-7, LSB to MSB)
3. Tapping a step bar in Pattern mode opens the bit pattern editor overlay
4. Bit pattern editor shows 8 toggle buttons (horizontal layout) with blue color scheme (Pattern color)
5. Toggling a bit updates the Pattern parameter value (0-255) via `updateParameterValue()`
6. Current Pattern value from hardware displays correctly as bit pattern
7. Step bar shows visual summary: filled segments (blue) for set bits (substep plays), empty (gray) for unset bits (substep muted)
8. Pattern parameter follows same interaction pattern as Ties (tap to edit, debounced write)
9. Editor dialog title shows "Edit Pattern Bit Pattern"
10. Editor dialog help text explains substep on/off semantics
11. When Division = 0, Pattern parameter has no effect (all 8 substeps irrelevant)
12. Works with existing debounce system (50ms)
13. Offline mode: changes persist and sync when hardware reconnects
</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-step-sequencer-ui.md</path>
        <title>Epic: Visual Step Sequencer UI Widget</title>
        <section>User Stories</section>
        <snippet>Epic 10 defines the overall vision for the Step Sequencer visual grid interface. This story implements Pattern parameter bit pattern editing, completing the dual-mode bit pattern editor alongside Story 10.9 (Ties).</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-step-sequencer-ui-technical-context.md</path>
        <title>Technical Context: Step Sequencer UI Epic</title>
        <section>Bit Pattern Visualization (Stories 10.9-10.10)</section>
        <snippet>Pattern Parameter controls which substeps are active/muted when Division > 0. Bit 0 (LSB) = substep 0, Bit 7 (MSB) = substep 7. Example: 0b10101010 (170) = alternating substeps. Visualization uses 8-segment CustomPaint with blue color scheme.</snippet>
      </doc>
      <doc>
        <path>docs/stories/e10-9-implement-bit-pattern-editor-for-ties.md</path>
        <title>Story e10-9: Implement Bit Pattern Editor for Ties</title>
        <section>Implementation Status</section>
        <snippet>Story 10.9 implemented the bit pattern editor infrastructure (BitPatternEditorDialog, PitchBarPainter bit pattern mode, _isBitPatternMode() checks). Story 10.10 extends this for Pattern parameter with blue color and substep on/off semantics.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>lib/services/step_sequencer_params.dart</path>
        <kind>service</kind>
        <symbol>StepSequencerParams.getPattern(int step)</symbol>
        <lines>125</lines>
        <reason>Parameter discovery service that provides Pattern parameter indices for each step. Already implemented and working.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/widgets/step_sequencer/step_column_widget.dart</path>
        <kind>widget</kind>
        <symbol>_isBitPatternMode()</symbol>
        <lines>183-186</lines>
        <reason>Checks if current mode is bit pattern (Pattern or Ties). Already includes Pattern check from Story 10.9.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/widgets/step_sequencer/step_column_widget.dart</path>
        <kind>widget</kind>
        <symbol>_getActiveParameterColor()</symbol>
        <lines>397-420</lines>
        <reason>Returns color for each parameter type. Pattern uses blue Color(0xFF3b82f6), Ties uses yellow Color(0xFFeab308).</reason>
      </artifact>
      <artifact>
        <path>lib/ui/widgets/step_sequencer/pitch_bar_painter.dart</path>
        <kind>painter</kind>
        <symbol>_paintBitPattern(Canvas canvas, Size size)</symbol>
        <lines>88-120</lines>
        <reason>CustomPainter that renders 8-segment bit pattern visualization. Already implemented for Ties in Story 10.9, works for Pattern with color parameter.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/widgets/step_sequencer/bit_pattern_editor_dialog.dart</path>
        <kind>dialog</kind>
        <symbol>BitPatternEditorDialog</symbol>
        <lines>1-159</lines>
        <reason>Modal dialog with 8 toggle buttons for editing bit patterns. Already implemented in Story 10.9. Uses parameterName and color props for customization.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/widgets/step_sequencer/step_column_widget.dart</path>
        <kind>widget</kind>
        <symbol>_showBitPatternEditor()</symbol>
        <lines>213-231</lines>
        <reason>Shows bit pattern editor dialog. Passes parameterName ('Ties' or 'Pattern') and color to dialog. Already handles both parameter types.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/widgets/step_sequencer/step_column_widget.dart</path>
        <kind>widget</kind>
        <symbol>_handleBitPatternTap(double localY, double barHeight)</symbol>
        <lines>280-291</lines>
        <reason>Handles tap on bit pattern bar to toggle individual bits. Works for both Pattern and Ties parameters.</reason>
      </artifact>
    </code>
    <dependencies>
      <flutter>
        <package name="flutter_bloc" version="^9.1.1">State management for DistingCubit</package>
        <package name="freezed" version="^3.2.0">Immutable data classes</package>
      </flutter>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Zero tolerance for flutter analyze warnings/errors - must pass before commit</constraint>
    <constraint>Pattern parameter semantics: only relevant when Division > 0 (substeps exist). When Division = 0, Pattern has no audible effect.</constraint>
    <constraint>Bit pattern visualization: Bit 0 (LSB) at bottom, Bit 7 (MSB) at top of bar. Filled segment = substep plays, empty = substep muted.</constraint>
    <constraint>Color scheme: Pattern uses blue Color(0xFF3b82f6), different from Ties yellow Color(0xFFeab308)</constraint>
    <constraint>Dialog title differentiation: "Edit Pattern Bit Pattern" vs "Edit Ties Bit Pattern"</constraint>
    <constraint>Help text semantics: Pattern explains substep on/off (gate), Ties explains substep ties (legato)</constraint>
    <constraint>Debouncing: 50ms debounce on all parameter updates via existing ParameterWriteDebouncer</constraint>
    <constraint>Offline mode support: automatic via OfflineDistingMidiManager dirty parameter tracking</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>StepSequencerParams.getPattern(int step)</name>
      <kind>service method</kind>
      <signature>int? getPattern(int step)</signature>
      <path>lib/services/step_sequencer_params.dart</path>
    </interface>
    <interface>
      <name>DistingCubit.updateParameterValue</name>
      <kind>cubit method</kind>
      <signature>void updateParameterValue({required int algorithmIndex, required int parameterNumber, required dynamic value, required bool userIsChangingTheValue})</signature>
      <path>lib/cubit/disting_cubit.dart</path>
    </interface>
    <interface>
      <name>PitchBarPainter</name>
      <kind>CustomPainter</kind>
      <signature>PitchBarPainter({required int pitchValue, required Color barColor, BarDisplayMode displayMode = BarDisplayMode.continuous, int minValue = 0, int maxValue = 127})</signature>
      <path>lib/ui/widgets/step_sequencer/pitch_bar_painter.dart</path>
    </interface>
    <interface>
      <name>BitPatternEditorDialog</name>
      <kind>StatefulWidget</kind>
      <signature>BitPatternEditorDialog({required int initialValue, required String parameterName, required Color color})</signature>
      <path>lib/ui/widgets/step_sequencer/bit_pattern_editor_dialog.dart</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
Test with MockDistingMidiManager when possible to avoid hardware dependency. Use flutter_test, mocktail, and bloc_test packages. Follow existing patterns in test/ui/widgets/step_sequencer/. Not full TDD - pragmatic testing to ensure functionality works.
</standards>
    <locations>
      <location>test/ui/widgets/step_sequencer/step_column_widget_test.dart</location>
      <location>test/services/step_sequencer_params_test.dart</location>
    </locations>
    <ideas>
      <idea ac="1,2,6,7">Test bit pattern visualization: verify _paintBitPattern() renders 8 segments, filled for set bits, empty for unset bits</idea>
      <idea ac="3,4,5,8">Test bit pattern editor integration: verify tapping step bar in Pattern mode opens dialog, toggling bits updates parameter via updateParameterValue()</idea>
      <idea ac="9,10">Test dialog customization: verify title shows "Edit Pattern Bit Pattern" and help text explains substep on/off semantics</idea>
      <idea ac="11">Test Pattern with Division = 0: verify Pattern parameter exists but has no effect on playback (hardware behavior, manual testing)</idea>
      <idea ac="12">Test debouncing: verify rapid bit toggles result in single MIDI write after 50ms delay</idea>
      <idea ac="13">Test offline mode: verify Pattern edits persist in dirty parameters map and sync on reconnect</idea>
    </ideas>
  </tests>
</story-context>
