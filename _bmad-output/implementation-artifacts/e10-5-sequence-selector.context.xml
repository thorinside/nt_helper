<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>10</epicId>
    <storyId>5</storyId>
    <title>Sequence Selector</title>
    <status>drafted</status>
    <generatedAt>2025-11-23</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/e10-5-sequence-selector.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a user</asA>
    <iWant>to switch between 32 stored sequences</iWant>
    <soThat>I can build songs from multiple patterns</soThat>
    <tasks>
      <task id="1" acs="5.1,5.3">Create SequenceSelector widget</task>
      <task id="2" acs="5.2">Add sequence parameter discovery to StepSequencerParams</task>
      <task id="3" acs="5.2,5.4">Integrate sequence selection into StepSequencerView</task>
      <task id="4" acs="5.3">Handle sequence switch workflow</task>
      <task id="5" acs="5.5">Sequence naming support (if firmware supports)</task>
      <task id="6" acs="all">Testing</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC5.1">Dropdown showing "Sequence 1-32" with optional names</criterion>
    <criterion id="AC5.2">Selecting sequence loads its 16 steps from hardware</criterion>
    <criterion id="AC5.3">Loading state shown during sequence switch</criterion>
    <criterion id="AC5.4">Currently active sequence persists in cubit state</criterion>
    <criterion id="AC5.5">Sequence names editable (if firmware supports)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics/epic-step-sequencer-ui.md</path>
        <title>Epic: Visual Step Sequencer UI Widget</title>
        <section>Story 5: Sequence Selector</section>
        <snippet>As a user, I want to switch between 32 stored sequences, so that I can build songs from multiple patterns. Dropdown showing "Sequence 1-32" with optional names, selecting sequence loads its 16 steps from hardware.</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-step-sequencer-ui-technical-context.md</path>
        <title>Technical Context: Step Sequencer UI Epic</title>
        <section>Parameter Mapping Strategy</section>
        <snippet>Step Sequencer has 50+ parameters organized as per-step parameters (16 steps) and global parameters including Current Sequence (1-32). Parameter discovery uses StepSequencerParams.fromSlot() to build parameter index map.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>nt_helper Brownfield Architecture Document</title>
        <section>State Management Patterns</section>
        <snippet>Cubit pattern throughout. Use async/await not .then(). States defined with freezed. Emit new states, never mutate. Local StatefulWidget state for transient UI concerns.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>lib/services/step_sequencer_params.dart</path>
        <kind>service</kind>
        <symbol>StepSequencerParams</symbol>
        <lines>1-160</lines>
        <reason>Parameter discovery service - already has global parameter getters including currentSequence. Need to verify Current Sequence parameter exists and add convenience method.</reason>
      </artifact>
      <artifact>
        <path>lib/ui/step_sequencer_view.dart</path>
        <kind>widget</kind>
        <symbol>StepSequencerView</symbol>
        <lines>1-100</lines>
        <reason>Main Step Sequencer widget - needs to add currentSequence local state and sequence change handler. Already has pattern for local state (snapEnabled, selectedScale, rootNote).</reason>
      </artifact>
      <artifact>
        <path>lib/ui/widgets/step_sequencer/quantize_controls.dart</path>
        <kind>widget</kind>
        <symbol>QuantizeControls</symbol>
        <lines>1-50</lines>
        <reason>Reference for header control widget pattern - dropdown styling, responsive layout (desktop/mobile), theme colors. Use as template for SequenceSelector widget.</reason>
      </artifact>
      <artifact>
        <path>lib/cubit/disting_cubit.dart</path>
        <kind>cubit</kind>
        <symbol>updateParameterValue</symbol>
        <lines>1130</lines>
        <reason>Method to call for updating hardware parameter when user selects new sequence. Signature: updateParameterValue({required int slotIndex, required int paramNumber, required dynamic value})</reason>
      </artifact>
    </code>
    <dependencies>
      <flutter>
        <package name="flutter" version="sdk" />
        <package name="flutter_bloc" version="^9.1.1" />
      </flutter>
      <dart>
        <package name="freezed_annotation" version="^3.1.0" />
      </dart>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>MUST follow existing dropdown pattern from QuantizeControls: use initialValue not deprecated value property</constraint>
    <constraint>Local state for currentSequence in StepSequencerView (not persisted to cubit) - only hardware parameter value persists</constraint>
    <constraint>Use teal theme color (#14b8a6) for active states, grey for disabled/loading</constraint>
    <constraint>Responsive layout: full dropdown on desktop, compact on mobile (width &lt;= 768px)</constraint>
    <constraint>Loading indicator must be small CircularProgressIndicator (20x20, strokeWidth: 2)</constraint>
    <constraint>flutter analyze MUST pass with zero warnings before commit</constraint>
    <constraint>Use debugPrint for logging, never print()</constraint>
    <constraint>Show SnackBar for error messages</constraint>
    <constraint>Current Sequence parameter value is 0-31 (zero-indexed), but display to user as 1-32 (one-indexed)</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>DistingCubit.updateParameterValue</name>
      <kind>method</kind>
      <signature>Future&lt;void&gt; updateParameterValue({required int slotIndex, required int paramNumber, required dynamic value})</signature>
      <path>lib/cubit/disting_cubit.dart</path>
    </interface>
    <interface>
      <name>StepSequencerParams.currentSequence</name>
      <kind>getter</kind>
      <signature>int? get currentSequence => _paramIndices['Current Sequence']</signature>
      <path>lib/services/step_sequencer_params.dart</path>
    </interface>
    <interface>
      <name>Slot.parameterValues</name>
      <kind>property</kind>
      <signature>List&lt;int&gt; parameterValues</signature>
      <path>lib/cubit/disting_state.dart</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use flutter_test for widget tests, mocktail for mocking, bloc_test for cubit testing. Tests are NOT required for all code but new features should include tests. Testing is pragmatic, not TDD. Unit tests go in test/services/, widget tests in test/ui/widgets/, integration tests verify complete workflows.</standards>
    <locations>
      <location>test/services/step_sequencer_params_test.dart (if creating unit tests for parameter discovery)</location>
      <location>test/ui/widgets/step_sequencer/sequence_selector_test.dart (widget tests)</location>
    </locations>
    <ideas>
      <idea ac="AC5.1">Widget test: SequenceSelector displays 32 dropdown options labeled "Sequence 1" through "Sequence 32"</idea>
      <idea ac="AC5.2">Unit test: StepSequencerParams discovers Current Sequence parameter number correctly</idea>
      <idea ac="AC5.3">Widget test: Loading indicator shows when isLoading=true, dropdown disabled during load</idea>
      <idea ac="AC5.4">Integration test: Selecting new sequence calls DistingCubit.updateParameterValue with correct parameters</idea>
      <idea ac="AC5.5">Integration test: If firmware supports naming, edit icon appears and dialog functions correctly</idea>
    </ideas>
  </tests>
</story-context>
