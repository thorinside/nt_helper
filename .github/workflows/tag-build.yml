name: Multi-Platform Build

on:
  push:
    tags:
      - "v*" # e.g., v1.0, v1.2.3, etc.
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to build (comma-separated: android,android_aab,windows,linux,macos,macos_testflight,ios) or "all"'
        required: false
        default: 'all'
        type: string

env:
  FLUTTER_VERSION: "3.38.9"

permissions:
  contents: write # Needed for creating/updating GitHub releases

jobs:
  setup:
    name: Setup Build Info
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag: ${{ steps.get_version.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history and tags

      - name: Get version and tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # Tag push - use the tag
            TAG="${{ github.ref_name }}"
          else
            # Manual dispatch - get latest tag
            TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using tag: $TAG, version: $VERSION"

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: setup
    # Only create release on tag push
    if: github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history and tags for release notes

      - name: Generate Release Notes
        run: |
          chmod +x ./scripts/release-notes-for-workflow.sh
          ./scripts/release-notes-for-workflow.sh ${{ needs.setup.outputs.tag }}

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.setup.outputs.tag }}
          name: "${{ needs.setup.outputs.tag }} - Automated Release"
          bodyFile: release_notes.md
          generateReleaseNotes: false

  android:
    name: Build and Sign Android APK
    runs-on: ubuntu-latest
    needs: [setup, create-release]
    if: |
      always() &&
      needs.setup.result == 'success' &&
      (needs.create-release.result == 'success' || needs.create-release.result == 'skipped') &&
      (
        github.event_name == 'push' ||
        contains(github.event.inputs.platforms, 'android') ||
        github.event.inputs.platforms == 'all' ||
        github.event.inputs.platforms == ''
      )
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set Version
        run: echo "VERSION=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Clone and Build UVCCamera Native Library
        run: |
          cd /tmp
          git clone https://github.com/DigifinityLtd/UVCCamera.git
          cd UVCCamera
          git checkout feature/16kb-page-size-compliance
          ./gradlew :lib:assembleRelease
          ./gradlew :lib:publishToMavenLocal

      - name: Install dependencies
        run: flutter pub get

      - name: Decode and Save Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release-key.jks

      - name: Build Android APK
        env:
          KEYSTORE_PATH: release-key.jks
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: flutter build apk --release

      - name: List build output (debug)
        run: ls -R build/app/outputs/flutter-apk

      - name: Rename Android APK
        run: mv ./build/app/outputs/flutter-apk/app-release.apk ./build/app/outputs/flutter-apk/nt_helper-${VERSION}.apk

      - name: Upload Android Artifact to Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.setup.outputs.tag }}
          allowUpdates: true
          omitBodyDuringUpdate: true
          artifacts: "**/nt_helper-${{ env.VERSION }}.apk"

  android_aab_play_store:
    name: Build Android AAB and Upload to Play Store
    runs-on: ubuntu-latest
    needs: [setup, create-release]
    if: |
      always() &&
      needs.setup.result == 'success' &&
      (needs.create-release.result == 'success' || needs.create-release.result == 'skipped') &&
      (
        github.event_name == 'push' ||
        contains(github.event.inputs.platforms, 'android_aab') ||
        github.event.inputs.platforms == 'all' ||
        github.event.inputs.platforms == ''
      )
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set Version
        run: echo "VERSION=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Clone and Build UVCCamera Native Library
        run: |
          cd /tmp
          git clone https://github.com/DigifinityLtd/UVCCamera.git
          cd UVCCamera
          git checkout feature/16kb-page-size-compliance
          ./gradlew :lib:assembleRelease
          ./gradlew :lib:publishToMavenLocal

      - name: Install dependencies
        run: flutter pub get

      - name: Decode and Save Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release-key.jks

      - name: Build Android App Bundle
        env:
          KEYSTORE_PATH: release-key.jks # Relative to android/app
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: flutter build appbundle --release

      - name: List build output (debug)
        run: ls -R build/app/outputs/bundle/release

      - name: Rename Android AAB
        run: mv ./build/app/outputs/bundle/release/app-release.aab ./build/app/outputs/bundle/release/nt_helper-${VERSION}.aab

      - name: Save AAB as an artifact
        uses: actions/upload-artifact@v4
        with:
          name: nt_helper-${{ env.VERSION }}.aab
          path: ./build/app/outputs/bundle/release/nt_helper-${{ env.VERSION }}.aab

      - name: Upload AAB to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: dev.nosuch.nt_helper
          releaseFiles: ./build/app/outputs/bundle/release/nt_helper-${{ env.VERSION }}.aab
          track: internal
          status: completed

  windows:
    name: Build Windows App
    runs-on: windows-latest
    needs: [setup, create-release]
    if: |
      always() &&
      needs.setup.result == 'success' &&
      (needs.create-release.result == 'success' || needs.create-release.result == 'skipped') &&
      (
        github.event_name == 'push' ||
        contains(github.event.inputs.platforms, 'windows') ||
        github.event.inputs.platforms == 'all' ||
        github.event.inputs.platforms == ''
      )
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set Version
        shell: pwsh
        run: |
          "VERSION=${{ needs.setup.outputs.version }}" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows

      - name: Zip Windows App
        shell: pwsh
        run: |
          cd build/windows/x64/runner/Release
          Compress-Archive -Path * -DestinationPath "nt_helper-${env:VERSION}-windows.zip"

      - name: List build output (debug)
        run: ls -R build/windows/x64/runner/Release

      - name: Upload Windows Artifact to Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.setup.outputs.tag }}
          allowUpdates: true
          omitBodyDuringUpdate: true
          artifacts: "**/nt_helper-${{ env.VERSION }}-windows.zip"

  linux:
    name: Build Linux App
    runs-on: ubuntu-latest
    needs: [setup, create-release]
    if: |
      always() &&
      needs.setup.result == 'success' &&
      (needs.create-release.result == 'success' || needs.create-release.result == 'skipped') &&
      (
        github.event_name == 'push' ||
        contains(github.event.inputs.platforms, 'linux') ||
        github.event.inputs.platforms == 'all' ||
        github.event.inputs.platforms == ''
      )
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set Version
        run: echo "VERSION=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
          flutter pub get

      - name: Build Linux
        run: flutter build linux

      - name: Zip Linux App
        run: |
          cd build/linux/x64/release/bundle
          zip -r nt_helper-${VERSION}-linux.zip *

      - name: List build output (debug)
        run: ls -R build/linux/x64/release/bundle

      - name: Upload Linux Artifact to Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.setup.outputs.tag }}
          allowUpdates: true
          omitBodyDuringUpdate: true
          artifacts: "**/nt_helper-${{ env.VERSION }}-linux.zip"

  macos:
    name: Build macOS App
    runs-on: macos-latest
    needs: [setup, create-release]
    if: |
      always() &&
      needs.setup.result == 'success' &&
      (needs.create-release.result == 'success' || needs.create-release.result == 'skipped') &&
      (
        github.event_name == 'push' ||
        contains(github.event.inputs.platforms, 'macos') ||
        github.event.inputs.platforms == 'all' ||
        github.event.inputs.platforms == ''
      )
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set Version
        run: echo "VERSION=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Install dependencies
        run: |
          flutter clean
          flutter pub get

      - name: Decode certificate from Base64
        run: echo "${{ secrets.APPLE_CERTIFICATES }}" | base64 --decode > apple_certificates.p12

      - name: Create & unlock keychain
        run: |
          KEYCHAIN_NAME="build.keychain"
          KEYCHAIN_PASSWORD=""

          echo "Creating keychain..."
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"

          echo "Unlocking keychain..."
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"

          echo "Setting $KEYCHAIN_NAME as default..."
          security default-keychain -s "$KEYCHAIN_NAME"

          echo "List of keychains now:"
          security list-keychains
        shell: bash

      - name: Import certificate
        run: |
          KEYCHAIN_NAME="build.keychain"

          security import apple_certificates.p12 \
            -k "$KEYCHAIN_NAME" \
            -P "${{ secrets.APPLE_CERTIFICATES_PASSWORD }}" \
            -T /usr/bin/codesign

          security set-key-partition-list -S apple-tool:,apple: -k "" "$KEYCHAIN_NAME"

          echo "Identities in keychain:"
          security find-identity -v -p codesigning "$KEYCHAIN_NAME" || true

      - name: Build macOS
        run: flutter build macos

      - name: Codesign the macOS App
        run: |
          codesign --deep --force --verbose --options runtime \
            --sign "Developer ID Application: Neal Sanche (KN424RZG26)" \
            --entitlements macos/Runner/Release.entitlements \
            build/macos/Build/Products/Release/nt_helper.app

      - name: Zip the macOS App for Notarization
        run: |
          cd build/macos/Build/Products/Release
          ditto -c -k --keepParent nt_helper.app nt_helper.zip

      - name: Notarize the macOS App
        env:
          MACOS_APPLE_ID: ${{ secrets.MACOS_APPLE_ID }}
          MACOS_APPLE_ID_PASSWORD: ${{ secrets.MACOS_APPLE_ID_PASSWORD }}
          MACOS_APPLE_TEAM_ID: ${{ secrets.MACOS_APPLE_TEAM_ID }}
        run: |
          xcrun notarytool submit build/macos/Build/Products/Release/nt_helper.zip \
            --apple-id "$MACOS_APPLE_ID" \
            --password "$MACOS_APPLE_ID_PASSWORD" \
            --team-id "$MACOS_APPLE_TEAM_ID" \
            --wait

      - name: Staple Notarization to the App
        run: |
          xcrun stapler staple build/macos/Build/Products/Release/nt_helper.app

      - name: Zip macOS App
        run: |
          cd build/macos/Build/Products/Release
          ditto -c -k --keepParent nt_helper.app nt_helper-${VERSION}-macos.zip

      - name: List build output (debug)
        run: ls -R build/macos/Build/Products/Release

      - name: Upload macOS Artifact to Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.setup.outputs.tag }}
          allowUpdates: true
          omitBodyDuringUpdate: true
          artifacts: "**/nt_helper-${{ env.VERSION }}-macos.zip"

      - name: Delete temporary keychain
        if: always()
        run: |
          security delete-keychain build.keychain

  macos_testflight:
    name: Build macOS App and Upload to TestFlight
    runs-on: macos-latest
    needs: [setup, create-release]
    if: |
      always() &&
      needs.setup.result == 'success' &&
      (needs.create-release.result == 'success' || needs.create-release.result == 'skipped') &&
      (
        github.event_name == 'push' ||
        contains(github.event.inputs.platforms, 'macos_testflight') ||
        github.event.inputs.platforms == 'all' ||
        github.event.inputs.platforms == ''
      )
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set Version
        run: echo "VERSION=${{ needs.setup.outputs.version }}" >> $GITHUB_ENV

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Install dependencies
        run: |
          flutter clean
          flutter pub get

      - name: Decode certificate from Base64
        run: echo "${{ secrets.APPLE_CERTIFICATES }}" | base64 --decode > apple_certificates.p12

      - name: Decode macOS provisioning profile from Base64
        run: echo "${{ secrets.MAC_APP_STORE_PROVISIONPROFILE }}" | base64 --decode > mac_appstore.provisionprofile

      - name: Decode nt-flash provisioning profile from Base64
        run: echo "${{ secrets.NT_FLASH_PROVISIONPROFILE }}" | base64 --decode > nt_flash.provisionprofile

      - name: Create & unlock keychain
        run: |
          KEYCHAIN_NAME="build.keychain"
          KEYCHAIN_PASSWORD=""

          echo "Creating keychain..."
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"

          echo "Unlocking keychain..."
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"

          echo "Setting $KEYCHAIN_NAME as default..."
          security default-keychain -s "$KEYCHAIN_NAME"

          echo "List of keychains now:"
          security list-keychains
        shell: bash

      - name: Import certificate
        run: |
          KEYCHAIN_NAME="build.keychain"

          security import apple_certificates.p12 \
            -k "$KEYCHAIN_NAME" \
            -P "${{ secrets.APPLE_CERTIFICATES_PASSWORD }}" \
            -T /usr/bin/codesign \
            -T /usr/bin/productsign \
            -T /usr/bin/productbuild

          security set-key-partition-list -S apple-tool:,apple: -k "" "$KEYCHAIN_NAME"

          echo "Identities in keychain:"
          security find-identity -v -p codesigning "$KEYCHAIN_NAME" || true

      - name: Install provisioning profiles
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp mac_appstore.provisionprofile ~/Library/MobileDevice/Provisioning\ Profiles/
          cp nt_flash.provisionprofile ~/Library/MobileDevice/Provisioning\ Profiles/
          echo "Provisioning profiles in that folder:"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Build macOS
        run: flutter build macos

      - name: Download and bundle nt-flash for sandboxed builds
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get latest nt-flash release using gh CLI (authenticated)
          NT_FLASH_VERSION=$(gh release view --repo thorinside/nt-flash --json tagName -q .tagName)
          echo "Bundling nt-flash $NT_FLASH_VERSION"
          
          # Download macOS release
          gh release download "$NT_FLASH_VERSION" --repo thorinside/nt-flash --pattern "*-macos.zip" --output /tmp/nt-flash.zip
          
          # Extract and place in app bundle's MacOS directory
          unzip -o /tmp/nt-flash.zip -d /tmp/nt-flash-extract
          NT_FLASH_BIN=$(find /tmp/nt-flash-extract -name "nt-flash" -type f | head -1)
          
          # Copy to app bundle
          cp "$NT_FLASH_BIN" build/macos/Build/Products/Release/nt_helper.app/Contents/MacOS/nt-flash
          chmod +x build/macos/Build/Products/Release/nt_helper.app/Contents/MacOS/nt-flash
          
          echo "nt-flash binary info:"
          file build/macos/Build/Products/Release/nt_helper.app/Contents/MacOS/nt-flash

      - name: Embed provisioning profile in app bundle
        run: |
          cp mac_appstore.provisionprofile build/macos/Build/Products/Release/nt_helper.app/Contents/embedded.provisionprofile

      - name: Prepare nt-flash as embedded helper
        run: |
          # Create a proper bundle structure for nt-flash helper
          # TestFlight requires helpers to have embedded provisioning profiles
          HELPER_DIR="build/macos/Build/Products/Release/nt_helper.app/Contents/Helpers/nt-flash.app/Contents"
          mkdir -p "$HELPER_DIR/MacOS"
          
          # Move binary into helper bundle
          mv build/macos/Build/Products/Release/nt_helper.app/Contents/MacOS/nt-flash "$HELPER_DIR/MacOS/nt-flash"
          
          # Embed provisioning profile
          cp nt_flash.provisionprofile "$HELPER_DIR/embedded.provisionprofile"
          
          # Create minimal Info.plist for the helper using plutil (avoids heredoc whitespace issues)
          /usr/libexec/PlistBuddy -c "Add :CFBundleIdentifier string dev.nosuch.ntHelper.nt-flash" "$HELPER_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :CFBundleName string nt-flash" "$HELPER_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :CFBundleExecutable string nt-flash" "$HELPER_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :CFBundleVersion string 1" "$HELPER_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :CFBundleShortVersionString string 1.0" "$HELPER_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :CFBundlePackageType string APPL" "$HELPER_DIR/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :LSMinimumSystemVersion string 10.15" "$HELPER_DIR/Info.plist"
          
          echo "Generated Info.plist:"
          cat "$HELPER_DIR/Info.plist"
          
          echo "Helper bundle structure:"
          find build/macos/Build/Products/Release/nt_helper.app/Contents/Helpers -type f

      - name: Codesign nt-flash helper bundle
        run: |
          # Sign the helper bundle FIRST with its own identifier and entitlements
          codesign --force --verbose --options runtime \
            --sign "Apple Distribution: Neal Sanche (KN424RZG26)" \
            --entitlements macos/Runner/nt-flash.entitlements \
            --identifier "dev.nosuch.ntHelper.nt-flash" \
            "build/macos/Build/Products/Release/nt_helper.app/Contents/Helpers/nt-flash.app"
          
          # Verify the signature
          echo "Verifying helper signature:"
          codesign -d -vvv "build/macos/Build/Products/Release/nt_helper.app/Contents/Helpers/nt-flash.app" 2>&1 | grep -E "Identifier|TeamIdentifier|Authority"

      - name: Codesign the macOS App for App Store
        run: |
          # Sign WITHOUT --deep to preserve the helper's signature
          # Sign frameworks and other nested code first
          find build/macos/Build/Products/Release/nt_helper.app/Contents/Frameworks -type d -name "*.framework" -exec \
            codesign --force --verbose --options runtime \
              --sign "Apple Distribution: Neal Sanche (KN424RZG26)" {} \;
          
          # Sign the main app (not deep - preserves helper signature)
          codesign --force --verbose --options runtime \
            --sign "Apple Distribution: Neal Sanche (KN424RZG26)" \
            --entitlements macos/Runner/AppStore.entitlements \
            build/macos/Build/Products/Release/nt_helper.app
          
          # Verify final signatures
          echo "Main app signature:"
          codesign -d -vvv build/macos/Build/Products/Release/nt_helper.app 2>&1 | grep -E "Identifier|TeamIdentifier"
          echo "Helper signature (should be preserved):"
          codesign -d -vvv "build/macos/Build/Products/Release/nt_helper.app/Contents/Helpers/nt-flash.app" 2>&1 | grep -E "Identifier|TeamIdentifier"

      - name: Create installer package (.pkg)
        run: |
          # Create a signed installer package for App Store submission
          productbuild \
            --component build/macos/Build/Products/Release/nt_helper.app /Applications \
            --sign "3rd Party Mac Developer Installer: Neal Sanche (KN424RZG26)" \
            build/macos/Build/Products/Release/nt_helper.pkg

      - name: List build output (debug)
        run: ls -R build/macos/Build/Products/Release

      - name: Upload to App Store Connect (TestFlight)
        run: |
          xcrun altool --upload-app \
            --type macos \
            --file "./build/macos/Build/Products/Release/nt_helper.pkg" \
            --username "${{ secrets.MACOS_APPLE_ID }}" \
            --password "${{ secrets.APP_SPECIFIC_PASSWORD }}" \
            --verbose

      - name: Delete temporary keychain
        if: always()
        run: |
          security delete-keychain build.keychain

  ios:
    name: Build & Sign iOS
    runs-on: macos-latest
    needs: [setup, create-release]
    if: |
      always() &&
      needs.setup.result == 'success' &&
      (needs.create-release.result == 'success' || needs.create-release.result == 'skipped') &&
      (
        github.event_name == 'push' ||
        contains(github.event.inputs.platforms, 'ios') ||
        github.event.inputs.platforms == 'all' ||
        github.event.inputs.platforms == ''
      )
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Print macOS & Xcode info (debug)
        run: |
          echo "macOS version:"
          sw_vers
          echo "Xcode version:"
          xcodebuild -version

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Flutter Doctor (debug)
        run: flutter doctor -v

      - name: Pub get
        run: flutter pub get

      - name: Decode iOS certificate from Base64
        run: echo "${{ secrets.APPLE_CERTIFICATES }}" | base64 --decode > apple_certificates.p12

      - name: Decode provisioning profile from Base64
        run: echo "${{ secrets.APP_STORE_MOBILEPROVISION }}" | base64 --decode > distribution.mobileprovision

      - name: Create & unlock keychain
        run: |
          KEYCHAIN_NAME="build.keychain"
          KEYCHAIN_PASSWORD=""

          echo "Creating keychain..."
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"

          echo "Unlocking keychain..."
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"

          echo "Setting $KEYCHAIN_NAME as default..."
          security default-keychain -s "$KEYCHAIN_NAME"

          echo "List of keychains now:"
          security list-keychains
        shell: bash

      - name: Import certificate
        run: |
          KEYCHAIN_NAME="build.keychain"

          security import apple_certificates.p12 \
            -k "$KEYCHAIN_NAME" \
            -P "${{ secrets.APPLE_CERTIFICATES_PASSWORD }}" \
            -T /usr/bin/codesign

          security set-key-partition-list -S apple-tool:,apple: -k "" "$KEYCHAIN_NAME"

          echo "Identities in keychain:"
          security find-identity -v -p codesigning "$KEYCHAIN_NAME" || true

      - name: Install provisioning profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp distribution.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          echo "Provisioning profiles in that folder:"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Install iOS Simulator Runtime
        run: |
          echo "Available Xcode simulators:"
          xcrun simctl list runtimes
          echo "Installing iOS simulator runtime if needed..."
          xcodebuild -downloadPlatform iOS || true
          echo "Available simulators after install attempt:"
          xcrun simctl list runtimes

      - name: Flutter build IPA
        run: |
          set -x
          flutter clean
          flutter pub get
          flutter build ipa --export-options-plist=ios/ExportOptions.plist

      - name: Debug List final artifacts
        run: ls -R build/ios/ipa || true

      - name: Upload to TestFlight
        run: |
          xcrun altool --upload-app \
            --type ios \
            --file "./build/ios/ipa/nt_helper.ipa" \
            --username "${{ secrets.MACOS_APPLE_ID }}" \
            --password "${{ secrets.APP_SPECIFIC_PASSWORD }}" \
            --verbose

      - name: Delete temporary keychain
        if: always()
        run: |
          security delete-keychain build.keychain
