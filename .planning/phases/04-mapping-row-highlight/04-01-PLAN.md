---
phase: 04-mapping-row-highlight
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/ui/widgets/mapping_edit_button.dart
  - test/ui/widgets/mapping_edit_button_highlight_test.dart
autonomous: true

must_haves:
  truths:
    - "When the mapping editor bottom sheet is open for a parameter, that parameter's mapping icon shows a thin orange border"
    - "When the bottom sheet is dismissed, the orange border disappears and the icon returns to its normal appearance"
    - "The highlight uses the theme's tertiary color (orange) to distinguish from the existing 'has mapping' state (primaryContainer)"
  artifacts:
    - path: "lib/ui/widgets/mapping_edit_button.dart"
      provides: "Mapping icon with conditional highlight border during bottom sheet editing"
      contains: "colorScheme.tertiary"
    - path: "test/ui/widgets/mapping_edit_button_highlight_test.dart"
      provides: "Widget tests verifying highlight appears/disappears with editing state"
  key_links:
    - from: "lib/ui/widgets/mapping_edit_button.dart"
      to: "showModalBottomSheet await"
      via: "Local _isEditing state set true before await, false after"
      pattern: "_isEditing"
---

<objective>
Add a visual highlight (thin orange border) around the MappingEditButton icon when its mapping editor bottom sheet is open, and remove it when dismissed.

Purpose: Users need to see at a glance which parameter's mapping is being edited when the bottom sheet is open.
Output: Updated MappingEditButton with highlight behavior + widget tests confirming the behavior.
</objective>

<execution_context>
@/Users/nealsanche/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nealsanche/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-mapping-row-highlight/04-CONTEXT.md
@lib/ui/widgets/mapping_edit_button.dart
@lib/disting_app.dart (lines 70-87 for theme tertiary color setup)
@test/ui/widgets/parameter_view_row_tooltip_removal_test.dart (test pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add highlight border to MappingEditButton during editing</name>
  <files>lib/ui/widgets/mapping_edit_button.dart</files>
  <action>
Convert MappingEditButton from StatelessWidget to StatefulWidget so it can track local `_isEditing` state.

In the `onPressed` handler, set `_isEditing = true` (via setState) BEFORE the `await showModalBottomSheet(...)` call, and set `_isEditing = false` (via setState, guarded by `mounted` check) AFTER the await returns (which happens when the bottom sheet is dismissed).

Wrap the existing `IconButton.filledTonal` in a `Container` with a `BoxDecoration` that conditionally shows a border:
- When `_isEditing` is true: `Border.all(color: Theme.of(context).colorScheme.tertiary, width: 2.0)` with `borderRadius: BorderRadius.circular(20)` (to match the circular icon button shape).
- When `_isEditing` is false: no border (transparent or no decoration).

The existing `hasMapping` styling (primaryContainer background) remains unchanged -- the orange border is an ADDITIONAL visual on top of whatever the current button style is.

Important details:
- The theme's `tertiary` color is explicitly set to orange in `disting_app.dart` (line 77: `Colors.orange.shade800` for light, line 86: `Colors.orange` for dark).
- Do NOT use secondary color -- use tertiary specifically for the orange.
- Keep the existing `Transform.scale(scale: 0.6)` wrapper intact.
- The Container border wraps around the IconButton, not around the Transform.
  </action>
  <verify>
Run `flutter analyze` -- must pass with zero warnings.
Visually inspect that the Container/decoration structure compiles correctly by reviewing the widget tree structure.
  </verify>
  <done>
MappingEditButton displays a thin orange (tertiary) border around the icon when the bottom sheet is open, and no border when it's closed. Existing mapped/unmapped styling is preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add widget tests for highlight behavior</name>
  <files>test/ui/widgets/mapping_edit_button_highlight_test.dart</files>
  <action>
Create a widget test file following the pattern in `test/ui/widgets/parameter_view_row_tooltip_removal_test.dart`.

Set up:
- MockDistingCubit (using mocktail) with stubs for `state` (returning a DistingStateSynchronized with empty slots list), `disting()`, `requireDisting()`, `scheduleParameterRefresh()`, and `updateParameterValue()`.
- MockMidiListenerCubit for the MidiListenerCubit dependency.
- A helper that wraps MappingEditButton in MaterialApp > MultiBlocProvider (DistingCubit + MidiListenerCubit) > Scaffold > body.
- The MappingEditButton requires a `ParameterViewRow` parent widget reference. Create a minimal ParameterViewRow (similar to the existing test pattern) and pass its reference. Alternatively, construct the test by embedding a full ParameterViewRow in the test widget tree (matching the existing test pattern) and finding the MappingEditButton within it.

Tests:
1. "mapping icon has no highlight border by default" -- pump the widget, find the Container wrapping the IconButton, verify it has no border or a transparent border.
2. "mapping icon shows orange border when bottom sheet is open" -- pump the widget, tap the mapping icon button, pump, then verify the Container now has a border with the tertiary color. (Note: showModalBottomSheet will try to show a bottom sheet which may need a Navigator; the MaterialApp provides one. The bottom sheet content may fail to build due to missing cubit reads inside MappingEditorBottomSheet -- if so, stub the minimum necessary or verify the border appeared before the bottom sheet fully builds by checking state after tap + pump.)
3. "mapping icon highlight clears when bottom sheet is dismissed" -- if test 2 works, dismiss the bottom sheet (e.g., tap the scrim or use Navigator.pop), pump, verify the border is gone.

If the MappingEditorBottomSheet is too complex to render in tests (many dependencies), an acceptable alternative is:
- Test that `_isEditing` state changes are reflected by checking the Container decoration directly. You can verify by finding the Container/DecoratedBox widget and inspecting its decoration.
- Or, extract the border logic into a helper and test that separately.

Use `mocktail` for mocks (already a project dependency).
Match the test file naming convention: `mapping_edit_button_highlight_test.dart`.
  </action>
  <verify>
Run `flutter test test/ui/widgets/mapping_edit_button_highlight_test.dart` -- all tests pass.
Run `flutter analyze` -- zero warnings.
  </verify>
  <done>
Widget tests confirm: (1) no border by default, (2) orange border appears when editing, (3) border clears when bottom sheet closes.
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze` passes with zero warnings
2. `flutter test test/ui/widgets/mapping_edit_button_highlight_test.dart` -- all tests pass
3. `flutter test` -- full test suite passes (no regressions)
</verification>

<success_criteria>
- MappingEditButton shows a thin orange (tertiary) border when its bottom sheet is open
- Border disappears when the bottom sheet is dismissed
- Existing mapped/unmapped icon styling is unaffected
- Zero flutter analyze warnings
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-mapping-row-highlight/04-01-SUMMARY.md`
</output>
